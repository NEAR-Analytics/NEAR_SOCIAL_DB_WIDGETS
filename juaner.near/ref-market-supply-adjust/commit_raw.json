{"tx_hash": "CNbbGBXyMF2gaKcYfeKmt5fyN6nxyqmQHoH1JuUxWBoe", "action_id_social": "7pqvaaMFGDm5fMVWa2eQReWNgEzP7p6LZe4L5Zokt6YH-0-widget", "block_id": 89528638, "block_timestamp": "2023-04-14 01:21:27.151", "signer_id": "juaner.near", "widget_name": "ref-market-supply-adjust", "source_code": "const Container = styled.div`\n   .template{\n      display:flex;\n      align-items:center;\n      justify-content:space-between;\n      margin-left:6px;\n    }\n    .template .title{\n      font-size:14px;\n      color:#7E8A93;\n    }\n    .template .value{\n      font-size:14px;\n      color:#fff;\n    }\n    .mt_25{\n      margin-top:25px;\n    }\n    .mt-10{\n      margin-top:10px;\n    }\n`;\nconst Backdrop = styled.div`\n  height: 100vh;\n  width: 100vw;\n  background-color: rgba(0, 0, 0, 0.6);\n  position: fixed;\n  left: 0;\n  top: 0;\n  z-index: 1001;\n`;\nconst Modal = styled.div`\n  background-color:#1A2E33;\n  border-radius:12px;\n  position:fixed;\n  z-index:1002;\n  width:30rem;\n  max-width: 95vw;\n  max-height: 80vh;\n  padding:10px 0 20px 0;\n  animation:anishow 0.3s forwards ease-out;\n  left:50%;\n  top:50%;\n  @keyframes anishow {\n    from {\n      opacity: 0;\n      transform:translate(-50%,-70%);\n    }\n    to {\n      opacity: 1;\n      transform:translate(-50%,-50%);\n    }\n  }\n    .modal-header{\n      display:flex;\n      align-items:center;\n      justify-content:start;\n      color:#fff;\n      font-weight: 700;\n      font-size: 18px;\n      padding:12px 20px;\n      margin-bottom:16px;\n      border-bottom:2px solid rgba(48, 67, 82, 0.5);\n    } \n    .modal-header .title{\n       font-weight: 700;\n       font-size: 18px;\n       color:#fff;\n    }\n    .modal-header .btn-close{\n      position:absolute;\n      right:28px;\n      margin:0;\n    }\n    .modal-body {\n        padding:0 16px;\n    }\n    .modal-body .tab{\n      display:flex;\n      align-items:center;\n      justify-content:space-between;\n      margin-bottom:30px;\n    }\n    .modal-body .tab span{\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      width:50%;\n      height:40px;\n      border-radius: 6px;\n      font-weight: 700;\n      font-size: 18px;\n      cursor:pointer;\n      color:#fff;\n    }\n    .modal-body .tab span.active{\n      background: #304352;\n    }\n   .btn-close-custom{\n      position:absolute;\n      right:28px;\n      width:12px;\n      height:12px;\n      cursor:pointer;\n    }\n`;\n/** base tool start  */\nlet accountId = context.accountId;\nif (!accountId) {\n  return <Widget src=\"juaner.near/widget/ref_account-signin\" />;\n}\nconst wnearbase64 =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAABmJLR0QA/wD/AP+gvaeTAAADvElEQVRYhbWYTUtjVxjH/9fRaFBaK3Q0ahCE3HTR0kWLL0g72nEh6NaAL+BivkIXHUpblWr9Ai78CIKgQqC1xYJNVnWwdiFCF9OS4CRRM2o7TRyw+XWRJk2uebuJ/uFC7jnP89xfzrnPOee5hmwIqJc0LOmxpA8keSW1SnpD0p+SLiT9JumZpF1Je4Zh3Nh5RiUQHcAKEMWeov/5td8FRBPwFZCwCWFVAvgCaKwWxAsc1ghh1RHwrl2QR8DlHYNk9BcwWinIMJC8J5CMEsDH5UDeAa7uGSSjC8DMfb6RA9Ik6WdJ79ma09r0q6R+wzBeS1JdTsdnhUACgYA8Ho8cDofGx8d1fn5u62mrq6tyuVwyTVPBYNDa/b6kT/NaSK8jBdPX4/EgKXsNDQ1xfX1d0Tz4/f48X9M0C5n9DTzMhVkpFjA3WOaam5srCxKPx+ns7LzlW0TLGZB6IGIHRhIrK0X5AZiZmSnoV0RRoF7AaKmguYFmZ2ezv+vq6tja2iros7m5iSSamppYWlqqBAZgRMA3lcJEo1Gmpqay9y0tLRwe5i/SZ2dntLe309bWxt7eHuFwuFKYrwX8UClMLBYjkUjQ19eXbevp6SEa/X//9Pl89Pb2cnx8DGAH5jsBf9iBATg5OaGrqyvbPjg4SDKZJBQKMTo6yunpadbfBsxzkd4rbMEAHBwc0NzcnO3z+XykUqlb/jZgrgTcVAMDsLGxgWEY2f7l5eVaYG6qHpmM5ufns/2GYbC+vl4tzJWA32uBSaVSTE9PZ22cTif7+/vVwDwX8H01MJFIhJGRESKRyK0Mc7vdRCIRuzDf1il9eLalo6MjDQwMqLu7Wx0dHXI6ndre3pbb7ZYkhcNhTUxMKJFI2An7TMBjOyOzu7tLa2srLpeLeDyeZ2vNsMnJSUKhUKUjM2xrb1pYWMDhcCAJv99f0N6aYdY9qoheAA8k2d+1nzx5Uuofsri4WHSDLaKl7GQB7RQ5z1iDud1uLi9Ln9WtGVYG5hXwdt7bA3xZyNI0zbx1ZGdnpyRIRslkkv7+/jwQr9dbyPTprVcZaKRAnRQIBDBNE5fLxdraWkUgGcViMcbGxmhoaMDr9RIMBq0mB4CjYG6RLtzuq16y6iXgKZnspAu4WsvZckoAH5UEyQEaAM7vCeSCcgVcASAT+OWOQQ4oNzUlgBqBz0mXE7XoFfCUYi+rTaiHwDLpldKOXgBLWNeRIjLKm+RBPZD0SNInkj5U+svVW5LelHQl6aXSX672Jf0o6SfDMP6pNP6/QZPF1Du0/sIAAAAASUVORK5CYII=\";\nconst closeButtonBase64 =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAACXBIWXMAACE4AAAhOAFFljFgAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAERSURBVHgBtdjLDYMwEEXRUSqhY+gg0xElUAIlvOAAwkEEPJ93JVaM47OJsCyyBaBbnhFrvZAreyzPvDxT2fv8stte1L2FVPnt014H6g+GhrrA/KJuMOmoG8zeWIZmPBdGNWC+lcEBbblRrZhi2Rdo4wIzyoDR88J0lBvDQIUxmag0TAYqHRNB0TAeFNgYB4qPSUapZBZEqTByolSYGVEqxl5iD6RZe2j/a9dxTp5ODAcVxOSikjA5KANGQTzkmTHVGg4KgQ9lOgoJX+00FBKPEGEUCOcZNwrEw5UZhfUWgoJxoHppHFQJ1oiay+DIxhhQ09N1jEpyN6gJD3dEKqQuUAemGtpR5XpmEHI4bl3GGvMBHUHk6KgoFgEAAAAASUVORK5CYII=\";\nlet MAX_RATIO = 10_000;\nlet B = Big();\nB.DP = 60; // set precision to 60 decimals\nconst toAPY = (v) => Math.round(v * 100) / 100;\nconst clone = (o) => JSON.parse(JSON.stringify(o));\nconst shrinkToken = (value, decimals) => {\n  return new Big(value).div(new Big(10).pow(decimals));\n};\nconst expandToken = (value, decimals) => {\n  return new Big(value).mul(new Big(10).pow(decimals));\n};\nconst formatToken = (v) => Math.floor(v * 10_000) / 10_000;\nconst { showModal, closeModal, selectedTokenId } = props;\nconst {\n  assets,\n  rewards,\n  balances,\n  account,\n  amount,\n  hasError,\n  hasHFError,\n  newHealthFactor,\n} = state;\nconst hasData = assets.length > 0 && rewards.length > 0;\nif (!showModal) {\n  State.update({\n    amount: \"\",\n    hasError: false,\n    hasHFError: false,\n  });\n}\n/** base tool end */\nconst onLoad = (data) => {\n  State.update(data);\n};\n/** logic start*/\nlet apy = 0;\nlet cf = \"-\";\nconst getApy = (asset) => {\n  if (!asset && !rewards) return 0;\n  const r = rewards.find((a) => a.token_id === asset.token_id);\n  const totalApy = r.apyBase + r.apyRewardTvl + r.apyReward;\n  return toAPY(totalApy);\n};\nif (selectedTokenId && assets) {\n  const token = selectedTokenId === \"NEAR\" ? \"wrap.near\" : selectedTokenId;\n  const asset = assets.find((a) => a.token_id === token);\n  apy = getApy(asset);\n  cf = asset.config.volatility_ratio / 100;\n}\nconst handleAmount = (value) => {\n  const amount = Number(value);\n  const [newHF, hFErrorStatus] = recomputeHealthFactor(selectedTokenId, amount);\n  State.update({\n    amount,\n    selectedTokenId,\n    hasError: false,\n    newHealthFactor: newHF,\n    hasHFError: hFErrorStatus,\n  });\n};\n\n/** logic end */\nfunction getAdjustedSum(type, account) {\n  if (!assets || !account || account[type].length == 0) return B(1);\n  return account[type]\n    .map((assetInAccount) => {\n      const asset = assets.find((a) => a.token_id === assetInAccount.token_id);\n\n      const price = asset.price\n        ? B(asset.price.multiplier).div(B(10).pow(asset.price.decimals))\n        : B(0);\n\n      const pricedBalance = B(assetInAccount.balance)\n        .div(expandToken(1, asset.config.extra_decimals))\n        .mul(price);\n\n      return type === \"borrowed\"\n        ? pricedBalance\n            .div(asset.config.volatility_ratio)\n            .mul(MAX_RATIO)\n            .toFixed()\n        : pricedBalance\n            .mul(asset.config.volatility_ratio)\n            .div(MAX_RATIO)\n            .toFixed();\n    })\n    .reduce((sum, cur) => B(sum).plus(B(cur)).toFixed());\n}\nconst adjustedCollateralSum = getAdjustedSum(\"collateral\", account);\nconst adjustedBorrowedSum = getAdjustedSum(\"borrowed\", account);\n\nfunction getHealthFactor() {\n  const healthFactor = B(adjustedCollateralSum)\n    .div(B(adjustedBorrowedSum))\n    .mul(100)\n    .toFixed(0);\n  return Number(healthFactor) < MAX_RATIO ? healthFactor : MAX_RATIO;\n}\nconst healthFactor = getHealthFactor();\n\nconst recomputeHealthFactor = (tokenId, amount) => {\n  if (!tokenId || !amount || !assets) return null;\n  const asset = assets.find((a) => a.token_id === tokenId);\n  const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n  const accountCollateralAsset = account.collateral.find(\n    (a) => a.token_id === tokenId\n  );\n  const amountDecimal = expandToken(amount || 0, decimals);\n  const newBalance = amountDecimal.toFixed();\n  const clonedAccount = clone(account);\n\n  const updatedToken = {\n    token_id: tokenId,\n    balance: newBalance,\n    shares: newBalance,\n    apr: \"0\",\n  };\n\n  if (clonedAccount?.collateral.length === 0) {\n    clonedAccount.collateral = updatedToken;\n  } else if (!accountCollateralAsset) {\n    clonedAccount.collateral.push(updatedToken);\n  } else {\n    clonedAccount.collateral = [\n      ...clonedAccount.collateral.filter((a) => a.token_id !== tokenId),\n      updatedToken,\n    ];\n  }\n  const adjustedCollateralSum = getAdjustedSum(\n    \"collateral\",\n    amount === 0 ? account : clonedAccount\n  );\n  const adjustedBorrowedSum = getAdjustedSum(\"borrowed\", account);\n\n  const newHealthFactor = B(adjustedCollateralSum)\n    .div(B(adjustedBorrowedSum))\n    .mul(100)\n    .toFixed(0);\n  let hFErrorStatus = false;\n  if (Number(newHealthFactor) >= 0 && Number(newHealthFactor) <= 105) {\n    hFErrorStatus = true;\n  }\n  const newHealthFactorAmount =\n    Number(newHealthFactor) < MAX_RATIO ? newHealthFactor : MAX_RATIO;\n  return [newHealthFactorAmount, hFErrorStatus];\n};\nfunction computeAdjustMaxAmount() {\n  if (!assets || !selectedTokenId || !account) return \"0\";\n  const asset = assets.find((a) => a.token_id === selectedTokenId);\n  const { metadata, config } = asset;\n  const decimals = metadata.decimals + config.extra_decimals;\n  const assetPrice = asset.price.usd || 0;\n  const accountSuppliedAsset = account.supplied.find(\n    (a) => a.token_id === selectedTokenId\n  );\n  const suppliedBalance = new B(accountSuppliedAsset?.balance || 0);\n  const supplied = Number(shrinkToken(suppliedBalance.toFixed(), decimals));\n\n  const accountCollateralAsset = account.collateral.find(\n    (a) => a.token_id === selectedTokenId\n  );\n  const collateralBalance = new B(accountCollateralAsset?.balance || 0);\n  const collateral = Number(shrinkToken(collateralBalance.toFixed(), decimals));\n  const availableBalance = B(supplied).plus(collateral).toFixed();\n  const availableBalance$ = B(assetPrice).mul(availableBalance).toFixed(2);\n  return [availableBalance, availableBalance$, collateral];\n}\nconst [availableBalance, availableBalance$, remainBalance] =\n  computeAdjustMaxAmount();\nreturn (\n  <Container>\n    {/* load data */}\n    {!hasData && (\n      <Widget src=\"juaner.near/widget/ref_burrow-data\" props={{ onLoad }} />\n    )}\n    {/** modal */}\n    <Modal style={{ display: showModal ? \"block\" : \"none\" }}>\n      <div class=\"modal-header\">\n        <div class=\"title\">Adjust Collateral</div>\n        <img\n          class=\"btn-close-custom\"\n          src={closeButtonBase64}\n          onClick={closeModal}\n        />\n      </div>\n      <div class=\"modal-body\">\n        <div class=\"content\">\n          <Widget\n            src=\"juaner.near/widget/ref-input-box\"\n            props={{\n              handleAmount,\n              balance: availableBalance,\n              balance$: availableBalance$,\n            }}\n          />\n          {hasError && (\n            <p class=\"alert alert-danger mt-10\" role=\"alert\">\n              Amount greater than available\n            </p>\n          )}\n          {hasHFError && (\n            <p class=\"alert alert-danger mt-10\" role=\"alert\">\n              Your health factor will be dangerously low and you're at risk of\n              liquidation\n            </p>\n          )}\n          <div class=\"template mt_25\">\n            <span class=\"title\">Health Factor</span>\n            <span class=\"value\">\n              {newHealthFactor ? newHealthFactor : healthFactor}%\n            </span>\n          </div>\n          <div class=\"template mt_25\">\n            <span class=\"title\">Amount designated as collateral</span>\n            <span class=\"value\">{amount || remainBalance || \"-\"}</span>\n          </div>\n          <Widget\n            src=\"juaner.near/widget/ref-adjust-button\"\n            props={{\n              onLoad,\n              selectedTokenId,\n              amount,\n              hasError,\n              hasHFError,\n              account,\n              onLoad,\n              assets,\n              availableBalance,\n            }}\n          />\n        </div>\n      </div>\n    </Modal>\n    <Backdrop\n      style={{ display: showModal ? \"block\" : \"none\" }}\n      onClick={closeModal}\n    ></Backdrop>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/juaner.near/widget/ref-market-supply-adjust"}