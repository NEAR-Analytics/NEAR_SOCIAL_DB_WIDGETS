{"tx_hash": "NK95QrvQayKXRisoAuiRbqssS9x4rb5gGmidSGL6x3M", "action_id_social": "6DjHnMDmhGgZ9nWkkTvvmUvu7UcZg74snnFscTbDa2Dp-0-widget", "block_id": 88691486, "block_timestamp": "2023-04-03 02:10:35.957", "signer_id": "juaner.near", "widget_name": "ref-market-supply-supply", "source_code": "const Container = styled.div`\n    .content input{\n      background: #152528;\n      border-radius: 12px;\n      height: 55px;\n      font-size:20px;\n      color: #7E8A93;\n      padding:0 15px 0 15px;\n      border:none;\n      outline:none;\n      margin-bottom:8px;\n    }\n    .content input:focus{\n      outline:none;\n    }\n    input::-webkit-outer-spin-button,\n    input::-webkit-inner-spin-button {\n      -webkit-appearance: none;\n    }\n    .content .balance {\n      font-size:12px;\n      color:#4B6778;\n      margin-left:6px;\n    }\n    .template{\n      display:flex;\n      align-items:center;\n      justify-content:space-between;\n      margin-left:6px;\n    }\n    .template .title{\n      font-size:14px;\n      color:#7E8A93;\n    }\n    .template .value{\n      font-size:14px;\n      color:#fff;\n    }\n    .mt_25{\n      margin-top:25px;\n    }\n    .mt-10{\n      margin-top:10px;\n    }\n    .greenButton{\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      background: #00FFD1;\n      border-radius: 12px;\n      height:46px;\n      font-weight: 700;\n      font-size: 18px;\n      color:#000;\n      cursor:pointer;\n      width:100%;\n    }\n    .disabled{\n      opacity:0.3;\n      cursor: not-allowed;\n    }\n`;\n/** base tool start  */\nlet BURROW_CONTRACT = \"contract.main.burrow.near\";\nlet accountId = context.accountId;\nconst toAPY = (v) => Math.round(v * 100) / 100;\nconst clone = (o) => JSON.parse(JSON.stringify(o));\nconst shrinkToken = (value, decimals) => {\n  return new Big(value).div(new Big(10).pow(decimals));\n};\nconst expandToken = (value, decimals) => {\n  return new Big(value).mul(new Big(10).pow(decimals));\n};\nconst formatToken = (v) => Math.floor(v * 10_000) / 10_000;\nconst selectedTokenId = props.selectedTokenId;\nconst { rewards, balances, amount, hasError, assets } = state;\nconst hasData = assets.length > 0 && rewards.length > 0;\n/** base tool end */\nif (!accountId) {\n  return <Widget src=\"juaner.near/widget/ref_account-signin\" />;\n}\nconst onLoad = (data) => {\n  State.update(data);\n};\nconst account = fetch(\"https://rpc.mainnet.near.org\", {\n  method: \"POST\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n  body: JSON.stringify({\n    jsonrpc: \"2.0\",\n    id: \"dontcare\",\n    method: \"query\",\n    params: {\n      request_type: \"view_account\",\n      finality: \"final\",\n      account_id: accountId,\n    },\n  }),\n});\nif (!account) {\n  return null;\n}\n/** logic start */\nconst nearBalance = shrinkToken(account.body.result.amount, 24).toFixed(2);\nlet vailableBalance = 0;\nlet apy = 0;\nconst getBalance = (asset) => {\n  if (!asset) return 0;\n  const { token_id, accountBalance, metadata } = asset;\n  return formatToken(\n    shrinkToken(accountBalance, metadata.decimals).toFixed()\n  ).toString();\n};\nconst getApy = (asset) => {\n  if (!asset && !rewards) return 0;\n  const r = rewards.find((a) => a.token_id === asset.token_id);\n  const totalApy = r.apyBase + r.apyRewardTvl + r.apyReward;\n  return toAPY(totalApy);\n};\nif (selectedTokenId && assets) {\n  const token = selectedTokenId === \"NEAR\" ? \"wrap.near\" : selectedTokenId;\n  const asset = assets.find((a) => a.token_id === token);\n  vailableBalance =\n    selectedTokenId === \"NEAR\" ? nearBalance : getBalance(asset);\n  apy = getApy(asset);\n}\nconst storageBurrow = Near.view(BURROW_CONTRACT, \"storage_balance_of\", {\n  account_id: accountId,\n});\n\nconst storageToken = selectedTokenId\n  ? Near.view(selectedTokenId, \"storage_balance_of\", {\n      account_id: accountId,\n    })\n  : null;\n\nconst handleSelect = (e) => {\n  State.update({\n    selectedTokenId: e.target.value,\n    amount: \"\",\n    hasError: false,\n  });\n};\n\nconst handleAmount = (e) => {\n  State.update({\n    amount: Number(e.target.value),\n    selectedTokenId,\n    hasError: false,\n  });\n};\n\nconst handleDeposit = () => {\n  if (!selectedTokenId || !amount || hasError) return;\n\n  if (selectedTokenId === \"NEAR\") {\n    handleDepositNear(amount);\n    return;\n  }\n\n  const asset = assets.find((a) => a.token_id === selectedTokenId);\n  const { token_id, accountBalance, metadata, config } = asset;\n\n  const balance = formatToken(\n    shrinkToken(accountBalance, metadata.decimals).toFixed()\n  );\n\n  if (amount > balance) {\n    State.update({ selectedTokenId, amount, hasError: true });\n    return;\n  }\n\n  const expandedAmount = expandToken(amount, metadata.decimals).toFixed();\n  const collateralAmount = expandToken(\n    amount,\n    metadata.decimals + config.extra_decimals\n  ).toFixed();\n\n  const collateralMsg = config.can_use_as_collateral\n    ? `{\"Execute\":{\"actions\":[{\"IncreaseCollateral\":{\"token_id\": \"${token_id}\",\"max_amount\":\"${collateralAmount}\"}}]}}`\n    : \"\";\n\n  const transactions = [];\n\n  const depositTransaction = {\n    contractName: token_id,\n    methodName: \"ft_transfer_call\",\n    deposit: new Big(\"1\").toFixed(),\n    gas: expandToken(300, 12),\n    args: {\n      receiver_id: BURROW_CONTRACT,\n      amount: expandedAmount,\n      msg: collateralMsg,\n    },\n  };\n\n  if (storageToken?.available === \"0\" || !storageToken?.available) {\n    transactions.push({\n      contractName: token_id,\n      methodName: \"storage_deposit\",\n      deposit: expandToken(0.25, 24).toFixed(),\n    });\n  }\n\n  if (storageBurrow?.available === \"0\" || !storageBurrow?.available) {\n    transactions.push({\n      contractName: BURROW_CONTRACT,\n      methodName: \"storage_deposit\",\n      deposit: expandToken(0.25, 24).toFixed(),\n      gas: expandToken(140, 12),\n    });\n  }\n\n  transactions.push(depositTransaction);\n\n  Near.call(transactions);\n};\n\nconst handleDepositNear = (amount) => {\n  const amountDecimal = expandToken(amount, 24).toFixed();\n\n  Near.call([\n    {\n      contractName: \"wrap.near\",\n      methodName: \"near_deposit\",\n      deposit: amountDecimal,\n      gas: expandToken(300, 12),\n    },\n    {\n      contractName: \"wrap.near\",\n      methodName: \"ft_transfer_call\",\n      deposit: new Big(\"1\").toFixed(),\n      gas: expandToken(300, 12),\n      args: {\n        receiver_id: BURROW_CONTRACT,\n        amount: amountDecimal,\n        msg: `{\"Execute\":{\"actions\":[{\"IncreaseCollateral\":{\"token_id\":\"wrap.near\",\"max_amount\":\"${amountDecimal}\"}}]}}`,\n      },\n    },\n  ]);\n};\n/** logic end */\nreturn (\n  <Container>\n    {/* load data */}\n    {!hasData && (\n      <Widget src=\"juaner.near/widget/ref_burrow-data\" props={{ onLoad }} />\n    )}\n    <div class=\"content\">\n      <input type=\"number\" value={amount} onChange={handleAmount} />\n      {selectedTokenId && (\n        <span class=\"balance\">Balance: {vailableBalance}</span>\n      )}\n      {hasError && (\n        <p class=\"alert alert-danger mt-10\" role=\"alert\">\n          Amount greater than available\n        </p>\n      )}\n      <div class=\"template mt_25\">\n        <span class=\"title\">Supply APY</span>\n        <span class=\"value\">{apy}%</span>\n      </div>\n      <div\n        class={`greenButton mt_25 ${Number(amount) ? \"\" : \"disabled\"}`}\n        onClick={handleDeposit}\n      >\n        Supply\n      </div>\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/juaner.near/widget/ref-market-supply-supply"}