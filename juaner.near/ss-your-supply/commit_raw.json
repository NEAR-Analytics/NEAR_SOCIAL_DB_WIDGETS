{"tx_hash": "34aJL2x5BoPFrUrj8Sk4YrTr9h2nAQksAN5dFurHbMJM", "action_id_social": "8VijrgzmGSUeCxtZpBJ4SLVJgHFLDt4GHART3grLnef7-0-widget", "block_id": 89794930, "block_timestamp": "2023-04-17 14:02:19.361", "signer_id": "juaner.near", "widget_name": "ss-your-supply", "source_code": "const Container = styled.div`\n  .tokenIcon{\n      width: 26px;\n      height: 26px;\n      border-radius:100px;\n      margin-right:4px;\n    }\n.rewardIcon{\n      width: 16px;\n      height: 16px;\n      border-radius:100px;\n  }\n  .flex-end{\n      display:flex;\n      align-items:center;\n      justify-content:end;\n      height:50px;\n    }\n`;\n/** base tool start  */\nlet accountId = context.accountId;\nif (!accountId) {\n  return <Widget src=\"juaner.near/widget/ref_account-signin\" />;\n}\nconst toAPY = (v) => Math.round(v * 100) / 100;\nconst shrinkToken = (value, decimals, fixed) => {\n  return new Big(value).div(new Big(10).pow(decimals)).toFixed(fixed);\n};\nconst {\n  assets,\n  rewards,\n  account,\n  balances,\n  showModalName,\n  selectedTokenId,\n  selectedTokenMeta,\n  wnearbase64,\n  closeButtonBase64,\n} = state;\nconst { onLoadState } = props;\nfunction changeSelectedToken(asset, type) {\n  const { token_id, metadata } = asset;\n  State.update({\n    selectedTokenId: token_id,\n    selectedTokenMeta: metadata,\n    showModalName: type,\n  });\n}\nfunction closeModal() {\n  State.update({\n    showModalName: \"\",\n  });\n}\nconst onLoad = (data) => {\n  State.update(data);\n};\n\nconst hasData = assets.length > 0 && rewards.length > 0 && account;\nfunction getPortfolioRewards(type, token_id) {\n  const targetFarm = account.farms.find((farm) => {\n    return farm[\"farm_id\"][type] == token_id;\n  });\n  if (targetFarm) {\n    const asset = assets.find((a) => a.token_id == token_id);\n    const rewards = targetFarm[\"rewards\"] || [];\n    const totalRewards =\n      type == \"Supplied\" ? asset.farms[0].rewards : asset.farms[1].rewards;\n    const result = rewards.map((reward) => {\n      const { reward_token_id } = reward;\n      const assetDecimals =\n        asset.metadata.decimals + asset.config.extra_decimals;\n      const rewardAsset = assets.find((a) => a.token_id == reward_token_id);\n      const rewardTokenDecimals =\n        rewardAsset.metadata.decimals + rewardAsset.config.extra_decimals;\n\n      const boostedShares = Number(\n        shrinkToken(reward.boosted_shares, assetDecimals)\n      );\n      const totalBoostedShares = Number(\n        shrinkToken(totalRewards[reward_token_id].boosted_shares, assetDecimals)\n      );\n      const totalRewardsPerDay = Number(\n        shrinkToken(\n          totalRewards[reward_token_id].reward_per_day,\n          rewardTokenDecimals\n        )\n      );\n      const rewardPerDay =\n        (boostedShares / totalBoostedShares) * totalRewardsPerDay || 0;\n      return { rewardPerDay, metadata: asset.metadata };\n    });\n    return result;\n  }\n  return [];\n}\nconst depositedAssets = hasData\n  ? new Set([\n      ...account.supplied.map((a) => a.token_id),\n      ...account.collateral.map((a) => a.token_id),\n    ])\n  : new Set();\n// get portfolio deposited assets\nlet total_supplied_usd = Big(0);\nconst suppliedAssets = hasData\n  ? [...depositedAssets].map((depositedTokenId) => {\n      const asset = assets.find((a) => a.token_id === depositedTokenId);\n      const netTvlMultiplier = asset.config.net_tvl_multiplier / 10000;\n      const r = rewards.find((a) => a.token_id === asset.token_id);\n      const totalApy =\n        r.apyBase + r.apyRewardTvl * netTvlMultiplier + r.apyReward;\n\n      const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n      const { can_use_as_collateral } = asset.config;\n\n      const supplied = account.supplied.find(\n        (s) => s.token_id === depositedTokenId\n      );\n\n      const depositedBalance = supplied\n        ? Number(shrinkToken(supplied.balance, decimals))\n        : 0;\n\n      const collateral = account.collateral.find(\n        (c) => c.token_id === depositedTokenId\n      );\n\n      const collateralBalance = collateral\n        ? Number(shrinkToken(collateral.balance, decimals))\n        : 0;\n\n      const totalBalance = depositedBalance + collateralBalance;\n      const usd = totalBalance * asset.price.usd;\n      const collateralUsd = collateralBalance * asset.price.usd;\n      total_supplied_usd = total_supplied_usd.plus(usd);\n      const rewardsList =\n        getPortfolioRewards(\"Supplied\", depositedTokenId) || [];\n      return (\n        <tr>\n          <td>\n            <img\n              src={asset.metadata.icon || wnearbase64}\n              class=\"tokenIcon\"\n            ></img>\n            {asset.metadata.symbol}\n          </td>\n          <td class=\"text-start\">{toAPY(totalApy)}%</td>\n          <td class=\"text-start\">\n            {rewardsList.length == 0\n              ? \"-\"\n              : rewardsList.map((reward) => {\n                  const { rewardPerDay, metadata } = reward;\n                  return (\n                    <div class=\"flex_center\">\n                      {Big(rewardPerDay).toFixed(4)}\n                      <img\n                        class=\"rewardIcon ml_5\"\n                        src={metadata.icon || wnearbase64}\n                      />\n                    </div>\n                  );\n                })}\n          </td>\n          <td class=\"text-start\">\n            {collateralBalance.toFixed(4)}\n            <span class=\"text_grey_color\">(${collateralUsd.toFixed(2)})</span>\n          </td>\n          <td class=\"text-start\">\n            {totalBalance.toFixed(4)}\n            <span class=\"text_grey_color\">(${usd.toFixed(2)})</span>\n          </td>\n          <td class=\"flex-end\">\n            {!can_use_as_collateral ? null : (\n              <Widget\n                src=\"juaner.near/widget/ref-operation-button\"\n                props={{\n                  clickEvent: () => {\n                    changeSelectedToken(asset, \"adjust\");\n                  },\n                  buttonType: \"solid\",\n                  actionName: \"Adjust\",\n                  hoverOn: true,\n                }}\n              />\n            )}\n            &nbsp;&nbsp;\n            <Widget\n              src=\"juaner.near/widget/ref-operation-button\"\n              props={{\n                clickEvent: () => {\n                  changeSelectedToken(asset, \"withdraw\");\n                },\n                buttonType: \"line\",\n                actionName: \"Withdraw\",\n                hoverOn: true,\n              }}\n            />\n          </td>\n        </tr>\n      );\n    })\n  : undefined;\n\nif (suppliedAssets && suppliedAssets.length > 0) {\n  onLoadState &&\n    onLoadState({\n      total_supplied_usd: total_supplied_usd.toFixed(),\n    });\n}\nfunction getWnearIcon(icon) {\n  State.update({\n    wnearbase64: icon,\n  });\n}\nfunction getCloseButtonIcon(icon) {\n  State.update({\n    closeButtonBase64: icon,\n  });\n}\nreturn (\n  <Container>\n    {/* load data */}\n    {!hasData && (\n      <Widget src=\"juaner.near/widget/ref_burrow-data\" props={{ onLoad }} />\n    )}\n    {/* load icons */}\n    <Widget\n      src=\"juaner.near/widget/ref-icons\"\n      props={{ getWnearIcon, getCloseButtonIcon }}\n    />\n    <div class=\"title\">You Supplied</div>\n    <table class=\"table click\">\n      <thead>\n        <tr>\n          <th scope=\"col\" width=\"15%\">\n            Assets\n          </th>\n          <th scope=\"col\" class=\"text-start\" width=\"15%\">\n            Supply APY\n          </th>\n          <th scope=\"col\" class=\"text-start\" width=\"15%\">\n            Rewards\n          </th>\n          <th scope=\"col\" class=\"text-start\" width=\"15%\">\n            Collateral\n          </th>\n          <th scope=\"col\" class=\"text-start\" width=\"15%\">\n            You Supplied\n          </th>\n          <th scope=\"col\"></th>\n        </tr>\n      </thead>\n      <tbody>{suppliedAssets}</tbody>\n    </table>\n    {/** modal */}\n    <Widget\n      src=\"juaner.near/widget/ref-market-supply-adjust\"\n      props={{\n        showModal: showModalName == \"adjust\",\n        closeModal,\n        selectedTokenId,\n        selectedTokenMeta,\n      }}\n    />\n    <Widget\n      src=\"juaner.near/widget/ref-market-supply-withdraw\"\n      props={{\n        showModal: showModalName == \"withdraw\",\n        closeModal,\n        selectedTokenId,\n        selectedTokenMeta,\n      }}\n    />\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/juaner.near/widget/ss-your-supply"}