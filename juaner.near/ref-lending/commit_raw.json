{"tx_hash": "3VfRgyv6TvtrsoNyvQSshfUYzYUWhE6UJLVHW8gwhaLN", "action_id_social": "GcoE7JSzqjEJ1MDhkpgxEj5DQ5SaHckFHyuNt8hYJrzb-1-widget", "block_id": 88655370, "block_timestamp": "2023-04-02 13:40:37.368", "signer_id": "juaner.near", "widget_name": "ref-lending", "source_code": "const Container = styled.div`\n    padding-top:27px;\n    .box_tabel{\n      border-radius: 12px;\n      background: #1A2E33;\n      padding:20px;\n    }\n    .title {\n        font-weight: 700;\n        font-size: 18px;\n        color:#fff;\n    }\n    .title_top {\n      font-weight: 700;\n      font-size: 20px;\n      color:#fff;\n    }\n    .table{\n        margin:0;\n        border-bottom:2px solid rgba(48, 67, 82, 0.5);\n    }\n    .table thead tr{\n        height:50px;\n        border:hidden;\n    }\n    .table tbody tr{\n        height:50px;\n    }\n    .table th{\n        color: #7E8A93;\n        font-size:14px;\n        vertical-align: middle;\n    }\n    .table td{\n        color: #fff;\n        font-size:14px;\n        vertical-align: middle;\n        border: none;\n    }\n    .mt_16{\n      margin-top:16px;\n    }\n    .tokenIcon{\n      width: 26px;\n      height: 26px;\n      border-radius:100px;\n      margin-right:4px;\n    }\n    .rewardIcon{\n      width: 16px;\n      height: 16px;\n      border-radius:100px;\n    }\n    .text_grey_color{\n      color:#7E8A93;\n    }\n    .text_green_color{\n      color:#78FF9E;\n    }\n    .text_red_color{\n      color:#FF6BA9;\n    }\n    .ml_4_ne{\n        margin-left:-4px;\n    }\n    .mr_10{\n      margin-right:10px;\n    }\n    .topArea{\n        padding:0 25px 38px 25px;\n    }\n    .flexContainer{\n        display:flex;\n        align-items:center;\n        margin-top:12px;\n    }\n    .block{\n        display:flex;\n        flex-direction:column;\n        border-right:2px solid rgba(48, 67, 82, 0.5);\n        padding-right:30px;\n        margin-right:30px;\n    }\n    .block .t{\n        font-size:14px;\n        color:#7E8A93;\n    }\n    .block .v{\n        font-weight: 700;\n        font-size: 26px;\n        color:#fff;\n    }\n    .noBorder {\n        border:none!important;\n    }\n    .mt_26{\n        margin-top:26px;\n    }\n    .flex_center{\n      display:flex;\n      align-items:center;\n    }\n\n    .claim_button{\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      height:26px;\n      background: #304352;\n      border-radius: 6px;\n      margin-left:16px;\n      font-size:12px;\n      color:#fff;\n      cursor:pointer;\n      padding:0 12px 0 12px;\n    }\n`;\nconst wnearbase64 =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAABmJLR0QA/wD/AP+gvaeTAAADvElEQVRYhbWYTUtjVxjH/9fRaFBaK3Q0ahCE3HTR0kWLL0g72nEh6NaAL+BivkIXHUpblWr9Ai78CIKgQqC1xYJNVnWwdiFCF9OS4CRRM2o7TRyw+XWRJk2uebuJ/uFC7jnP89xfzrnPOee5hmwIqJc0LOmxpA8keSW1SnpD0p+SLiT9JumZpF1Je4Zh3Nh5RiUQHcAKEMWeov/5td8FRBPwFZCwCWFVAvgCaKwWxAsc1ghh1RHwrl2QR8DlHYNk9BcwWinIMJC8J5CMEsDH5UDeAa7uGSSjC8DMfb6RA9Ik6WdJ79ma09r0q6R+wzBeS1JdTsdnhUACgYA8Ho8cDofGx8d1fn5u62mrq6tyuVwyTVPBYNDa/b6kT/NaSK8jBdPX4/EgKXsNDQ1xfX1d0Tz4/f48X9M0C5n9DTzMhVkpFjA3WOaam5srCxKPx+ns7LzlW0TLGZB6IGIHRhIrK0X5AZiZmSnoV0RRoF7AaKmguYFmZ2ezv+vq6tja2iros7m5iSSamppYWlqqBAZgRMA3lcJEo1Gmpqay9y0tLRwe5i/SZ2dntLe309bWxt7eHuFwuFKYrwX8UClMLBYjkUjQ19eXbevp6SEa/X//9Pl89Pb2cnx8DGAH5jsBf9iBATg5OaGrqyvbPjg4SDKZJBQKMTo6yunpadbfBsxzkd4rbMEAHBwc0NzcnO3z+XykUqlb/jZgrgTcVAMDsLGxgWEY2f7l5eVaYG6qHpmM5ufns/2GYbC+vl4tzJWA32uBSaVSTE9PZ22cTif7+/vVwDwX8H01MJFIhJGRESKRyK0Mc7vdRCIRuzDf1il9eLalo6MjDQwMqLu7Wx0dHXI6ndre3pbb7ZYkhcNhTUxMKJFI2An7TMBjOyOzu7tLa2srLpeLeDyeZ2vNsMnJSUKhUKUjM2xrb1pYWMDhcCAJv99f0N6aYdY9qoheAA8k2d+1nzx5Uuofsri4WHSDLaKl7GQB7RQ5z1iDud1uLi9Ln9WtGVYG5hXwdt7bA3xZyNI0zbx1ZGdnpyRIRslkkv7+/jwQr9dbyPTprVcZaKRAnRQIBDBNE5fLxdraWkUgGcViMcbGxmhoaMDr9RIMBq0mB4CjYG6RLtzuq16y6iXgKZnspAu4WsvZckoAH5UEyQEaAM7vCeSCcgVcASAT+OWOQQ4oNzUlgBqBz0mXE7XoFfCUYi+rTaiHwDLpldKOXgBLWNeRIjLKm+RBPZD0SNInkj5U+svVW5LelHQl6aXSX672Jf0o6SfDMP6pNP6/QZPF1Du0/sIAAAAASUVORK5CYII=\";\nlet accountId = context.accountId;\nif (!accountId) {\n  return <Widget src=\"juaner.near/widget/ref_account-signin\" />;\n}\nconst toAPY = (v) => Math.round(v * 100) / 100;\nconst shrinkToken = (value, decimals, fixed) => {\n  return new Big(value).div(new Big(10).pow(decimals)).toFixed(fixed);\n};\n// get all assets data from burrow contracts\nconst { assets, rewards, account, balances, yourSuppliedUSD, yourBurrowedUSD } =\n  state;\nconst hasData = assets.length > 0 && rewards.length > 0 && account;\nconst rewardsMap = rewards\n  ? rewards.reduce((acc, cur) => {\n      return {\n        ...acc,\n        [cur.token_id]: cur,\n      };\n    }, {})\n  : {};\nconst assetsMap = assets\n  ? assets.reduce((acc, cur) => {\n      return {\n        ...acc,\n        [cur.token_id]: cur,\n      };\n    }, {})\n  : {};\nconst onLoad = (data) => {\n  State.update(data);\n};\n// get unclaimed rewards\nconst unclaimedRewardsMap = account\n  ? account.farms?.reduce((prev, curr) => {\n      for (const reward of curr.rewards) {\n        const t = prev[reward.reward_token_id];\n        if (t) {\n          prev[reward.reward_token_id] = Big(t)\n            .plus(Big(reward.unclaimed_amount))\n            .toFixed();\n        } else {\n          prev[reward.reward_token_id] = Big(reward.unclaimed_amount).toFixed();\n        }\n      }\n      return prev;\n    }, {})\n  : {};\n\nconst unclaimedRewards = Object.keys(unclaimedRewardsMap).map((id) => {\n  const asset = assets.find((a) => a.token_id === id);\n  const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n  return {\n    id,\n    unclaimed: shrinkToken(unclaimedRewardsMap[id], decimals, 4),\n    symbol: asset.metadata.symbol,\n    icon: asset.metadata.icon,\n  };\n});\n\nconst handleClaimAll = () => {\n  Near.call({\n    contractName: \"contract.main.burrow.near\",\n    methodName: \"account_farm_claim_all\",\n  });\n};\nconst depositedAssets = hasData\n  ? new Set([\n      ...account.supplied.map((a) => a.token_id),\n      ...account.collateral.map((a) => a.token_id),\n    ])\n  : new Set();\n// get portfolio deposited assets\nlet total_supplied_usd = Big(0);\nconst suppliedAssets = hasData\n  ? [...depositedAssets].map((depositedTokenId) => {\n      const asset = assets.find((a) => a.token_id === depositedTokenId);\n\n      const r = rewards.find((a) => a.token_id === asset.token_id);\n      const totalApy = r.apyBase + r.apyRewardTvl + r.apyReward;\n\n      const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n\n      const supplied = account.supplied.find(\n        (s) => s.token_id === depositedTokenId\n      );\n\n      const depositedBalance = supplied\n        ? Number(shrinkToken(supplied.balance, decimals))\n        : 0;\n\n      const collateral = account.collateral.find(\n        (c) => c.token_id === depositedTokenId\n      );\n\n      const collateralBalance = collateral\n        ? Number(shrinkToken(collateral.balance, decimals))\n        : 0;\n\n      const totalBalance = depositedBalance + collateralBalance;\n      const usd = totalBalance * asset.price.usd;\n      total_supplied_usd = total_supplied_usd.plus(usd);\n\n      return (\n        <tr>\n          <td>\n            <img\n              src={asset.metadata.icon || wnearbase64}\n              class=\"tokenIcon\"\n            ></img>\n            {asset.metadata.symbol}\n          </td>\n          <td class=\"text-start\">{toAPY(totalApy)}%</td>\n          <td class=\"text-start\">\n            {totalBalance.toFixed(4)}\n            <span class=\"text_grey_color\">(${usd.toFixed(2)})</span>\n          </td>\n        </tr>\n      );\n    })\n  : undefined;\n\n// get portfolio borrowed assets\nlet total_burrowed_usd = Big(0);\nconst borrowedAssets = hasData\n  ? account.borrowed.map((borrowedAsset) => {\n      const asset = assets.find((a) => a.token_id === borrowedAsset.token_id);\n      const r = rewards.find((a) => a.token_id === asset.token_id);\n      const totalApy = r.apyBaseBorrow;\n\n      const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n      const borrowed = Number(shrinkToken(borrowedAsset.balance, decimals));\n      const usd = borrowed * asset.price.usd;\n      total_burrowed_usd = total_burrowed_usd.plus(usd);\n\n      return (\n        <tr>\n          <td>\n            <img\n              src={asset.metadata.icon || wnearbase64}\n              class=\"tokenIcon\"\n            ></img>\n            {asset.metadata.symbol}\n          </td>\n          <td class=\"text-start\">{toAPY(totalApy)}%</td>\n          <td class=\"text-start\">\n            {borrowed.toFixed(4)}\n            <span class=\"text_grey_color\">(${usd.toFixed(2)})</span>\n          </td>\n        </tr>\n      );\n    })\n  : undefined;\n\nif (total_supplied_usd.gt(0)) {\n  State.update({\n    yourSuppliedUSD: total_supplied_usd.lt(0.01)\n      ? \"<$0.01\"\n      : \"$\" + total_supplied_usd.toFixed(2),\n  });\n}\nif (total_burrowed_usd.gt(0)) {\n  State.update({\n    yourBurrowedUSD: total_burrowed_usd.lt(0.01)\n      ? \"<$0.01\"\n      : \"$\" + total_burrowed_usd.toFixed(2),\n  });\n}\nreturn (\n  <Container>\n    {/* load data */}\n    {!hasData && (\n      <Widget src=\"juaner.near/widget/ref_burrow-data\" props={{ onLoad }} />\n    )}\n    {/* Your Lending */}\n    <div class=\"topArea\">\n      <div class=\"title_top\">Your Lending</div>\n      <div class=\"flexContainer\">\n        <div class=\"block\">\n          <label class=\"t\">Supplied</label>\n          <span class=\"v\">{yourSuppliedUSD || \"$0\"}</span>\n        </div>\n        <div class=\"block noBorder\">\n          <label class=\"t\">Borrowed</label>\n          <span class=\"v\">{yourBurrowedUSD || \"$0\"}</span>\n        </div>\n      </div>\n      <div class=\"block mt_26 noBorder\">\n        <label class=\"t\">Unclaimed Rewards</label>\n        <div>\n          <div class=\"flex_center\">\n            {unclaimedRewards.length > 0 ? (\n              <>\n                {unclaimedRewards.map((reward) => (\n                  <div class=\"flex_center\">\n                    <span class=\"v mr_10\">{reward.unclaimed}</span>\n                    <img src={reward.icon} class=\"rewardIcon\"></img>\n                  </div>\n                ))}\n                <div class=\"claim_button\" onClick={handleClaimAll}>\n                  Claim\n                </div>\n              </>\n            ) : (\n              <span class=\"v mr_10\">0</span>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n\n    {/* supply area */}\n    <div class=\"box_tabel\">\n      {/*yours */}\n      <div class=\"title\">You Supplied</div>\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th scope=\"col\" width=\"25%\">\n              Assets\n            </th>\n            <th scope=\"col\" class=\"text-start\" width=\"25%\">\n              Supply APY\n            </th>\n            <th scope=\"col\" class=\"text-start\">\n              Balance\n            </th>\n          </tr>\n        </thead>\n        <tbody>{suppliedAssets}</tbody>\n      </table>\n      {/*market */}\n      <Widget src=\"juaner.near/widget/ref-market-supply-assets\" />\n    </div>\n    {/* burrow area */}\n    <div class=\"box_tabel mt_16\">\n      {/* yours */}\n      <div class=\"title\">You Borrowed</div>\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th scope=\"col\" width=\"25%\">\n              Assets\n            </th>\n            <th scope=\"col\" class=\"text-start\" width=\"25%\">\n              Borrow APY\n            </th>\n            <th scope=\"col\" class=\"text-start\">\n              Balance\n            </th>\n          </tr>\n        </thead>\n        <tbody>{borrowedAssets}</tbody>\n      </table>\n      {/*market */}\n      <Widget src=\"juaner.near/widget/ref-market-burrow-assets\" />\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/juaner.near/widget/ref-lending"}