{"tx_hash": "ESgZrLqPWx7Jzgsu4Ax63vFmvagm3fAUXkKrM9WjG2wE", "action_id_social": "Ap1NwX6yMvFr1A6P42ihXfvaQBVsYCYGasJjMioCsHCP-0-widget", "block_id": 94661167, "block_timestamp": "2023-06-21T03:16:43.385Z", "signer_id": "devgovgigs.near", "widget_name": "gigs-board.entity.post.List", "source_code": "// This component implementation was forked from [IndexFeed], but it does not fully implement lazy loading.\n// While this component uses InfiniteScroll, it still loads the whole list of Post IDs in one view call.\n// The contract will need to be extended with pagination support, yet, even in the current state the page loads much faster.\n// [IndexFeed]: https://near.social/#/mob.near/widget/WidgetSource?src=mob.near/widget/IndexFeed\n\n/* INCLUDE: \"common.jsx\" */\nconst nearDevGovGigsContractAccountId =\n  props.nearDevGovGigsContractAccountId ||\n  (context.widgetSrc ?? \"devgovgigs.near\").split(\"/\", 1)[0];\n\nconst nearDevGovGigsWidgetsAccountId =\n  props.nearDevGovGigsWidgetsAccountId ||\n  (context.widgetSrc ?? \"devgovgigs.near\").split(\"/\", 1)[0];\n\nfunction widget(widgetName, widgetProps, key) {\n  widgetProps = {\n    ...widgetProps,\n    nearDevGovGigsContractAccountId: props.nearDevGovGigsContractAccountId,\n    nearDevGovGigsWidgetsAccountId: props.nearDevGovGigsWidgetsAccountId,\n    referral: props.referral,\n  };\n\n  return (\n    <Widget\n      src={`${nearDevGovGigsWidgetsAccountId}/widget/gigs-board.${widgetName}`}\n      props={widgetProps}\n      key={key}\n    />\n  );\n}\n\nfunction href(widgetName, linkProps) {\n  linkProps = { ...linkProps };\n\n  if (props.nearDevGovGigsContractAccountId) {\n    linkProps.nearDevGovGigsContractAccountId =\n      props.nearDevGovGigsContractAccountId;\n  }\n\n  if (props.nearDevGovGigsWidgetsAccountId) {\n    linkProps.nearDevGovGigsWidgetsAccountId =\n      props.nearDevGovGigsWidgetsAccountId;\n  }\n\n  if (props.referral) {\n    linkProps.referral = props.referral;\n  }\n\n  const linkPropsQuery = Object.entries(linkProps)\n    .filter(([_key, nullable]) => (nullable ?? null) !== null)\n    .map(([key, value]) => `${key}=${value}`)\n    .join(\"&\");\n\n  return `/#/${nearDevGovGigsWidgetsAccountId}/widget/gigs-board.pages.${widgetName}${\n    linkPropsQuery ? \"?\" : \"\"\n  }${linkPropsQuery}`;\n}\n/* END_INCLUDE: \"common.jsx\" */\n\ninitState({\n  period: \"week\",\n});\n\nfunction defaultRenderItem(postId, additionalProps) {\n  if (!additionalProps) {\n    additionalProps = {};\n  }\n  // It is important to have a non-zero-height element as otherwise InfiniteScroll loads too many items on initial load\n  return (\n    <div style={{ minHeight: \"150px\" }}>\n      {widget(\n        `entity.post.Post`,\n        {\n          id: postId,\n          expandable: true,\n          defaultExpanded: false,\n          isInList: true,\n          ...additionalProps,\n        },\n        postId\n      )}\n    </div>\n  );\n}\n\nconst renderItem = props.renderItem ?? defaultRenderItem;\n\nconst cachedRenderItem = (item, i) => {\n  if (props.searchResult && props.searchResult.keywords[item]) {\n    return renderItem(item, {\n      searchKeywords: props.searchResult.keywords[item],\n    });\n  }\n\n  const key = JSON.stringify(item);\n\n  if (!(key in state.cachedItems)) {\n    state.cachedItems[key] = renderItem(item);\n    State.update();\n  }\n  return state.cachedItems[key];\n};\n\nconst initialRenderLimit = props.initialRenderLimit ?? 3;\nconst addDisplayCount = props.nextLimit ?? initialRenderLimit;\n\nfunction getPostsByLabel() {\n  let postIds = Near.view(\n    nearDevGovGigsContractAccountId,\n    \"get_posts_by_label\",\n    {\n      label: props.tag,\n    }\n  );\n  if (postIds) {\n    postIds.reverse();\n  }\n  return postIds;\n}\n\nfunction getPostsByAuthor() {\n  let postIds = Near.view(\n    nearDevGovGigsContractAccountId,\n    \"get_posts_by_author\",\n    {\n      author: props.author,\n    }\n  );\n  if (postIds) {\n    postIds.reverse();\n  }\n  return postIds;\n}\n\nfunction intersectPostsWithLabel(postIds) {\n  if (props.tag) {\n    let postIdLabels = getPostsByLabel();\n    if (postIdLabels === null) {\n      // wait until postIdLabels are loaded\n      return null;\n    }\n    postIdLabels = new Set(postIdLabels);\n    return postIds.filter((id) => postIdLabels.has(id));\n  }\n  return postIds;\n}\n\nfunction intersectPostsWithAuthor(postIds) {\n  if (props.author) {\n    let postIdsByAuthor = getPostsByAuthor();\n    if (postIdsByAuthor == null) {\n      // wait until postIdsByAuthor are loaded\n      return null;\n    } else {\n      postIdsByAuthor = new Set(postIdsByAuthor);\n      return postIds.filter((id) => postIdsByAuthor.has(id));\n    }\n  }\n  return postIds;\n}\n\nconst ONE_DAY = 60 * 60 * 24 * 1000;\nconst ONE_WEEK = 60 * 60 * 24 * 1000 * 7;\nconst ONE_MONTH = 60 * 60 * 24 * 1000 * 30;\n\nfunction getHotnessScore(post) {\n  //post.id - shows the age of the post, should grow exponentially, since newer posts are more important\n  //post.likes.length - linear value\n  const age = Math.pow(post.id, 5);\n  const comments = post.comments;\n  const commentAge = comments.reduce((sum, age) => sum + Math.pow(age, 5), 0);\n  const totalAge = age + commentAge;\n  //use log functions to make likes score and exponentially big age score close to each other\n  return Math.log10(post.likes.length) + Math.log(Math.log10(totalAge));\n}\n\nconst getPeriodText = (period) => {\n  let text = \"Last 24 hours\";\n  if (period === \"week\") {\n    text = \"Last week\";\n  }\n  if (period === \"month\") {\n    text = \"Last month\";\n  }\n  return text;\n};\n\nconst findHottestsPosts = (postIds, period) => {\n  let allPosts;\n  if (!state.allPosts) {\n    allPosts = Near.view(\"devgovgigs.near\", \"get_posts\");\n    if (!allPosts) {\n      return [];\n    }\n    State.update({ allPosts });\n  } else {\n    allPosts = state.allPosts;\n  }\n  let postIdsSet = new Set(postIds);\n  let posts = allPosts.filter((post) => postIdsSet.has(post.id));\n\n  let periodTime = ONE_DAY;\n  if (period === \"week\") {\n    periodTime = ONE_WEEK;\n  }\n  if (period === \"month\") {\n    periodTime = ONE_MONTH;\n  }\n  const periodLimitedPosts = posts.filter((post) => {\n    const timestamp = post.snapshot.timestamp / 1000000;\n    return Date.now() - timestamp < periodTime;\n  });\n  const modifiedPosts = periodLimitedPosts.map((post) => {\n    const comments =\n      Near.view(\"devgovgigs.near\", \"get_children_ids\", {\n        post_id: post.id,\n      }) || [];\n    post = { ...post, comments };\n    return {\n      ...post,\n      postScore: getHotnessScore(post),\n    };\n  });\n  modifiedPosts.sort((a, b) => b.postScore - a.postScore);\n  return modifiedPosts.map((post) => post.id);\n};\n\nlet postIds;\nif (props.searchResult) {\n  postIds = props.searchResult.postIds;\n  postIds = intersectPostsWithLabel(postIds);\n  postIds = intersectPostsWithAuthor(postIds);\n} else if (props.tag) {\n  postIds = getPostsByLabel();\n  postIds = intersectPostsWithAuthor(postIds);\n} else if (props.author) {\n  postIds = getPostsByAuthor();\n} else if (props.recency == \"all\") {\n  postIds = Near.view(nearDevGovGigsContractAccountId, \"get_all_post_ids\");\n  if (postIds) {\n    postIds.reverse();\n  }\n} else {\n  postIds = Near.view(nearDevGovGigsContractAccountId, \"get_children_ids\");\n  if (postIds) {\n    postIds.reverse();\n  }\n}\n\nif (props.recency == \"hot\") {\n  postIds = findHottestsPosts(postIds, state.period);\n}\n\nconst loader = (\n  <div className=\"loader\" key={\"loader\"}>\n    <span\n      className=\"spinner-grow spinner-grow-sm me-1\"\n      role=\"status\"\n      aria-hidden=\"true\"\n    />\n    Loading ...\n  </div>\n);\n\nif (postIds === null) {\n  return loader;\n}\nconst initialItems = postIds;\n//const initialItems = postIds.map(postId => ({ id: postId, ...Near.view(nearDevGovGigsContractAccountId, \"get_post\", { post_id: postId }) }));\n\n// const computeFetchFrom = (items, limit) => {\n//   if (!items || items.length < limit) {\n//     return false;\n//   }\n//   const blockHeight = items[items.length - 1].blockHeight;\n//   return index.options.order === \"desc\" ? blockHeight - 1 : blockHeight + 1;\n// };\n\n// const mergeItems = (newItems) => {\n//   const items = [\n//     ...new Set([...newItems, ...state.items].map((i) => JSON.stringify(i))),\n//   ].map((i) => JSON.parse(i));\n//   items.sort((a, b) => a.blockHeight - b.blockHeight);\n//   if (index.options.order === \"desc\") {\n//     items.reverse();\n//   }\n//   return items;\n// };\n\nconst jInitialItems = JSON.stringify(initialItems);\nif (state.jInitialItems !== jInitialItems) {\n  // const jIndex = JSON.stringify(index);\n  // if (jIndex !== state.jIndex) {\n  State.update({\n    jIndex,\n    jInitialItems,\n    items: initialItems,\n    fetchFrom: false,\n    //nextFetchFrom: computeFetchFrom(initialItems, index.options.limit),\n    nextFetchFrom: false,\n    displayCount: initialRenderLimit,\n    cachedItems: {},\n  });\n  // } else {\n  //   State.update({\n  //     jInitialItems,\n  //     items: mergeItems(initialItems),\n  //   });\n  // }\n}\n\nif (state.fetchFrom) {\n  console.log(\"TODO: fetchFrom\");\n  // const limit = addDisplayCount;\n  // const newItems = Social.index(\n  //   index.action,\n  //   index.key,\n  //   Object.assign({}, index.options, {\n  //     from: state.fetchFrom,\n  //     subscribe: undefined,\n  //     limit,\n  //   })\n  // );\n  // if (newItems !== null) {\n  //   State.update({\n  //     items: mergeItems(newItems),\n  //     fetchFrom: false,\n  //     nextFetchFrom: computeFetchFrom(newItems, limit),\n  //   });\n  // }\n}\n\nconst makeMoreItems = () => {\n  State.update({\n    displayCount: state.displayCount + addDisplayCount,\n  });\n  if (\n    state.items.length - state.displayCount < addDisplayCount * 2 &&\n    !state.fetchFrom &&\n    state.nextFetchFrom &&\n    state.nextFetchFrom !== state.fetchFrom\n  ) {\n    State.update({\n      fetchFrom: state.nextFetchFrom,\n    });\n  }\n};\n\nconst fetchMore =\n  props.manual &&\n  (state.fetchFrom && state.items.length < state.displayCount\n    ? loader\n    : state.displayCount < state.items.length && (\n        <div key={\"loader more\"}>\n          <a href=\"javascript:void\" onClick={(e) => makeMoreItems()}>\n            {props.loadMoreText ?? \"Load more...\"}\n          </a>\n        </div>\n      ));\n\nconst items = state.items ? state.items.slice(0, state.displayCount) : [];\n\nconst renderedItems = items.map(cachedRenderItem);\n\nconst Head =\n  props.recency == \"hot\" ? (\n    <div class=\"row\">\n      <div class=\"fs-5 col-6 align-self-center\">\n        <i class=\"bi-fire\"></i>\n        <span>Hottest Posts</span>\n      </div>\n      <div class=\"col-6 dropdown d-flex justify-content-end\">\n        <a\n          class=\"btn btn-secondary dropdown-toggle\"\n          href=\"#\"\n          role=\"button\"\n          id=\"dropdownMenuLink\"\n          data-bs-toggle=\"dropdown\"\n          aria-expanded=\"false\"\n        >\n          {getPeriodText(state.period)}\n        </a>\n\n        <ul class=\"dropdown-menu\" aria-labelledby=\"dropdownMenuLink\">\n          <li>\n            <button\n              class=\"dropdown-item\"\n              onClick={() => {\n                State.update({ period: \"day\" });\n              }}\n            >\n              {getPeriodText(\"day\")}\n            </button>\n          </li>\n          <li>\n            <button\n              class=\"dropdown-item\"\n              onClick={() => {\n                State.update({ period: \"week\" });\n              }}\n            >\n              {getPeriodText(\"week\")}\n            </button>\n          </li>\n          <li>\n            <button\n              class=\"dropdown-item\"\n              onClick={() => {\n                State.update({ period: \"month\" });\n              }}\n            >\n              {getPeriodText(\"month\")}\n            </button>\n          </li>\n        </ul>\n      </div>\n    </div>\n  ) : (\n    <></>\n  );\n\nreturn (\n  <>\n    {Head}\n    {state.items.length > 0 ? (\n      <InfiniteScroll\n        pageStart={0}\n        loadMore={makeMoreItems}\n        hasMore={state.displayCount < state.items.length}\n        loader={loader}\n      >\n        {renderedItems}\n      </InfiniteScroll>\n    ) : (\n      <p class=\"text-secondary\">\n        No posts {props.searchResult ? \"matches search\" : \"\"}\n        {props.recency === \"hot\"\n          ? \" in \" + getPeriodText(state.period).toLowerCase()\n          : \"\"}\n      </p>\n    )}\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/devgovgigs.near/widget/gigs-board.entity.post.List", "__row_index": 0}