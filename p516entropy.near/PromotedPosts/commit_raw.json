{"tx_hash": "8KUqAMwiZ2Qy6YAQBe4KD6R2cTVrXzBMA6VkX61n2y7v", "action_id_social": "79KhgmPmGvmCD6HBQXk4kT7r4KshPFDz61Dbep843JKv-0-widget", "block_id": 86599671, "block_timestamp": "2023-03-05 08:28:16.288", "signer_id": "p516entropy.near", "widget_name": "PromotedPosts", "source_code": "const amountOfResultsToShowFirst = 5;\r\nState.init({\r\n  promotedPosts: [],\r\n  shownPromotedPosts: [],\r\n});\r\n\r\nconst daysBetweenTimestamps = (timestamp1, timestamp2) => {\r\n  const oneDay = 24 * 60 * 60 * 1000; // one day in milliseconds\r\n  const timeDiff = Math.abs(timestamp2 - timestamp1); // difference in milliseconds\r\n  const numDays = Math.round(timeDiff / oneDay); // round to nearest integer\r\n  return numDays;\r\n};\r\n\r\nconst calculateBidPower = (deposit) => {\r\n  const daysBetween = daysBetweenTimestamps(\r\n    deposit.timestamp,\r\n    deposit.expire_timestamp\r\n  );\r\n  return deposit.amount / daysBetween;\r\n};\r\n\r\nconst findPromotedPosts = (posts, deposits) => {\r\n  console.log(deposits);\r\n  const postsDepositsDictionary = {};\r\n\r\n  deposits\r\n    .filter((deposit) => deposit.expire_timestamp > Date.now())\r\n    .forEach((deposit) => {\r\n      const postId = deposit.post_id;\r\n      const currentBidPower = (\r\n        postsDepositsDictionary[postId] || { bidPower: 0 }\r\n      ).bidPower;\r\n\r\n      postsDepositsDictionary[postId] = {\r\n        bidPower: currentBidPower + calculateBidPower(deposit),\r\n      };\r\n    });\r\n\r\n  const promotedPosts = posts.filter((post) =>\r\n    postsDepositsDictionary.hasOwnProperty(post.id)\r\n  );\r\n\r\n  promotedPosts.sort((a, b) => {\r\n    const postABidPower = postsDepositsDictionary[a.id].bidPower;\r\n    const postBBidPower = postsDepositsDictionary[b.id].bidPower;\r\n\r\n    if (postABidPower !== postBBidPower) {\r\n      // If scores are different, sort by score in descending order\r\n      return postBBidPower - postABidPower;\r\n    } else {\r\n      // If scores are equal, add a random factor to the sorting\r\n      return Math.random() - 0.5;\r\n    }\r\n  });\r\n  return promotedPosts;\r\n};\r\n\r\nconst showMorePromotedPosts = () => {\r\n  const shownPromotedPosts = state.shownPromotedPosts || [];\r\n  console.log(shownPromotedPosts);\r\n  const newShownPromotedPosts = state.promotedPosts.slice(\r\n    0,\r\n    shownPromotedPosts.length + amountOfResultsToShowFirst\r\n  );\r\n  console.log(newShownPromotedPosts);\r\n  State.update({ shownPromotedPosts: newShownPromotedPosts });\r\n};\r\n\r\nconst deposits = Near.view(\"promotepost.near\", \"get_all_deposits\") || [];\r\nconst posts = Near.view(\"devgovgigs.near\", \"get_posts\") || [];\r\nif (!state.promotedPosts.length) {\r\n  const promotedPosts = findPromotedPosts(posts, deposits);\r\n  State.update({\r\n    promotedPosts,\r\n    shownPromotedPosts: promotedPosts.slice(0, amountOfResultsToShowFirst),\r\n  });\r\n}\r\n\r\nreturn (\r\n  <div>\r\n    <div class=\"row\">\r\n      <div class=\"fs-5\">\r\n        <i class=\"bi-cash-coin\"></i>\r\n        <span>Promoted Posts</span>\r\n      </div>\r\n    </div>\r\n    {!!state.shownPromotedPosts.length ? (\r\n      <div>\r\n        <InfiniteScroll\r\n          pageStart={0}\r\n          loadMore={showMorePromotedPosts}\r\n          hasMore={state.shownPromotedPosts.length < state.promotedPosts.length}\r\n          loader={<div className=\"loader\">Loading ...</div>}\r\n        >\r\n          {state.shownPromotedPosts.map((post) => {\r\n            return (\r\n              <div key={post.id} style={{ \"min-height\": \"10em\" }}>\r\n                <Widget\r\n                  src={`p516entropy.near/widget/SearchResultPost`}\r\n                  props={{\r\n                    post: post,\r\n                  }}\r\n                  key={key}\r\n                />\r\n              </div>\r\n            );\r\n          })}\r\n        </InfiniteScroll>\r\n      </div>\r\n    ) : (\r\n      <div class=\"py-2\" style={{ \"min-height\": \"10em\" }}>\r\n        Not posts have been promoted recently\r\n      </div>\r\n    )}\r\n  </div>\r\n);\r\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/p516entropy.near/widget/PromotedPosts", "metadata.description": NaN, "metadata.tags.devgovgigs": NaN, "metadata.tags.promote": NaN}