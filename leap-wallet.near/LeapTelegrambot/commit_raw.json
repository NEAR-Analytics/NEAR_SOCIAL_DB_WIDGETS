{"tx_hash": "2ZppLDpLywkH4txdqVntY9xkrEcQQcJpZcWTJCNe5HFx", "action_id_social": "Agar9WYrD1zzEt8ox7BSzyFUkYi4n4TJfHq8H5wT1JJE-0-widget", "block_id": 86745786, "block_timestamp": "2023-03-07 08:08:34.983", "signer_id": "leap-wallet.near", "widget_name": "LeapTelegrambot", "source_code": null, "metadata": null, "widget_modules_used": null, "widget_url": "https://near.social/#/leap-wallet.near/widget/LeapTelegrambot", "branch.draft": NaN, "branch.draft.": "const accountId = context.accountId;\nconst poller = null;\n\nif (!accountId) {\n  return \"Please sign in with NEAR wallet to connect to telegram\";\n}\n\nconst fetchOTP = () => {\n  State.update({\n    connectionId: \"\",\n    name: \"\",\n    fetching: true,\n    error: \"\",\n  });\n  const id = Math.random() * 100 * Math.random();\n  return asyncFetch(\"https://notifications.leapwallet.io/api/v1/otp\", {\n    body: `{\n          \"identifier\": \"${id}\",\n          \"accountId\": \"${accountId}\",\n          \"metadata\": {\n              \"subscriptions\": [\n                  {\n                      \"address\": \"${accountId}\"\n                  }\n              ]\n          }\n      }`,\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    method: \"POST\",\n  });\n};\n\nconst fetchStatus = () => {\n  return asyncFetch(\n    `https://notifications.leapwallet.io/api/v1/near/status?accountId=${accountId}`\n  );\n};\n\nconst getOtp = () => {\n  fetchOTP()\n    .then((res) => {\n      State.update({ otp: res.body.otp, fetching: false });\n      getStatus();\n    })\n    .catch((e) => {\n      State.update({ error: \"Something went wrong in fetching OTP\" });\n    });\n};\n\nconst getStatus = () => {\n  poller = setInterval(() => {\n    // If otp is fetched\n    fetchStatus()\n      .then((res) => {\n        if (res.body.success) {\n          State.update({\n            connectionId: res.body.connectionMetadata[0].connId,\n            name: res.body.connectionMetadata[0].name,\n            otp: \"\",\n            error: \"\",\n            fetching: false,\n          });\n          clearInterval(poller);\n        }\n      })\n      .catch(() => {\n        State.update({\n          error: \"Something went wrong on fetching status\",\n          fetching: false,\n        });\n      });\n  }, 3000);\n};\n\nState.init({\n  otp: \"\",\n  connectionId: \"\",\n  error: \"\",\n  fetching: false,\n});\n\nconst tgDisconnect = (connectionId) => {\n  return asyncFetch(\n    \"https://notifications.leapwallet.io/api/v1/near/disconnect\",\n    {\n      body: `{\n        \"walletAddr\": \"${accountId}\",\n        \"connId\": \"${connectionId}\"\n    }`,\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      method: \"POST\",\n    }\n  );\n};\n\nconst disConnect = (connectionId) => {\n  tgDisconnect(connectionId).then((res) => {\n    State.update({ otp: \"\", connectionId: \"\", name: \"\", fetching: false });\n  });\n};\n\nreturn (\n  <div className=\"row\">\n    <div className=\"col-lg-6\">\n      <div>\n        <h3>Leap telegram bot</h3>\n      </div>\n      <div>\n        {state.connectionId && (\n          <div>\n            {accountId} is already connected to {state.name}\n            <div style={{ marginTop: 24 }}>\n              To disconnect type <i>/disconnect</i> in\n              <a\n                href=\"https://t.me/LeapboardAlerts_NearBot/start\"\n                target=\"_blank\"\n              >\n                Leap Telegram bot\n              </a>\n              or\n              <div>\n                search for <b>Leapboard Alerts - Near</b> in telegram\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n      {!!!state.connectionId && (\n        <div>\n          {state.otp && (\n            <div>\n              You OTP is\n              <h3 style={{ color: \"green\" }}>{state.otp}</h3>\n              <h4>Steps to connect</h4>\n              <div>\n                <span>1. Goto, </span>\n                <a\n                  href=\"https://t.me/LeapboardAlerts_NearBot/start\"\n                  target=\"_blank\"\n                >\n                  Leap Telegram bot\n                </a>\n                or\n                <div>\n                  search for <b>Leapboard Alerts - Near</b> in telegram\n                </div>\n              </div>\n              <div>\n                2. Type <i>/verify-otp</i>\n              </div>\n              <div>3. Enter the OTP to connect.</div>\n            </div>\n          )}\n          {!!!state.otp && (\n            <button\n              class=\"btn btn-primary\"\n              onClick={() => {\n                getOtp();\n              }}\n            >\n              Get OTP\n            </button>\n          )}\n        </div>\n      )}\n    </div>\n  </div>\n);\n"}