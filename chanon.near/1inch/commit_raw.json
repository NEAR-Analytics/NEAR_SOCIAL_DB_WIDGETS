{"tx_hash": "QYWS3MawVkghubUQPGy2ZUYrpLGoP4tgumahYzd2sYo", "action_id_social": "6GHCY57i65BbSfBTUgjKFpTRd293UGoXbxxtp73MFkVB-0-widget", "block_id": 91131244, "block_timestamp": "2023-05-05 05:30:31.862", "signer_id": "chanon.near", "widget_name": "1inch", "source_code": "// \u0e40\u0e2b\u0e25\u0e37\u0e2d State.update({ txHash: \"https://bscscan.com/tx/\" + tx.hash }); \u0e2b\u0e25\u0e31\u0e07 Swap\n// \u0e40\u0e2b\u0e25\u0e37\u0e2d \u0e1b\u0e38\u0e48\u0e21 Max\n// \u0e40\u0e2b\u0e25\u0e37\u0e2d \u0e43\u0e2a\u0e48 Amount\n// \u0e40\u0e2b\u0e25\u0e37\u0e2d Swap \u0e44\u0e21\u0e48\u0e44\u0e14\u0e49\u0e16\u0e49\u0e32\u0e44\u0e21\u0e48\u0e43\u0e2a\u0e48 \u0e40\u0e2b\u0e23\u0e35\u0e22\u0e0d\u0e1b\u0e25\u0e32\u0e22\u0e17\u0e32\u0e07 \u0e2b\u0e23\u0e37\u0e2d \u0e40\u0e2b\u0e23\u0e35\u0e22\u0e0d \u0e15\u0e49\u0e19\u0e17\u0e32\u0e07\u0e01\u0e31\u0e1a \u0e1b\u0e25\u0e32\u0e22\u0e17\u0e32\u0e07\u0e40\u0e2b\u0e21\u0e37\u0e2d\u0e19\u0e01\u0e31\u0e19\n\ninitState({\n  toggleAmount: false,\n  txHash: \"\",\n  tokenDecimals: 18,\n});\n\nconst signer = Ethers.send(\"eth_requestAccounts\", [])[0];\n\nif (!signer) {\n  return (\n    <div>\n      <h3>Please connect your wallet</h3>\n      <Web3Connect />\n    </div>\n  );\n}\n\nif (\n  state.chainId === undefined &&\n  ethers !== undefined &&\n  Ethers.send(\"eth_requestAccounts\", [])[0]\n) {\n  Ethers.provider()\n    .getNetwork()\n    .then((chainIdData) => {\n      if (chainIdData?.chainId) {\n        State.update({ chainId: chainIdData.chainId });\n      }\n    });\n}\n\nif (state.chainId !== 56) {\n  return (\n    <div>\n      <h3>\n        Wrong Network - We only support the Binance Smart Chain mainnet at this\n        time.\n      </h3>\n    </div>\n  );\n}\n\nconst setToken = (token) => {\n  State.update({ token });\n  checkAllowance(token);\n};\n\nconst setDestinationToken = (destinationToken) => {\n  State.update({ destinationToken });\n};\n\nfunction checkAllowance(token) {\n  asyncFetch(\n    \"https://api.1inch.io/v5.0/\" +\n      state.chainId +\n      \"/approve/allowance?tokenAddress=\" +\n      token +\n      \"&walletAddress=\" +\n      signer\n  ).then((res) => {\n    console.log(res);\n    if (res.status === 200) {\n      {\n        res.body.allowance > 0\n          ? State.update({ toggleAmount: true })\n          : State.update({ toggleAmount: false });\n      }\n    } // TODO :: need to handle error ?\n  });\n}\n\nconst tokens = {\n  \"Select Token\": \"\",\n  USDT: \"0x55d398326f99059fF775485246999027B3197955\",\n  BUSD: \"0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56\",\n};\n\nconst tokensMenuItems = Object.keys(tokens).map((token) => (\n  <option value={tokens[token]}>{token}</option>\n));\n\nconst BUSD = \"0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56\";\nconst USDT = \"0x55d398326f99059fF775485246999027B3197955\";\nconst ROUTER = \"0x1111111254eeb25477b68fb85ed929f73a960582\";\n\nconst MAX_AMOUNT =\n  \"0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\";\n\nconst MIN_AMOUNT =\n  \"0x0000000000000000000000000000000000000000000000000000000000000000\";\n\nconst erc20Abi = fetch(\n  \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n);\nif (!erc20Abi.ok) {\n  return \"busd not ok\";\n}\n\nconst oneInchAbi = fetch(\n  \"https://gist.githubusercontent.com/taforyou/5747abd24159d5fd4e95cf1820d5d90f/raw/ca965bdfa9a291d2e0e8617f9f6b53d132baa0c6/1inchv5.abi.json\"\n);\nif (!oneInchAbi.ok) {\n  return \"1inch not ok\";\n}\n\nconst apiBaseUrl = \"https://api.1inch.io/v5.0/\" + state.chainId;\n\nfunction apiRequestUrl(methodName, queryParams) {\n  return apiBaseUrl + methodName + \"?\" + buildSearchParams(queryParams);\n}\n\nfunction buildSearchParams(params) {\n  var ss = [];\n  for (const [key, value] of Object.entries(params)) {\n    ss.push(`${key}=${value}`);\n  }\n  return ss.join(\"&\");\n}\n\nconst handleApprove = () => {\n  const approveToken = new ethers.Contract(\n    state.token,\n    erc20Abi.body,\n    Ethers.provider().getSigner()\n  );\n\n  approveToken.approve(ROUTER, MAX_AMOUNT).then((tx) => {\n    State.update({ txHash: \"https://bscscan.com/tx/\" + tx.hash });\n    // console.log({\n    //   log: \"The TX hash is: \" + tx.hash,\n    //   explorerLink: \"https://bscscan.com/tx/\" + tx.hash,\n    // });\n  });\n};\n\nconst handleSwap = () => {\n  console.log(\"fromTokenAddress \", state.token);\n  console.log(\"destinationToken \", state.destinationToken);\n  const swapParam = {\n    fromTokenAddress: state.token,\n    toTokenAddress: state.destinationToken,\n    amount: \"1000000000000000000\", // 1 * 10^18 wei\n    fromAddress: signer,\n    slippage: 1,\n  };\n  asyncFetch(apiRequestUrl(\"/swap\", swapParam)).then(({ ok, body }) => {\n    if (!ok) {\n      return;\n    }\n\n    const ifaceOneInch = new ethers.utils.Interface(oneInchAbi.body);\n    const r = ifaceOneInch.decodeFunctionData(\"swap\", body.tx.data);\n    const oneInch = new ethers.Contract(\n      ROUTER,\n      oneInchAbi.body,\n      Ethers.provider().getSigner()\n    );\n\n    // Function: swap(address executor,tuple desc,bytes permit,bytes data)\n    oneInch.swap(r.executor, r.desc, r.permit, r.data).then((x) => {\n      console.log(x);\n    });\n  });\n};\n\nreturn (\n  <div>\n    <h3>Swap BEP-20 tokens via 1inch V.5</h3>\n    <div class=\"mb-3\">\n      <label for=\"selectToken\">From token</label>\n      <select\n        class=\"form-select\"\n        id=\"selectToken\"\n        onChange={(e) => {\n          setToken(e.target.value);\n        }}\n      >\n        {tokensMenuItems}\n      </select>\n    </div>\n\n    {state.toggleAmount ? (\n      <input\n        value={state.fromTokenAmount}\n        onChange={(e) => State.update({ fromTokenAmount: e.target.value })}\n        placeholder=\"Amount\"\n      />\n    ) : (\n      <button\n        class=\"btn btn-success\"\n        onClick={handleApprove}\n        disabled={state.token ? false : true}\n      >\n        Please allow the use of a 1-inch router for the swap.\n      </button>\n    )}\n    <div class=\"mb-3\">\n      <label for=\"selectToken\">To token</label>\n      <select\n        class=\"form-select\"\n        id=\"selectToken\"\n        onChange={(e) => {\n          setDestinationToken(e.target.value);\n        }}\n      >\n        {tokensMenuItems}\n      </select>\n    </div>\n    <button class=\"btn btn-success\" onClick={handleSwap} disabled={false}>\n      Swap\n    </button>\n    <div>tx explorer : {state.txHash}</div>\n  </div>\n);\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chanon.near/widget/1inch", "metadata.tags.ethdenver2023": NaN}