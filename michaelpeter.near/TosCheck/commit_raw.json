{"tx_hash": "3rsP2n4QxqobiBAV6JVMDjin8KTG3VAJSzgMiXJ5Gfhw", "action_id_social": "2sugGottZ2eTBeJ6uSs434WRB2qCYQCJy8fArVmDqd7R-1-widget", "block_id": 85890929, "block_timestamp": "2023-02-23 21:17:10.153", "signer_id": "michaelpeter.near", "widget_name": "TosCheck", "source_code": "const { tosName, targetComponent, logOut } = props;\nconst targetProps = props?.targetProps || {};\nconst acceptanceKey = tosName; // may change\n\nState.init({\n  hasCommittedAcceptance: false,\n  agreeIsChecked: false,\n  expand: false,\n});\n\n// find all instances of the user agreeing to some version of the desired TOS\nconst agreementsForUser = Social.index(\"tosAccept\", acceptanceKey, {\n  accountId: context.accountId, // make sure it was written by the user in question\n});\n\nconst tosVersions = Social.keys(tosName, \"final\", {\n  return_type: \"BlockHeight\",\n  // subscribe: true,\n});\n\n// TODO path validation before this\nconst tosPath = tosName.split(\"/\");\nconst latestTosVersion = tosPath.reduce((acc, curr) => {\n  return acc[curr];\n}, tosVersions);\n\nconst Backdrop = styled.div`\n  height: 100vh;\n  width: 100vw;\n  background-color: rgba(0, 0, 0, 0.5);\n  position: fixed;\n  left: 0;\n  top: 0;\n  z-index: 1001;\n`;\n\nconst Modal = styled.div`\n  width: 30rem;\n  max-width: 95vw;\n  max-height: 80vh;\n  background-color: white;\n  border-radius: 10px;\n  margin: auto;\n  padding: 1.5rem;\n  display: flex;\n  row-gap: 1rem;\n  flex-direction: column;\n`;\n\nconst ModalContent = styled.div`\ndisplay: flex;\nflex-direction: column;\nflex-grow:1\nmin-height 0;\noverflow-y: auto;\n`;\n\nconst ModalFooter = styled.div`\n  display: flex;\n  flex-direction: column;\n  row-gap: 2rem;\n`;\n\nconst AcceptSection = styled.div`\n  display: flex;\n  flex-direction: row;\n  column-gap: 1rem;\n`;\n\nconst CheckWrapper = styled.div`\ndisplay: flex;\nflex-direction: row;\nalign-items: center;\ncolor: ${state.agreeIsChecked ? \"var(--bs-green)\" : \"inherit\"}\n`;\n\nconst CheckButton = styled.button`\n  border: none;\n  --bs-btn-hover-bg: transparent;\n  --bs-btn-active-bg: transparent;\n  --bs-btn-color: ${state.agreeIsChecked ? \"var(--bs-green)\" : \"black\"};\n  --bs-btn-hover-color: ${\n    state.agreeIsChecked ? \"var(--bs-green)\" : \"var(--bs-blue)\"\n  };\n`;\n\nconst expand = (e) => {\n  State.update({ expand: e });\n};\n\n// we check for existence of Index results because if no results are found\n// we get an empty array. This means that when the existence check fails\n// we are still loading and we do not want to potentially flash the modal\n// until we know for sure that it should be displayed\nconst showTos =\n  !state.hasCommittedAcceptance &&\n  context.accountId &&\n  latestTosVersion &&\n  agreementsForUser &&\n  (!agreementsForUser.length ||\n    agreementsForUser[agreementsForUser.length - 1].value < latestTosVersion);\n\nreturn (\n  <div>\n    <Backdrop style={{ display: showTos ? \"flex\" : \"none\" }} className=\"flex\">\n      <Modal>\n        <ModalContent>\n          <Widget src={tosName} props={expand} />\n        </ModalContent>\n        <ModalFooter>\n          <CheckWrapper>\n            <CheckButton\n              onClick={() => {\n                State.update({ agreeIsChecked: !state.agreeIsChecked });\n              }}\n              className=\"btn btn-outline-dark\"\n            >\n              <div className=\"d-flex flex-row align-items-center gap-3\">\n                <i\n                  className={`bi bi-${\n                    state.agreeIsChecked ? \"check-square\" : \"square\"\n                  }`}\n                  style={{ fontSize: \"1.5rem\" }}\n                />\n                <span style={{ textAlign: \"left\" }}>\n                  I agree to the Terms of Service, Privacy Policy, and Community\n                  Guidelines\n                </span>\n              </div>\n            </CheckButton>\n          </CheckWrapper>\n          <AcceptSection>\n            <button\n              className=\"btn btn-outline-secondary\"\n              style={{\n                flexGrow: 1,\n                flexBasis: \"10rem\",\n                borderRadius: \"1.25rem\",\n              }}\n              onClick={logOut}\n            >\n              Decline\n            </button>\n            <CommitButton\n              style={{\n                flexGrow: 1,\n                flexBasis: \"10rem\",\n                borderRadius: \"1.25rem\",\n              }}\n              disabled={!state.agreeIsChecked}\n              data={{\n                index: {\n                  tosAccept: JSON.stringify({\n                    key: acceptanceKey,\n                    value: latestTosVersion,\n                  }),\n                },\n              }}\n              onCommit={() => {\n                State.update({ hasCommittedAcceptance: true });\n              }}\n            >\n              Continue\n            </CommitButton>\n          </AcceptSection>\n        </ModalFooter>\n      </Modal>\n    </Backdrop>\n    <Widget src={targetComponent} props={targetProps} />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/michaelpeter.near/widget/TosCheck"}