{"tx_hash": "DGf9uWUwEjf5we4bfj9LkDRvX7NPu6usYU1kQi8VNcva", "action_id_social": "AWw7WQpD6qxY97Ueo9e2BrpAdwcUpqZG7QUg8857HNj-0-widget", "block_id": 88783083, "block_timestamp": "2023-04-04 07:13:47.192", "signer_id": "chess-game.near", "widget_name": "ChessGameReplay", "source_code": "const { game_id } = props;\nconst accountId = game_id[1];\nconst gameIdStr = JSON.stringify(game_id);\nconst contractId = \"app.chess-game.near\";\nconst chessBoardWidget = \"chess-game.near/widget/ChessBoard\";\nconst waitTime = 50;\nconst waitTimeOnErr = 500;\n\nif (!accountId) {\n  return \"Malformed game_id prop!\";\n}\n\nconst BoardView = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n`;\nconst LoadingWrapper = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  margin: 3rem 0;\n`;\nconst Loading = styled.div`\n  width: 80px;\n  height: 80px;\n  border-radius: 50%;\n  border: 7px solid transparent;\n  border-top-color: rgba(0, 0, 0, 0.6);\n  animation: rotate 800ms linear infinite;\n\n  @keyframes rotate {\n\t\t0% {\n\t\t\ttransform: rotate(0deg);\n\t\t}\n\t\t100% {\n\t\t\ttransform: rotate(360deg);\n\t\t}\n\t}\n`;\n\nconst fetchOptions = {\n  headers: {\n    \"x-api-key\": \"36f2b87a-7ee6-40d8-80b9-5e68e587a5b5\",\n  },\n};\n\nlet transactions = state?.transactions ?? [];\nif (!state.transactions) {\n  let offset = 0;\n  while (true) {\n    const res = fetch(\n      `https://api.pikespeak.ai/event-historic/${contractId}?offset=${offset}&contractFilter=${accountId}&filters=FUNCTION_CALL`,\n      fetchOptions\n    );\n    offset += 50;\n    if (!res.ok) {\n      return `Pikespeak API returned error: ${JSON.stringify(res)}`;\n    }\n\n    if (res.body.length === 0) break;\n    transactions = transactions.concat(res.body);\n    if (res.body.length < 50) break;\n  }\n}\n\nlet events = state?.events ?? [];\nState.init({\n  transactions,\n  events,\n  tabIndex: 0,\n  errCount: state?.errCount ?? 0,\n});\n\nif (transactions.length > 0) {\n  const tx = transactions.pop();\n\n  asyncFetch(\n    `https://api.pikespeak.ai/tx/graph-by-hash/${tx.transaction_id}`,\n    fetchOptions\n  ).then(({ ok, body }) => {\n    if (!ok) {\n      transactions.push(tx);\n      setTimeout(() => {\n        State.update({\n          errCount: state.errCount + 1,\n        });\n      }, waitTimeOnErr);\n      return;\n    }\n    const { logs } = body[0].transaction_graph.eoNode.childs[0].content;\n    const newEvents = logs\n      .filter((log) => log.startsWith(\"EVENT_JSON:\"))\n      .map((log) => JSON.parse(log.substr(11)))\n      .filter(({ data }) => JSON.stringify(data.game_id) == gameIdStr);\n    if (newEvents.length > 0) {\n      State.update({\n        transactions,\n        events: events.concat(newEvents),\n      });\n      return;\n    }\n\n    setTimeout(() => {\n      State.update({\n        transactions,\n      });\n    }, waitTime);\n  });\n  return (\n    <LoadingWrapper>\n      <div>Scanning transactions. Remaining: {transactions.length}</div>\n      <Loading />\n    </LoadingWrapper>\n  );\n}\n\nconst GameInfo = styled.div`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  font-size: 1.4rem;\n  margin: 1rem;\n  width: 350px;\n`;\nconst Button = styled.button`\n  display: flex;\n  flex-direction: column;\n  border: 1px solid black;\n  border-radius: 4px;\n  visibility: ${(props) => (props.invisible ? \"hidden\" : \"visible\")};\n`;\nconst ButtonWrapper = styled.div`\n  display: flex;\n  justify-content: space-around;\n`;\nconst HorizontalLine = styled.div`\n  width: 100%;\n  border: 1px solid black;\n  margin: 1rem 0;\n`;\nconst Move = styled.div`\n  text-align: center;\n  visibility: ${(props) => (props.invisible ? \"hidden\" : \"visible\")};\n`;\nconst Outcome = styled.div`\n  display: flex;\n  justify-content: center;\n  margin-top: 1rem;\n  font-weight: 600;\n  font-size: 1.8rem;\n  visibility: ${(props) => (props.invisible ? \"hidden\" : \"visible\")};\n`;\n\nconst renderPlayer = (color, player) => {\n  if (player.Human) {\n    return (\n      <div>\n        Player {color}: {player.Human}\n      </div>\n    );\n  } else if (player.Ai) {\n    return (\n      <div>\n        Player {color}: AI ({player.Ai})\n      </div>\n    );\n  } else {\n    const err = new Error(`Unable to render player: ${player}`);\n    console.error(err);\n    return \"\";\n  }\n};\nconst renderMove = (move, label) => (\n  <Move invisible={!move}>\n    {label}: {move && move.color + \" \" + move.mv}\n  </Move>\n);\nconst renderOutcome = (outcome) => (\n  <Outcome invisible={!outcome}>\n    {outcome\n      ? outcome.Victory\n        ? `Victory: ${outcome.Victory}`\n        : outcome\n      : \"placeholder\"}\n  </Outcome>\n);\nconst setTabIndex = (index) => () => {\n  State.update({\n    tabIndex: index,\n  });\n};\n\nconst prevMove = state.events[state.tabIndex - 1]?.data;\nconst nextMove = state.events[state.tabIndex + 1]?.data;\nconst boardState = state.events[state.tabIndex].data;\nif (!boardState.board) {\n  return (\n    <BoardView>\n      Unable to render board. It looks like this game has been created with an\n      older version of the contract and it's incompatible with replay rendering.\n    </BoardView>\n  );\n}\n\nreturn (\n  <BoardView>\n    <GameInfo>\n      <div>ID: {game_id[0]}</div>\n      {renderPlayer(\"White\", state.events[0].data.white)}\n      {renderPlayer(\"Black\", state.events[0].data.black)}\n    </GameInfo>\n    <HorizontalLine />\n    <GameInfo>\n      {renderMove(prevMove, \"Previous Move\")}\n      {renderMove(nextMove, \"Next Move\")}\n      <ButtonWrapper>\n        <Button invisible={!prevMove} onClick={setTabIndex(state.tabIndex - 2)}>\n          \u21e6\n        </Button>\n        <Button invisible={!nextMove} onClick={setTabIndex(state.tabIndex + 2)}>\n          \u21e8\n        </Button>\n      </ButtonWrapper>\n      {renderOutcome(boardState.outcome)}\n    </GameInfo>\n    <Widget src={chessBoardWidget} props={{ board: boardState.board }} />\n  </BoardView>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chess-game.near/widget/ChessGameReplay"}