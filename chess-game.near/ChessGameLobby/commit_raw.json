{"tx_hash": "6Z895Zoux3uMRAhn2zSzyJz3Gvue2k3Xof1MJrgBb3DU", "action_id_social": "Hd4VfEpsJbAf1V3nZNYaqPB1r58RLNudqnpBucb1cYAW-0-widget", "block_id": 94827436, "block_timestamp": "2023-06-23T07:27:13.631Z", "signer_id": "chess-game.near", "widget_name": "ChessGameLobby", "source_code": "const { accountId } = context;\nif (!accountId) {\n  return \"You need to login with your Near wallet first!\";\n}\n\nconst contractId = \"app.chess-game.near\";\nconst headerWidget = \"chess-game.near/widget/ChessGameHeader\";\nconst gameWidget = \"chess-game.near/widget/ChessGame\";\nconst replayWidget = \"chess-game.near/widget/ChessGameReplay\";\nconst challengeWidget = \"chess-game.near/widget/ChessGameChallenge\";\nconst aiWidget = \"chess-game.near/widget/ChessGameAi\";\nconst buttonWidget = \"chess-game.near/widget/ChessGameButton\";\nconst loadingWidget = \"chess-game.near/widget/ChessGameLoading\";\n\nconst LobbyView = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: ${(props) => (props.alignItems ? props.alignItems : \"center\")};\n  max-width: 550px;\n  margin: 0 auto;\n  box-sizing: border-box;\n\n  h1 {\n    align-self: center;\n  }\n\n  > * {\n    margin: 1.2rem 0;\n  }\n`;\nconst Content = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: ${(props) => (props.alignItems ? props.alignItems : \"center\")};\n\n  > * {\n    margin: 0.4rem 0;\n  }\n`;\nconst Disclaimer = styled.div`\n  margin-top: 1rem;\n  font-style: italic;\n  font-size: 1.2rem;\n`;\n\nState.init({\n  game_id: null,\n  replay_game_id: null,\n  isRegistered: state.isRegistered,\n  gameIds: null,\n  finishedGames: null,\n  recentFinishedGames: null,\n});\n\nconst updateIsRegistered = () => {\n  Near.asyncView(contractId, \"storage_balance_of\", {\n    account_id: accountId,\n  }).then((res) => {\n    State.update({\n      isRegistered: !!res,\n    });\n  });\n};\nupdateIsRegistered();\nif (state.isRegistered == null) {\n  return <Widget src={loadingWidget} />;\n}\n\nconst registerAccount = () => {\n  Near.call(\n    contractId,\n    \"storage_deposit\",\n    {},\n    undefined,\n    \"50000000000000000000000\"\n  );\n  updateIsRegistered();\n};\n\nif (!state.isRegistered) {\n  return (\n    <LobbyView>\n      <Widget src={headerWidget} />\n      <Disclaimer>\n        You need to pay storage deposit of 0.05N first before being allowed to\n        play Chess On Chain.\n        <br />\n        If you don't get redirected after registering, please refresh the page.\n      </Disclaimer>\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: registerAccount,\n          fontSize: \"1.2rem\",\n          content: \"Register Account\",\n        }}\n      />\n    </LobbyView>\n  );\n}\n\nNear.asyncView(contractId, \"get_game_ids\", {\n  account_id: accountId,\n}).then((gameIds) =>\n  State.update({\n    gameIds,\n  })\n);\nNear.asyncView(contractId, \"finished_games\", {\n  account_id: accountId,\n}).then((finishedGames) => {\n  finishedGames.sort((a, b) => b[0] - a[0]);\n  State.update({\n    finishedGames,\n  });\n});\nNear.asyncView(contractId, \"recent_finished_games\", {}).then(\n  (recentFinishedGames) =>\n    State.update({\n      recentFinishedGames,\n    })\n);\nif (\n  state.gameIds == null ||\n  state.finishedGames == null ||\n  state.recentFinishedGames == null\n) {\n  return <Widget src={loadingWidget} />;\n}\n\nconst GameSelector = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  align-items: center;\n  justify-content: space-between;\n\n  > * {\n    margin: 1rem;\n  }\n`;\n\nconst selectGame = (gameId, isFinished) => () => {\n  if (isFinished) {\n    State.update({\n      replay_game_id: gameId,\n    });\n  } else {\n    State.update({\n      game_id: gameId,\n    });\n  }\n};\nconst returnToLobby = () => {\n  State.update({\n    game_id: null,\n    replay_game_id: null,\n  });\n};\nconst resign = () => {\n  Near.call(contractId, \"resign\", {\n    game_id: state.game_id,\n  });\n  State.update({\n    game_id: null,\n  });\n};\n\nconst renderGameIds = (gameIds, isFinished, displayPlayers) =>\n  gameIds.map((gameId) => {\n    let gameInfo;\n    if (!isFinished) {\n      gameInfo = Near.view(contractId, \"game_info\", {\n        game_id: gameId,\n      });\n    }\n    return (\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: selectGame(gameId, isFinished),\n          content: (\n            <>\n              <div>ID: {gameId[0]}</div>\n              {displayPlayers && (\n                <>\n                  <div>White: {gameId[1]}</div>\n                  {gameId[2] && <div>Black: {gameId[2]}</div>}\n                </>\n              )}\n              {gameInfo && (\n                <div>\n                  VS:{\" \"}\n                  {gameInfo.black.Ai ? (\n                    <>AI ({gameInfo.black.Ai})</>\n                  ) : (\n                    <>Player ({gameInfo.black.Human})</>\n                  )}\n                </div>\n              )}\n            </>\n          ),\n        }}\n      />\n    );\n  });\n\nlet content;\nif (state.game_id) {\n  content = (\n    <Content alignItems=\"stretch\">\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: returnToLobby,\n          alignSelf: \"center\",\n          content: \"Return To Lobby\",\n        }}\n      />\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: resign,\n          alignSelf: \"center\",\n          content: \"Resign\",\n        }}\n      />\n      <Widget src={gameWidget} props={{ game_id: state.game_id }} />\n    </Content>\n  );\n} else if (state.replay_game_id) {\n  content = (\n    <Content alignItems=\"stretch\">\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: returnToLobby,\n          alignSelf: \"center\",\n          content: \"Return To Lobby\",\n        }}\n      />\n      <Widget src={replayWidget} props={{ game_id: state.replay_game_id }} />\n    </Content>\n  );\n} else {\n  content = (\n    <>\n      {gameIds.length > 0 && (\n        <div>\n          <h2>Select Game:</h2>\n          <GameSelector>{renderGameIds(gameIds, false, false)}</GameSelector>\n        </div>\n      )}\n      <Widget src={challengeWidget} />\n      <Widget src={aiWidget} />\n      {finishedGames.length > 0 && (\n        <div>\n          <h2>Replay your finished games:</h2>\n          <GameSelector>\n            {renderGameIds(finishedGames, true, false)}\n          </GameSelector>\n        </div>\n      )}\n      {recentFinishedGames.length > 0 && (\n        <div>\n          <h2>Replay recently finished games:</h2>\n          <GameSelector>\n            {renderGameIds(recentFinishedGames, true, true)}\n          </GameSelector>\n        </div>\n      )}\n    </>\n  );\n}\nreturn (\n  <LobbyView\n    alignItems={state.game_id || state.replay_game_id ? \"stretch\" : \"center\"}\n  >\n    <Widget src={headerWidget} />\n    {content}\n    <Disclaimer>\n      If you won or lost a game it will no longer be displayed. You can check\n      the most recent transactions status on{\" \"}\n      <a\n        target=\"_blank\"\n        href=\"https://explorer.near.org/accounts/app.chess-game.near\"\n      >\n        Near Explorer\n      </a>{\" \"}\n      or{\" \"}\n      <a\n        target=\"_blank\"\n        href=\"https://nearblocks.io/address/app.chess-game.near\"\n      >\n        Nearblocks\n      </a>\n      .\n    </Disclaimer>\n  </LobbyView>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chess-game.near/widget/ChessGameLobby", "__row_index": 10}