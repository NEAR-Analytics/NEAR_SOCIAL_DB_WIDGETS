{"tx_hash": "CbNFjJsmqm4tbeo6CcWAz8Z189Ekvxs5whoV2Z3t2kuf", "action_id_social": "3PXk5TfyRJFBCpLy7yhNgXVE4goEtBUvNDA6ACGVC6b9-0-widget", "block_id": 94693417, "block_timestamp": "2023-06-21T13:21:52.377Z", "signer_id": "chess-game.near", "widget_name": "ChessGameLobby", "source_code": "const { accountId } = context;\nif (!accountId) {\n  return \"You need to login with your Near wallet first!\";\n}\n\nconst contractId = \"app.chess-game.near\";\nconst chessGameWidget = \"chess-game.near/widget/ChessGame\";\nconst chessGameReplayWidget = \"chess-game.near/widget/ChessGameReplay\";\nconst githubIcon = \"chess-game.near/widget/GithubIcon\";\nconst twitterIcon = \"chess-game.near/widget/TwitterIcon\";\n\nconst LobbyView = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: ${(props) => (props.alignItems ? props.alignItems : \"center\")};\n  max-width: 550px;\n  margin: 0 auto;\n  box-sizing: border-box;\n\n  h1 {\n    align-self: center;\n  }\n\n  > * {\n    margin: 1.2rem 0;\n  }\n`;\nconst Content = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: ${(props) => (props.alignItems ? props.alignItems : \"center\")};\n\n  > * {\n    margin: 0.4rem 0;\n  }\n`;\nconst Button = styled.button`\n  display: flex;\n  flex-direction: column;\n  align-self: ${(props) => (props.alignSelf ? props.alignSelf : \"unset\")};\n  border: 1px solid black;\n  border-radius: 4px;\n  font-size: ${(props) => (props.fontSize ? props.fontSize : \"1rem\")};\n  max-width: 220px;\n\n  > * {\n    max-width: 100%;\n    text-overflow: ellipsis;\n    overflow: hidden;\n  }\n`;\nconst Disclaimer = styled.div`\n  margin-top: 1rem;\n  font-style: italic;\n  font-size: 1.2rem;\n`;\nconst Header = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.6rem;\n\n  a {\n    display: block;\n    align-items: center;\n\tcolor: inherit;\n\ttext-decoration: inherit;\n    font-size: 1.4rem;\n    border-radius: 0.4rem;\n    border: 1px solid lightblue;\n    padding: 0.2rem;\n\n    &:hover {\n      border: 1px solid blue;\n      color: darkblue;\n    }\n  }\n`;\nconst Challenge = styled.div`\n  display: flex;\n`;\n\nconst isRegistered = Near.view(contractId, \"storage_balance_of\", {\n  account_id: accountId,\n});\nconst challenges0 = Near.view(contractId, \"get_challenges\", {\n  account_id: accountId,\n  is_challenger: true,\n});\nconst challenges1 = Near.view(contractId, \"get_challenges\", {\n  account_id: accountId,\n  is_challenger: false,\n});\nconst openChallenges = [\n  ...challenges0.map((id) => ({\n    challenge_id: id,\n    is_challenger: true,\n  })),\n  ...challenges1.map((id) => ({\n    challenge_id: id,\n    is_challenger: false,\n  })),\n];\n\nconst registerAccount = () => {\n  Near.call(\n    contractId,\n    \"storage_deposit\",\n    {},\n    undefined,\n    \"50000000000000000000000\"\n  );\n};\n\nif (!isRegistered) {\n  return (\n    <LobbyView>\n      <h1>Chess On Chain</h1>\n      <Disclaimer>\n        You need to pay storage deposit of 0.05N first before being allowed to\n        play Chess On Chain\n      </Disclaimer>\n      <Button onClick={registerAccount} fontSize=\"1.2rem\">\n        Register Account\n      </Button>\n    </LobbyView>\n  );\n}\n\nconsole.log(\"STATE\", state);\nState.init({\n  game_id: null,\n  replay_game_id: null,\n  challenged_id: \"\",\n  difficulty: \"Easy\",\n});\n\nconst gameIds = Near.view(contractId, \"get_game_ids\", {\n  account_id: accountId,\n});\nconst finishedGames = Near.view(contractId, \"finished_games\", {\n  account_id: accountId,\n}).sort((a, b) => b[0] - a[0]);\nconst recentFinishedGames = Near.view(contractId, \"recent_finished_games\", {});\n\nconst GameSelector = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  align-items: center;\n  justify-content: space-around;\n\n  > * {\n    margin: 1rem;\n  }\n`;\nconst GameCreator = styled.div`\n  margin-top: 2rem;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n\n  > *:not(h2) {\n    margin: 0.2rem 0;\n  }\n\n  h2, h3, h4 {\n    align-self: center;\n  }\n`;\n\nconst selectGame = (gameId, isFinished) => () => {\n  if (isFinished) {\n    State.update({\n      replay_game_id: gameId,\n    });\n  } else {\n    State.update({\n      game_id: gameId,\n    });\n  }\n};\nconst returnToLobby = () => {\n  State.update({\n    game_id: null,\n    replay_game_id: null,\n  });\n};\nconst updateChallengedId = ({ target }) => {\n  State.update({ challenged_id: target.value });\n};\nconst resign = () => {\n  Near.call(contractId, \"resign\", {\n    game_id: state.game_id,\n  });\n};\nconst challenge = () => {\n  Near.call(contractId, \"challenge\", {\n    challenged_id: state.challenged_id,\n  });\n};\nconst createAiGame = () => {\n  Near.call(contractId, \"create_ai_game\", {\n    difficulty: state.difficulty,\n  });\n};\nconst acceptChallenge = (challenge_id) => {\n  Near.call(contractId, \"accept_challenge\", {\n    challenge_id,\n  });\n};\nconst rejectChallenge = (challenge_id, is_challenger) => {\n  Near.call(contractId, \"reject_challenge\", {\n    challenge_id,\n    is_challenger,\n  });\n};\nconst selectDifficulty = (event) => {\n  State.update({\n    difficulty: event.target.value,\n  });\n};\n\nconst renderGameIds = (gameIds, isFinished, displayPlayers) =>\n  gameIds.map((gameId) => {\n    let gameInfo;\n    if (!isFinished) {\n      gameInfo = Near.view(contractId, \"game_info\", {\n        game_id: gameId,\n      });\n    }\n    return (\n      <Button onClick={selectGame(gameId, isFinished)}>\n        <div>ID: {gameId[0]}</div>\n        {displayPlayers && (\n          <>\n            <div>White: {gameId[1]}</div>\n            {gameId[2] && <div>Black: {gameId[2]}</div>}\n          </>\n        )}\n        {gameInfo && <div>VS: AI ({gameInfo.black.Ai})</div>}\n      </Button>\n    );\n  });\n\nconst renderOpenChallenges = (challenges) => {\n  return (\n    <GameSelector>\n      {challenges.map(({ challenge_id, is_challenger }) => {\n        return (\n          <Challenge>\n            <span>{challenge_id}</span>\n            {!is_challenger && (\n              <Button onClick={acceptChallenge(challenge_id)}>Accept</Button>\n            )}\n            <Button onClick={rejectChallenge(challenge_id, is_challenger)}>\n              Reject\n            </Button>\n          </Challenge>\n        );\n      })}\n    </GameSelector>\n  );\n};\n\nlet content;\nif (state.game_id) {\n  content = (\n    <Content alignItems=\"stretch\">\n      <Button alignSelf=\"center\" onClick={returnToLobby}>\n        Return To Lobby\n      </Button>\n      <Button alignSelf=\"center\" onClick={resign}>\n        Resign\n      </Button>\n      <Widget src={chessGameWidget} props={{ game_id: state.game_id }} />\n    </Content>\n  );\n} else if (state.replay_game_id) {\n  content = (\n    <Content alignItems=\"stretch\">\n      <Button alignSelf=\"center\" onClick={returnToLobby}>\n        Return To Lobby\n      </Button>\n      <Widget\n        src={chessGameReplayWidget}\n        props={{ game_id: state.replay_game_id }}\n      />\n    </Content>\n  );\n} else {\n  content = (\n    <>\n      {gameIds.length > 0 && (\n        <div>\n          <h2>Select Game:</h2>\n          <GameSelector>{renderGameIds(gameIds, false, false)}</GameSelector>\n        </div>\n      )}\n      <GameCreator>\n        <h2>PvP:</h2>\n        <h3>Open challenges:</h3>\n        {openChallenges.length === 0 ? (\n          <span>\n            No open challenges found.\n            <br />\n            Challenge your first opponent now below!\n          </span>\n        ) : (\n          renderOpenChallenges(openChallenges)\n        )}\n        <span>Account ID:</span>\n        <input onChange={updateChallengedId} value={state.challenged_id} />\n        <Button onClick={challenge} fontSize=\"1.4rem\">\n          Challenge!\n        </Button>\n      </GameCreator>\n      <GameCreator>\n        <h2>Create New AI Game:</h2>\n        <span>Difficulty:</span>\n        <select onChange={selectDifficulty} value={state.difficulty}>\n          <option value=\"Easy\">Easy</option>\n          <option value=\"Medium\">Medium</option>\n          <option value=\"Hard\">Hard</option>\n        </select>\n        <span>\n          <i>Higher difficulties consume more gas!</i>\n        </span>\n        <Button onClick={createAiGame} fontSize=\"1.4rem\">\n          Create\n        </Button>\n      </GameCreator>\n      {finishedGames.length > 0 && (\n        <div>\n          <h2>Replay your finished games:</h2>\n          <GameSelector>\n            {renderGameIds(finishedGames, true, false)}\n          </GameSelector>\n        </div>\n      )}\n      {recentFinishedGames.length > 0 && (\n        <div>\n          <h2>Replay recently finished games:</h2>\n          <GameSelector>\n            {renderGameIds(recentFinishedGames, true, true)}\n          </GameSelector>\n        </div>\n      )}\n    </>\n  );\n}\n\nreturn (\n  <LobbyView\n    alignItems={state.game_id || state.replay_game_id ? \"stretch\" : \"center\"}\n  >\n    <h1>Chess On Chain</h1>\n    <Header>\n      <a href=\"https://github.com/Tarnadas/chess-on-chain\" target=\"_blank\">\n        <Widget src={githubIcon} props={{ height: \"2rem\" }} />\n        <span>Github</span>\n      </a>\n      <a href=\"https://twitter.com/protocolpawns\" target=\"_blank\">\n        <Widget src={twitterIcon} props={{ height: \"2rem\" }} />\n        <span>Twitter</span>\n      </a>\n    </Header>\n    {content}\n    <Disclaimer>\n      If you won or lost a game it will no longer be displayed. You can check\n      the most recent transactions status on{\" \"}\n      <a\n        target=\"_blank\"\n        href=\"https://explorer.near.org/accounts/app.chess-game.near\"\n      >\n        Near Explorer\n      </a>{\" \"}\n      or{\" \"}\n      <a\n        target=\"_blank\"\n        href=\"https://nearblocks.io/address/app.chess-game.near\"\n      >\n        Nearblocks\n      </a>\n      .\n    </Disclaimer>\n  </LobbyView>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chess-game.near/widget/ChessGameLobby", "__row_index": 3}