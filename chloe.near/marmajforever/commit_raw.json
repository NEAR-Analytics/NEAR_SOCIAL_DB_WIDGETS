{"tx_hash": "6apoDGBTVCaWssMG2stKLGzY9DPyHJiCZjz2P55fL39V", "action_id_social": "ssbjK6H2hrEy5G9aFxoZGaauG1kYG2abwXRZbsTKrWo-0-widget", "block_id": 94337536, "block_timestamp": "2023-06-16T21:09:10.539Z", "signer_id": "chloe.near", "widget_name": "marmajforever", "source_code": "const accountId = props.accountId || context.accountId;\n\nconst GameButton = styled.button`\n  background: palevioletred;\n  color: white;\n  font-size: 1em;\n  margin: 10px;\n  padding: 0.5em 1em;\n  border: 2px solid palevioletred;\n  border-radius: 10px;\n  &:hover {\n    background: white;\n    color: palevioletred;\n  }\n`;\n\nif (!accountId) {\n  return (\n    <div>\n      <p>Please connect your NEAR wallet or create a new one:</p>\n      <a href=\"https://near.org/signup\" target=\"_blank\" rel=\"noreferrer\">\n        <GameButton>Create NEAR Wallet</GameButton>\n      </a>\n    </div>\n  );\n}\n\nconst GameContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n  background: #282c34;\n  color: white;\n  font-size: calc(10px + 2vmin);\n  padding: 20px;\n  box-sizing: border-box;\n`;\n\nconst Title = styled.h1`\n  font-weight: bold;\n  margin-top: 20px; /* Added margin top */\n`;\n\nconst Info = styled.p`\n  margin-top: 10px;\n`;\n\nconst RulesContainer = styled.div`\n  margin-top: 20px;\n  text-align: center;\n`;\n\nfunction initGameState() {\n  return {\n    clickCount: 0,\n    love: 0,\n    bossHP: 100,\n    bossLevel: 1,\n    boostLevel: 1,\n    totalLove: 0,\n    claimLoveCounter: 0,\n    gameStarted: false,\n    startingBlockHeight: 0, // Add startingBlockHeight property\n    highScore: 0, // Add highScore property\n  };\n}\n\nState.init(initGameState());\n\nfunction startGame() {\n  asyncFetch(\"https://rpc.mainnet.near.org/status\").then((res) => {\n    const data = res.body;\n    if (res.ok) {\n      const blockHeight = data.sync_info.latest_block_height;\n      State.update({\n        ...initGameState(),\n        blockHeight: blockHeight,\n        startingBlockHeight: blockHeight, // Set starting block height\n        gameStarted: true,\n      });\n    } else {\n      console.error(\"Error fetching data: \", data.error);\n    }\n  });\n}\n\nfunction claimLove() {\n  const oldBlockHeight = state.blockHeight;\n  const oldLove = state.love;\n  const boostLevel = state.boostLevel;\n  let totalLove = state.totalLove;\n  let claimLoveCounter = state.claimLoveCounter;\n\n  asyncFetch(\"https://rpc.mainnet.near.org/status\").then((res) => {\n    const data = res.body;\n    if (res.ok) {\n      const newBlockHeight = data.sync_info.latest_block_height;\n      if (newBlockHeight > oldBlockHeight) {\n        const blockDifference = newBlockHeight - oldBlockHeight;\n        const love = oldLove + blockDifference * boostLevel; // Increase love based on block difference * boost level\n\n        // Update totalLove\n        totalLove += blockDifference * boostLevel;\n        claimLoveCounter++;\n\n        State.update({\n          blockHeight: newBlockHeight,\n          love: love,\n          totalLove: totalLove,\n          claimLoveCounter: claimLoveCounter,\n        });\n      } else {\n        State.update({ blockHeight: newBlockHeight });\n      }\n    } else {\n      console.error(\"Error fetching data: \", data.error);\n    }\n  });\n}\n\nfunction newGame() {\n  const score = calculateScore(); // Calculate the current score\n  const previousHighScore = state.highScore || 0; // Retrieve the previous high score from state\n\n  // Update the game state and include the high score\n  State.update({\n    ...initGameState(),\n    highScore: Math.max(score, previousHighScore), // Save the higher score between the current and previous high scores\n  });\n}\n\nfunction spreadLove() {\n  const love = state.totalLove; // Use totalLove to spread love\n  let bossHP = state.bossHP;\n  let bossLevel = state.bossLevel;\n  const clickCount = state.clickCount + 1;\n\n  bossHP -= love; // Decrease boss HP by love value\n\n  if (bossHP <= 0) {\n    bossLevel++;\n    bossHP = 100 * bossLevel + clickCount * 2;\n  }\n\n  const difference = state.love - state.totalLove; // Calculate the difference between love and totalLove\n  const totalLove = difference > 0 ? state.totalLove + difference : 0; // Add the difference back to totalLove (minimum 0)\n\n  State.update({\n    bossHP: bossHP,\n    bossLevel: bossLevel,\n    clickCount: clickCount,\n    totalLove: totalLove, // Update totalLove with the new value\n    love: 0, // Reset love to 0\n    claimLoveCounter: 0, // Reset claimLoveCounter to 0\n  });\n}\n\nfunction boostLove() {\n  const clickCount = state.clickCount + 1;\n  const updatedLove = state.love * clickCount;\n  const updatedBoostLevel = state.boostLevel + 1;\n\n  State.update({\n    love: updatedLove,\n    boostLevel: updatedBoostLevel,\n    clickCount: clickCount,\n  });\n}\n\nfunction calculateScore() {\n  if (state.gameStarted) {\n    const { bossLevel, startingBlockHeight, blockHeight } = state;\n    const blockDifference = blockHeight - startingBlockHeight;\n    if (blockDifference <= 0) {\n      return 0; // Return 0 if no or negative block difference\n    }\n    const previousScore = state.score || 0; // Retrieve the previous score from state\n    const score = previousScore + bossLevel * blockDifference;\n    return Math.max(score, 0); // Return the score or 0 (whichever is higher)\n  } else {\n    return 0; // Return 0 if the game hasn't started yet\n  }\n}\n\nreturn (\n  <GameContainer>\n    <Title>Marma J Forever!</Title>\n    {!state.gameStarted && (\n      <div>\n        <Info>Player ID: {accountId}</Info> {/* Display Player ID */}\n        <div>High Score: {state.highScore}</div> {/* Display High Score */}\n        <GameButton onClick={startGame}>Start Game</GameButton>\n      </div>\n    )}\n    {state.gameStarted && (\n      <div>\n        <div\n          style={{\n            display: \"flex\",\n            justifyContent: \"space-between\",\n            marginBottom: \"20px\",\n            width: \"100%\",\n          }}\n        >\n          <div>\n            <Info>Total Love: {state.totalLove}</Info>\n            <Info>Boost Level: {state.boostLevel}</Info>{\" \"}\n            {/* Display Boost Level */}\n            <GameButton onClick={claimLove}>Claim Love</GameButton>\n            <GameButton onClick={boostLove}>Boost Love</GameButton>\n          </div>\n          <div\n            style={{\n              display: \"flex\",\n              flexDirection: \"column\",\n              alignItems: \"flex-end\",\n            }}\n          >\n            <Info>Boss Level: {state.bossLevel}</Info>{\" \"}\n            {/* Display Boss Level */}\n            <Info>Boss HP: {state.bossHP}</Info> {/* Display Boss HP */}\n            <GameButton\n              onClick={state.claimLoveCounter > 0 ? spreadLove : undefined}\n              disabled={state.claimLoveCounter === 0}\n              style={{\n                backgroundColor:\n                  state.claimLoveCounter === 0 ? \"grey\" : \"palevioletred\",\n              }}\n            >\n              {state.claimLoveCounter > 0 ? \"Spread Love\" : \"Claim Love First\"}\n            </GameButton>\n          </div>\n        </div>\n        <RulesContainer>\n          <p>\n            <Info>Player ID: {accountId}</Info> {/* Display Player ID */}\n          </p>\n          <ol>\n            <li>Claim Love</li>\n            <li>Spread it to attack the boss</li>\n            <li>Boost to generate love faster</li>\n            <li>New Game to reset</li>\n          </ol>\n        </RulesContainer>\n        <GameButton onClick={newGame}>New Game</GameButton>\n        <div>Current Score: {calculateScore()}</div>{\" \"}\n        {/* Display Current Score */}\n      </div>\n    )}\n  </GameContainer>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chloe.near/widget/marmajforever", "__row_index": 5}