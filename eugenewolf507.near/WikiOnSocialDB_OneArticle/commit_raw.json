{"tx_hash": "BnYkAy3YMvhpSb3dy348FhwuwunGB69yYTfTxrniLoMf", "action_id_social": "8NoKWpgxUG9s6huDyYoyf4uNJRk81JWhqmWp35PtyMYZ-0-widget", "block_id": 85434283, "block_timestamp": "2023-02-17 14:48:32.851", "signer_id": "eugenewolf507.near", "widget_name": "WikiOnSocialDB_OneArticle", "source_code": "const addressForArticles = \"wikiTest2Article\";\nconst authorForWidget = \"eugenewolf507.near\";\nconst { articleId, blockHeight, lastEditor } = props;\n\n// === *** NEW DATA BASE *** ===\nconst getNewDBHandler = (e) => {\n  const lastEditor = \"eugenewolf507.near\",\n    blockHeight = 85380376;\n  // blockHeight = 85347668;\n\n  const article = Social.get(\n    `${lastEditor}/${addressForArticles}/main`,\n    blockHeight\n  );\n\n  console.log(JSON.parse(article));\n};\n\nState.init({});\n\n// const allArticlesWithOneID = Social.get(\n//   `*/${addressForArticles}/articles/${articleId}/*`,\n//   \"final\"\n// );\n// const articlesArr = allArticlesWithOneID && Object.values(allArticlesWithOneID);\n// const resultArticlesWithOneId =\n//   articlesArr &&\n//   articlesArr.reduce(\n//     (acc, account) =>\n//       acc.concat(Object.values(account[addressForArticles].articles)),\n//     []\n//   );\n\n// resultArticlesWithOneId.length &&\n//   resultArticlesWithOneId.sort((a, b) => {\n//     return Number(b.timeLastEdit) - Number(a.timeLastEdit);\n//   });\n\n// const article = resultArticlesWithOneId[0];\n\nconst article = JSON.parse(\n  Social.get(`${lastEditor}/${addressForArticles}/main`, blockHeight)\n);\n\nState.update({ article });\n\nconst getDate = (timestamp) => {\n  const date = new Date(Number(timestamp));\n  return date.toDateString();\n};\n\nconst saveArticle = (args) => {\n  const newArticleData = {\n    ...state.article,\n    body: state.note,\n    lastEditor: accountId,\n    timeLastEdit: Date.now(),\n    version: Number(state.article.version) + 1,\n  };\n  Social.set({\n    [addressForArticles]: {\n      articles: { [state.article.articleId]: { ...newArticleData } },\n    },\n  });\n};\n\nreturn (\n  <>\n    {/* === *** NEW DATA BASE *** === */}\n    <button onClick={getNewDBHandler}>GET Data - delete this button</button>\n    {/* === *** NEW DATA BASE *** === */}\n    <Widget\n      src={`${authorForWidget}/widget/WikiOnSocialDB_MainNavigation`}\n      props={{ currentNavPill: \"articles\" }}\n    />\n    <div>\n      <h4>Article: {state.article.articleId}</h4>\n      <button\n        onClick={() => {\n          State.update({\n            ...state,\n            editArticle: true,\n            note: state.article.body,\n          });\n        }}\n      >\n        Edit Article\n      </button>\n      {/* === EDIT ARTICLE === */}\n      {state.editArticle && (\n        <>\n          <button\n            type=\"button\"\n            className=\"btn btn-success\"\n            onClick={() => {\n              if (!state.note || article.body === state.note) return;\n\n              const args = {\n                article_id: state?.articleId,\n                body: state.note,\n                navigation_id: null,\n              };\n\n              saveArticle(args);\n            }}\n          >\n            Save Article{\" \"}\n          </button>\n\n          <button\n            type=\"button\"\n            className=\"btn btn-danger\"\n            onClick={() => {\n              State.update({\n                ...state,\n                editArticle: false,\n                note: undefined,\n              });\n            }}\n          >\n            Cancel{\" \"}\n          </button>\n          <div className=\"d-flex gap-2\" style={{ minHeight: \"300px\" }}>\n            <div className=\"w-50\">\n              <Widget\n                src=\"mob.near/widget/MarkdownEditorIframe\"\n                props={{\n                  initialText: state.article.body,\n                  onChange: (note) => State.update({ note }),\n                }}\n              />\n            </div>\n            <div className=\"w-50\">\n              <Widget\n                src=\"mob.near/widget/SocialMarkdown\"\n                props={{ text: state.note }}\n              />\n            </div>\n          </div>\n        </>\n      )}\n      {!state.editArticle && (\n        <Markdown text={state.note || state.article.body} />\n      )}\n      <div className=\"mt-5 alert alert-secondary\">\n        <div>\n          Created by{\" \"}\n          <a\n            href={`https://near.social/#/mob.near/widget/ProfilePage?accountId=${state.article.author}`}\n            target=\"_blank\"\n            style={{ textDecoration: \"underline\" }}\n          >\n            {state.article.author}\n          </a>\n          {/* \n          TODO: add lastEditor to edit and create widgets\n          <br />\n          Last edit by{\" \"}\n          <a\n            href={`https://near.social/#/mob.near/widget/ProfilePage?accountId=${state.article.lastEditor}`}\n            style={{ textDecoration: \"underline\" }}\n          >\n            {state.article.lastEditor}\n          </a>*/}\n          <br />\n          Edited on {getDate(state.article.timeLastEdit)}\n          <br />\n          Edit versions: {state.article.version}\n        </div>\n      </div>\n    </div>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/eugenewolf507.near/widget/WikiOnSocialDB_OneArticle"}