{"tx_hash": "5eVCobYG6JtBQNW3Z8bF8vcEUU2n6GR6Avq7kaZGimeQ", "action_id_social": "2VMnPi673VWFeMr77htuNxEQvbjnoD7oBApoVPxRih9E-0-widget", "block_id": 90513349, "block_timestamp": "2023-04-27 01:14:21.228", "signer_id": "frichard5.near", "widget_name": "proposals", "source_code": "const widgetProvider = props.widgetProvider;\nconst account = props.account || \"marketing.sputnik-dao.near\";\nconst ftList = props.ftList;\nconst apiUrl = `https://api.pikespeak.ai/daos/proposals`;\nconst apiPolicyUrl = `https://api.pikespeak.ai/daos/policy`;\nconst publicApiKey = \"36f2b87a-7ee6-40d8-80b9-5e68e587a5b5\";\nconst daosList = [\n  \"marketing.sputnik-dao.near\",\n  \"creativesdao.sputnik-dao.near\",\n  \"neardevgov.sputnik-dao.near\",\n];\n\nconst forgeUrl = (apiUrl, params) =>\n  apiUrl +\n  Object.keys(params).reduce(\n    (paramString, p) => paramString + `${p}=${params[p]}&`,\n    \"?\"\n  );\n\nconst ProposalContainer = styled.div`\n  margin-top: 40px;\n  min-height: 500px;\n`;\n\nconst NoProposal = styled.div`\n  text-align: center;\n  margin-top: 100px;\n`;\n\nconst resPerPage = 10;\n\nState.init({\n  offset: 0,\n  lastProposalFetch: [],\n  proposals: [],\n  isLoading: false,\n  types: [],\n  account: account,\n  status: [],\n  fromDate: \"\",\n  toDate: \"\",\n  daos: [account],\n});\n\nconst columns = [\n  {\n    id: \"submission_time\",\n    label: \"Submission time\",\n  },\n  {\n    id: \"proposal_id\",\n    label: \"Proposal Id\",\n  },\n  {\n    id: \"status\",\n    label: \"Status\",\n  },\n  {\n    id: \"proposal_type\",\n    label: \"type\",\n  },\n];\n\nconst nextPage = () => {\n  State.update({ offset: state.offset + resPerPage });\n};\n\nconst previousPage = () => {\n  State.update({ offset: state.offset - resPerPage });\n};\n\nconst GenericTable = (\n  <Widget\n    src={`${widgetProvider}/widget/generic_table`}\n    props={{\n      title: `${account} proposals`,\n      columns,\n      data: state.proposals,\n      nextPage,\n      previousPage,\n      offset: state.offset,\n      resPerPage,\n    }}\n  />\n);\n\nconst fetchPolicy = (params) => {\n  asyncFetch(forgeUrl(apiPolicyUrl, params), {\n    mode: \"cors\",\n    headers: {\n      \"x-api-key\": publicApiKey,\n    },\n  }).then(({ err, body, ok }) => {\n    if (ok) {\n      State.update({\n        policy: body,\n      });\n    }\n  });\n};\n\nconst fetchProposal = (params) => {\n  asyncFetch(forgeUrl(apiUrl, params), {\n    mode: \"cors\",\n    headers: {\n      \"x-api-key\": publicApiKey,\n    },\n  }).then(({ err, body, ok }) => {\n    if (ok) {\n      const allProposals = [...state.proposals, ...body];\n      State.update({\n        lastProposalFetch: body,\n        proposals: allProposals,\n        isLoading: false,\n      });\n    }\n  });\n};\n\nif (!state.proposals.length) {\n  fetchProposal({\n    limit: resPerPage,\n    offset: 0,\n    proposal_types: state.types,\n    status: state.status,\n    time_start: state.fromDate,\n    time_end: state.toDate,\n    daos: state.daos,\n  });\n  fetchPolicy({ daos: daosList });\n}\nif (state.account != account) {\n  State.update({ proposals: [], account, offset: 0, daos: [account] });\n}\n\nconst fetchMore = () => {\n  if (!state.isLoading) {\n    State.update({ offset: state.offset + resPerPage, isLoading: true });\n    fetchProposal({\n      limit: resPerPage,\n      offset: state.offset,\n      proposal_types: state.types,\n      status: state.status,\n      time_start: state.fromDate,\n      time_end: state.toDate,\n      daos: state.daos,\n    });\n  }\n};\n\nconst ProposalCards = [];\n\nstate.proposals.forEach((proposal) => {\n  ProposalCards.push(\n    <Widget\n      src={`${widgetProvider}/widget/NDC-proposal-card`}\n      props={{\n        proposal,\n        widgetProvider,\n        ftList,\n        council: state.policy\n          .filter((pol) => pol.dao_id === proposal.dao_id)\n          .map((pol) => {\n            return pol.state.policy.roles.find(\n              (r) => r.name === \"Council\" || r.name === \"council\"\n            ).kind;\n          })[0],\n      }}\n    />\n  );\n});\n\nconst selectType = (types) => {\n  State.update({\n    proposals: [],\n    offset: 0,\n    types: types,\n  });\n};\n\nconst typeOptions = [\n  \"Transfer\",\n  \"Vote\",\n  \"FunctionCall\",\n  \"AddBounty\",\n  \"BountyDone\",\n  \"AddMemberToRole\",\n  \"RemoveMemberFromRole\",\n  \"ChangeConfig\",\n  \"ChangePolicy\",\n  \"ChangePolicyUpdateParameters\",\n  \"ChangePolicyUpdateDefaultVotePolicy\",\n  \"ChangePolicyRemoveRole\",\n  \"ChangePolicyAddOrUpdateRole\",\n  \"FactoryInfoUpdate\",\n  \"SetStakingContract\",\n  \"UpgradeRemote\",\n  \"UpgradeSelf\",\n].map((t) => {\n  return {\n    value: t,\n    label: t,\n  };\n});\nconst SelectType = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-checkbox-list`}\n    props={{\n      widgetProvider,\n      checkboxes: typeOptions,\n      selectedBoxes: state.types,\n      onChange: selectType,\n      label: \"Type\",\n      id: \"proposal-type-selector\",\n    }}\n  />\n);\n\nconst selectStatus = (status) => {\n  State.update({\n    status,\n    proposals: [],\n    offset: 0,\n  });\n};\n\nconst selectDaos = (daos) => {\n  State.update({\n    daos,\n    proposals: [],\n    offset: 0,\n  });\n};\n\nconst statusOptions = [\"Approved\", \"Rejected\", \"InProgress\", \"Expired\"].map(\n  (t) => {\n    return {\n      value: t,\n      label: t,\n    };\n  }\n);\n\nconst SelectStatus = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-checkbox-list`}\n    props={{\n      widgetProvider,\n      checkboxes: statusOptions,\n      selectedBoxes: state.status,\n      onChange: selectStatus,\n      label: \"Status\",\n      id: \"proposal-status-selector\",\n    }}\n  />\n);\n\nconst daosOptions = daosList.map((t) => {\n  return {\n    value: t,\n    label: t.split(\".\")[0],\n  };\n});\n\nconst SelectDaos = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-checkbox-list`}\n    props={{\n      widgetProvider,\n      checkboxes: daosOptions,\n      selectedBoxes: state.daos,\n      onChange: selectDaos,\n      label: \"Daos\",\n      id: \"proposal-daos-selector\",\n    }}\n  />\n);\n\nconst SelectFromDate = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-input`}\n    props={{\n      widgetProvider,\n      validate: \"date\",\n      sendInput: (fromDate) => {\n        State.update({\n          fromDate,\n          proposals: [],\n          offset: 0,\n        });\n      },\n      placeholder: \"yyyy/mm/dd\",\n      label: \"From Date\",\n    }}\n  />\n);\nconst SelectToDate = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-input`}\n    props={{\n      widgetProvider,\n      validate: \"date\",\n      sendInput: (toDate) => {\n        State.update({\n          toDate,\n          proposals: [],\n          offset: 0,\n        });\n      },\n      placeholder: \"yyyy/mm/dd\",\n      label: \"To Date\",\n    }}\n  />\n);\n\nconst ProposalInfiniteScroll = (\n  <Widget\n    src={`${widgetProvider}/widget/proposals_scroll`}\n    props={{\n      cards: ProposalCards,\n      fetchMore: fetchMore,\n      hasMore: state.lastProposalFetch.length === resPerPage,\n    }}\n  />\n);\n\nconst getFilters = () => {\n  let filters = [...state.status, ...state.types, ...state.daos];\n  if (state.fromDate.length) {\n    filters.push(`From: ${state.fromDate}`);\n  }\n  if (state.toDate.length) {\n    filters.push(`From: ${state.toDate}`);\n  }\n  return filters;\n};\n\nconst ProposalFilters = (\n  <Widget\n    src={`${widgetProvider}/widget/NDC-filter-menu`}\n    props={{\n      widgetProvider,\n      comps: [\n        SelectDaos,\n        SelectType,\n        SelectStatus,\n        SelectFromDate,\n        SelectToDate,\n      ],\n      filters: getFilters(),\n      removeFilter: (filter) => {\n        State.update({\n          types: [...state.types.filter((t) => t != filter)],\n          status: [...state.status.filter((s) => s != filter)],\n          daos: [...state.daos.filter((d) => d != filter)],\n          fromDate: filter.includes(state.fromDate) ? \"\" : state.fromDate,\n          proposals: [],\n          offset: 0,\n          limit: resPerPage,\n        });\n      },\n      resetFilters: () => {\n        State.update({\n          types: [],\n          status: [],\n          proposals: [],\n          offset: 0,\n          daos: [state.account],\n          limit: resPerPage,\n        });\n      },\n    }}\n  />\n);\n\nreturn (\n  <ProposalContainer>\n    {ProposalFilters}\n    {state.proposals.length ? (\n      ProposalInfiniteScroll\n    ) : (\n      <NoProposal>No proposal found.</NoProposal>\n    )}\n  </ProposalContainer>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/frichard5.near/widget/proposals"}