{"tx_hash": "FX6RcAj86hvmv9sKwDYmv1ZDxszonixrNWQXk8shua9", "action_id_social": "AzD42YQQ4FNCew4CWHLyXrK8tFeLMA1KhQASidnm1Ydb-0-widget", "block_id": 80801991, "block_timestamp": "2022-12-16 20:15:33.342", "signer_id": "wendersonpires.near", "widget_name": "Chat", "source_code": "// INITIAL STATE\nState.init({\n  roomId: props.room_id || \"\",\n  roomIdToJoin: \"\",\n  input: \"\",\n  errorMessage: \"\",\n});\n\n// UTILS\n// Gen UUID - Source => https://stackoverflow.com/questions/105034/how-do-i-create-a-guid-uuid\nconst uuidv4 = () => {\n  var u = \"\",\n    i = 0;\n  while (i++ < 36) {\n    var c = \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\"[i - 1],\n      r = (Math.random() * 16) | 0,\n      v = c == \"x\" ? r : (r & 0x3) | 0x8;\n    u += c == \"-\" || c == \"4\" ? c : v.toString(16);\n  }\n  return u;\n};\n\n// APP\nconst accountId = props.accountId ?? context.accountId ?? \"*\";\n\nconst profileInfo = props.profile ?? Social.getr(`${accountId}/profile`);\n\n// Room Creator Screen\nconst joinRoom = (roomIdInfo) => {\n  // This method gets only data inside stored on my user\n  // const roomInfo = Social.get(`${accountId}/index/${roomIdInfo}`);\n\n  const roomInfo = Social.index(roomIdInfo, \"data\");\n  const roomExists = roomInfo && roomInfo.length > 0;\n\n  if (!roomExists) {\n    // Update error state\n    State.update({\n      errorMessage:\n        \"This room was not found right now! It can be a blockchain delay, so, you can try again!\",\n    });\n    return;\n  }\n\n  // Set room id and go ahead\n  State.update({ roomId: roomIdInfo });\n};\n\nconst createAndJoinNewRoom = () => {\n  // Set the new Room Id and go ahead\n  State.update({ roomId: uuidv4() });\n};\n\nif (!state.roomId) {\n  return (\n    <>\n      <div>\n        <h3>Chat Widget v1.0.0</h3>\n        <p>\n          You can join a room or create a new room and invite your friends. You\n          can also enter a room directly by passing the parameter{\" \"}\n          <strong>room_id</strong> in the url or as component props. <br />\n          <br />\n          Example:{\" \"}\n          <a\n            href=\"https://near.social/#/wendersonpires.near/widget/Chat?room_id=9df2f348-9924-415f-921c-db2b846e7177\"\n            target=\"_blank\"\n          >\n            https://near.social/#/wendersonpires.near/widget/Chat?room_id=9df2f348-9924-415f-921c-db2b846e7177\n          </a>\n        </p>\n        <div\n          style={{\n            display: \"flex\",\n            flexDirection: \"column\",\n            marginTop: 32,\n          }}\n        >\n          <p style={{ marginBottom: 8 }}>\n            <strong>Join an existing room:</strong>\n          </p>\n          <div style={{ display: \"flex\", justifyContent: \"space-between\" }}>\n            <input\n              placeholder=\"Room ID\"\n              style={{ marginBottom: 8, width: \"70%\" }}\n              onChange={(e) => {\n                State.update({\n                  roomIdToJoin: e.target.value,\n                  errorMessage: \"\",\n                });\n              }}\n            />\n            <button\n              type=\"button\"\n              class=\"btn btn-primary\"\n              role=\"button\"\n              style={{ height: 38, width: \"25%\" }}\n              onClick={() => joinRoom(state.roomIdToJoin)}\n            >\n              Join Room\n            </button>\n          </div>\n          <button\n            type=\"button\"\n            class=\"btn btn-primary\"\n            role=\"button\"\n            style={{ marginTop: 8 }}\n            onClick={createAndJoinNewRoom}\n          >\n            Create and Join New Room\n          </button>\n        </div>\n      </div>\n      {state.errorMessage && (\n        <div class=\"alert alert-warning\" role=\"alert\" style={{ marginTop: 28 }}>\n          {state.errorMessage}\n        </div>\n      )}\n    </>\n  );\n}\n\n// Chat Room Screen\nconst data = Social.index(state.roomId, \"data\", {\n  subscribe: true,\n  limit: 100,\n  order: \"desc\",\n});\n\nif (!data) {\n  return \"Loading...\";\n}\n\n// Last messages on the bottom\nconst sortedData = data.sort((d1, d2) => d1.blockHeight - d2.blockHeight);\n\nconst buildMessage = (messageData) => {\n  return {\n    user: messageData.accountId,\n    userName: messageData.value.userName,\n    userAvatarImage: messageData.value.userAvatarImage,\n    message: messageData.value.text,\n  };\n};\n\nconst getChatHistory = (indexData) => {\n  const chatHistory = [];\n  indexData.forEach((item) => {\n    chatHistory.push(buildMessage(item));\n  });\n  return chatHistory;\n};\n\nconst chatHistory = getChatHistory(sortedData);\n\n// Final image Format\n// https://ipfs.near.social/ipfs/bafkreiau7fpuwxtiieevs5zk46mhouqqig6sqbyplt5p2kzpe24yrdw2ki\n// Thumbnail image Format\n// https://i.near.social/thumbnail/https://ipfs.near.social/ipfs/bafkreiau7fpuwxtiieevs5zk46mhouqqig6sqbyplt5p2kzpe24yrdw2ki\n\nconst onChangeMessage = (message) => {\n  State.update({\n    input: message,\n  });\n};\n\nconst leaveRoomHandler = () => {\n  State.update({ roomId: \"\", errorMessage: \"\" });\n};\n\nreturn (\n  <>\n    <div\n      style={{\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"space-between\",\n      }}\n    >\n      <div>\n        <h4>Chat Widget</h4>\n        <p style={{ marginBottom: 0 }}>\n          <strong>Room ID:</strong> {state.roomId}\n        </p>\n        <p style={{ marginTop: 0 }}>\n          <strong>Connectd as:</strong> {profileInfo.name}\n        </p>\n      </div>\n      <button type=\"button\" class=\"btn btn-danger\" onClick={leaveRoomHandler}>\n        Leave Room\n      </button>\n    </div>\n    <div\n      className=\"mb-2 mt-2\"\n      style={{\n        background: \"#F8F9FA\",\n        padding: 8,\n        maxHeight: 500,\n        overflowX: \"scroll\",\n      }}\n    >\n      {chatHistory.map((chatItem, index) => {\n        return (\n          <div\n            style={{\n              display: \"flex\",\n              alignItems: \"center\",\n              marginTop: index !== 0 ? 8 : 0,\n            }}\n          >\n            <div\n              style={{\n                width: 50,\n                height: 50,\n                borderRadius: 999,\n                backgroundImage: `url(https://i.near.social/thumbnail/https://ipfs.near.social/ipfs/${chatItem.userAvatarImage})`,\n                backgroundPosition: \"center\",\n                backgroundSize: \"cover\",\n              }}\n            />\n            <p style={{ margin: 0, marginLeft: 12 }}>\n              <strong style={{ color: \"#212121\" }}>\n                {chatItem.userName || chatItem.user}:\n              </strong>\n            </p>\n            <p style={{ margin: 0, marginLeft: 6 }}>{chatItem.message}</p>\n          </div>\n        );\n      })}\n\n      {chatHistory.length === 0 && <p>No message was sent yet :D</p>}\n    </div>\n    <textarea\n      type=\"text\"\n      rows={1}\n      className=\"form-control\"\n      placeholder=\"Message\"\n      value={state.input}\n      onChange={(e) => onChangeMessage(e.target.value)}\n    />\n    <br />\n    <CommitButton\n      data={{\n        index: {\n          [state.roomId]: JSON.stringify(\n            {\n              key: \"data\",\n              value: {\n                userName: profileInfo.name,\n                userAvatarImage: profileInfo.image.ipfs_cid,\n                text: state.input,\n              },\n            },\n            undefined,\n            0\n          ),\n        },\n      }}\n      onCommit={() => {\n        State.update({ input: \"\" });\n      }}\n    >\n      Send Message\n    </CommitButton>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/wendersonpires.near/widget/Chat"}