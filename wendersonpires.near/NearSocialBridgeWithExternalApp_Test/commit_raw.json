{"tx_hash": "4XkWckJ8HBDNHcUSZG2LLmfHMf1ZwxQD2upAJjUAedZ4", "action_id_social": "CQsjARdQvB9TVcX8XAUexQUNTEy1DVDArnAqCQgY2Xfv-0-widget", "block_id": 88446897, "block_timestamp": "2023-03-30 15:49:47.297", "signer_id": "wendersonpires.near", "widget_name": "NearSocialBridgeWithExternalApp_Test", "source_code": "// Crucial checks\nif (!props.externalAppUrl) {\n  return (\n    <p style={{ fontWeight: 600, color: \"#AB2E28\", fontFamily: \"Courier new\" }}>\n      Error: \"externalAppUrl\" prop must be provided\n    </p>\n  );\n}\n\n/**\n * Load React, React Dom and the Core Bridge library\n *\n * It's recommended to use VSCode to edit this code.\n * Save this code in the core.js file as well.\n */\nconst code = `\n<script src=\"https://unpkg.com/react@18/umd/react.development.js\" crossorigin></script>\n<script src=\"https://unpkg.com/react-dom@18/umd/react-dom.development.js\" crossorigin></script>\n<div id=\"bridge-root\"></div>\n<script>\n// Viewer port\nlet viewerPort\n\n// Outside of the component state controller\nlet state = {\n  externalAppUrl: '',\n  initialPath: null,\n  iframeHeight: 480,\n  userInfo: null,\n  initialPayload: {},\n  connectMessageSent: false,\n}\n\n// Core Component\nfunction NearSocialBridgeCore() {\n  const [externalAppUrl, setExternalAppUrl] = React.useState(state.externalAppUrl)\n  const [connectMessageSent, setConnectMessageSent] = React.useState(state.connectMessageSent)\n  const [iframeHeight, setIframeHeight] = React.useState(state.iframeHeight)\n  const [, setUserInfo] = React.useState(state.userInfo)\n\n  React.useEffect(() => {\n    const handler = (e) => {\n      // Set the Viewer port\n      if (!viewerPort && e.data.type === 'connect-view') {\n        viewerPort = e.source\n        setExternalAppUrl(e.data.externalAppUrl)\n        setIframeHeight(e.data.initialIframeHeight || 480)\n        setUserInfo(e.data.userInfo)\n        state.externalAppUrl = e.data.externalAppUrl\n        state.initialPath = e.data.initialPath\n        state.userInfo = e.data.userInfo\n        state.initialPayload = e.data.initialPayload\n        state.iframeHeight = e.data.initialIframeHeight || 480\n      }\n\n      // When get a message from the View\n      if (viewerPort && e.data.from === 'view') {\n        // Is it message to the core?\n        if (e.data.type.includes('core:')) {\n          // process eventual message to core here\n          return\n        }\n\n        // Send to external app\n        sendMessage(e.data)\n      }\n    }\n\n    window.addEventListener('message', handler)\n\n    return () => {\n      window.removeEventListener('message', handler)\n    }\n  }, [])\n\n  const sendMessage = (message) => {\n    var iframe = document.getElementById('myIframe')\n    iframe.contentWindow.postMessage(message, '*')\n  }\n\n  const sendMessageToView = (message) => {\n    viewerPort.postMessage(message, '*')\n  }\n\n  // Answer Factory\n  const buildAnswer = (requestType, payload) => {\n    return {\n      from: 'core',\n      type: 'answer',\n      requestType,\n      payload,\n    }\n  }\n\n  // Build connection payload\n  const buildConnectionPayload = () => ({\n    type: 'connect',\n    payload: {\n      userInfo: state.userInfo,\n      initialPath: state.initialPath,\n      initialPayload: state.initialPayload,\n    },\n    created_at: Date.now(),\n  })\n\n  const onMessageHandler = (message) => {\n    // Internal Request Handler\n    if (message.data.from === 'external-app') {\n      // Send to View\n      sendMessageToView(message.data)\n\n      // core.js - internal handlers\n      switch (message.data.type) {\n        case 'nsb:navigation:sync-content-height':\n          syncContentHeight(message.data.type, message.data.payload)\n          break\n      }\n    }\n  }\n\n  const syncContentHeight = (requestType, payload) => {\n    if (payload.height) {\n      setIframeHeight(payload.height)\n      state.iframeHeight = payload.height\n    }\n\n    const responseBody = buildAnswer(requestType)\n    sendMessage(responseBody)\n  }\n\n  function onLoadHandler() {\n    // On load iframe\n    if (!connectMessageSent) {\n      setConnectMessageSent(true)\n      state.connectMessageSent = true\n\n      // On get msg from External App\n      window.addEventListener('message', onMessageHandler, false)\n    }\n\n    // Send the welcome message (connects with the external app)\n    const welcomePayload = buildConnectionPayload()\n    sendMessage(welcomePayload)\n\n    // Wait a bit and send the message again to ensure the app and scripts are loaded and ready\n    setTimeout(() => {\n      sendMessage(buildConnectionPayload())\n    }, 2000)\n  }\n\n  // Wait for the external app url to render the iframe\n  if (!state.externalAppUrl) return null\n\n  return React.createElement('iframe', {\n    sandbox: 'allow-scripts allow-popups-to-escape-sandbox allow-popups',\n    id: 'myIframe',\n    src: externalAppUrl,\n    style: { border: 'none', width: '100%', height: iframeHeight + 'px', margin: 0, padding: 0 },\n    onLoad: onLoadHandler,\n  })\n}\n\nconst domContainer = document.querySelector('#bridge-root')\nconst root = ReactDOM.createRoot(domContainer)\nroot.render(React.createElement(NearSocialBridgeCore, {}))\n\n</script>\n`;\n\n// (i) Discovery API uses cached data structure\nconst Utils = {\n  /**\n   * Send message\n   */\n  sendMessage: (message) => {\n    State.update({\n      currentMessage: message,\n    });\n  },\n  /**\n   * Call resolve or reject for a given caller\n   * E.g:\n   * Utils.promisify(() => getCachedObject(), (res) => console.log(res), (err) => console.log(err))\n   */\n  promisify: (caller, resolve, reject) => {\n    const timer = 1000;\n    const timeout = timer * 10;\n    let timeoutCheck = 0;\n\n    const find = () => {\n      const response = caller();\n      if (response) {\n        resolve(response);\n      } else {\n        if (timeoutCheck < timeout) {\n          // try again\n          setTimeout(find, 1000);\n          timeoutCheck += timer;\n        } else {\n          reject(null);\n        }\n      }\n    };\n\n    // Fist attempt\n    find();\n  },\n};\n\n// External App Url\nconst externalAppUrl = props.externalAppUrl;\n\n// User Info\nconst accountId = context.accountId;\nconst userInfo = { accountId };\n\n// Initial Path\nconst initialPath = props.path;\n\n// Initial iframe height\nconst initialIframeHeight = props.initialViewHeight || 500;\n\n// Initial Payload (optional)\nconst initialPayload = props.initialPayload || {};\n\n// Initial State\nState.init({\n  iframeHeight: initialIframeHeight,\n  // (i) DON'T send async data, it's going to randonly fail\n  // If you need to get new info, use \"request\" for that\n  currentMessage: {\n    type: \"connect-view\",\n    externalAppUrl,\n    userInfo,\n    initialPath,\n    initialPayload,\n    initialIframeHeight,\n  },\n});\n\n// Answer Factory\nconst buildAnswer = (requestType, payload) => {\n  return {\n    from: \"view\",\n    type: \"answer\",\n    requestType,\n    payload,\n    created_at: Date.now(),\n  };\n};\n\n/**\n * Widget response factory - closure\n *\n * E.g:\n * const response = responseFactory.build()\n * response({type: 'request-type'}).send({myPayloadHere: 123})\n */\nconst responseFactory = {\n  build: () => {\n    return (request) => {\n      return {\n        send: (payload) => {\n          const responseBody = buildAnswer(request.type, payload);\n          Utils.sendMessage(responseBody);\n        },\n      };\n    };\n  },\n};\n\nconst onMessageHandler = (message) => {\n  // Handles core calls\n  if (message.type.includes(\"nsb:\")) {\n    handlerCoreRequests(message);\n    return;\n  }\n\n  // Handles Widget request calls:\n  // - request: payload sent by External App\n  // - response: method to send the answer back to the External App\n  // - utils: Utils features like: promisify, ...\n  const request = {\n    type: message.type,\n    payload: message.payload,\n  };\n  const utils = {\n    promisify: Utils.promisify,\n  };\n  props.requestHandler(request, responseFactory.build(), utils);\n};\n\n// REQUEST HANDLERS BELOW\nconst handlerCoreRequests = (message) => {\n  switch (message.type) {\n    case \"nsb:session-storage:hydrate-viewer\":\n      sessionStorageHydrateViewer(message.type, message.payload);\n      break;\n    case \"nsb:session-storage:hydrate-app\":\n      sessionStorageHydrateApp(message.type, message.payload);\n      break;\n    case \"nsb:navigation:sync-content-height\":\n      setIframeHeight(message.type, message.payload);\n      break;\n    case \"nsb:auth:get-user-info\":\n      getUserInfo(message.type, message.payload);\n      break;\n  }\n};\n\nconst CORE_STORAGE_KEY = \"app:storage\";\n// Store data\nconst sessionStorageHydrateViewer = (requestType, payload) => {\n  if (payload) {\n    // store data\n    console.log(\"Hydrate Viewer\", payload);\n    Storage.privateSet(CORE_STORAGE_KEY, payload);\n\n    const responseBody = buildAnswer(requestType, payload);\n    Utils.sendMessage(responseBody);\n  }\n};\n\n// Retrieve stored data\nconst sessionStorageHydrateApp = (requestType) => {\n  // get stored data\n  const storageData = Storage.privateGet(CORE_STORAGE_KEY);\n  console.log(\"Stored data:\", storageData);\n  const responseBody = buildAnswer(requestType, storageData);\n  Utils.sendMessage(responseBody);\n};\n\n// Set thew new iFrame height based on the new screen/route\nconst setIframeHeight = (requestType, payload) => {\n  State.update({ iframeHeight: payload.height + 20 });\n  const responseBody = buildAnswer(requestType, {});\n  Utils.sendMessage(responseBody);\n};\n\n// Get user info\nconst getUserInfo = (requestType) => {\n  // check if user is signed in\n  if (!accountId) {\n    const responseBody = buildAnswer(requestType, {\n      error: \"user is not signed in\",\n    });\n    Utils.sendMessage(responseBody);\n    return;\n  }\n\n  Utils.promisify(\n    () => Social.getr(`${accountId}/profile`), // profile info\n    (res) => {\n      const responseBody = buildAnswer(requestType, {\n        accountId,\n        profileInfo: res,\n      });\n      Utils.sendMessage(responseBody);\n    },\n    (err) => {\n      console.log(\"error fetching profile data\", err);\n    }\n  );\n};\n\nreturn (\n  <div>\n    <iframe\n      className=\"w-100\"\n      style={{ height: `${state.iframeHeight}px` }}\n      srcDoc={code}\n      message={state.currentMessage}\n      onMessage={onMessageHandler}\n    />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/wendersonpires.near/widget/NearSocialBridgeWithExternalApp_Test"}