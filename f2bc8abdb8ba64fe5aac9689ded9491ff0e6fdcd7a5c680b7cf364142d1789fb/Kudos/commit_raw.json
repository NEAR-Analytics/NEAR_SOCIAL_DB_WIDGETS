{"tx_hash": "GRNFmQiAMUaxVAmW8r2jwip9BPsQ1jAUCunSvXvPeiHM", "action_id_social": "5zsRuR2fejg7ikuJVxpihFK19avHT6ZeU2eMvc5wx1uo-0-widget", "block_id": 91035409, "block_timestamp": "2023-05-03 22:53:33.331", "signer_id": "f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb", "widget_name": "Kudos", "source_code": "const tabs = {\r\n  ALL_kUDOS: {\r\n    id: 0,\r\n    text: \"All Kudos\",\r\n  },\r\n  KUDO: {\r\n    id: 1,\r\n    text: \"Kudo\",\r\n  },\r\n};\r\n\r\nconst blockHeight = props.blockHeight ?? undefined;\r\nconst commentSharedBlockHeight = props.commentSharedBlockHeight ?? undefined;\r\n\r\nconst updateGeneralState = props.updateGeneralState;\r\n\r\nconst thisWidgetInlineStyles = props.allWidgetsInlineStyles.kudos;\r\nconst thisWidgetClassNames = props.allWidgetsClassNames.kudos;\r\n\r\nconst widgetOwner = props.widgetOwner;\r\n\r\nconst widgetName = \"Kudos\";\r\nconst widgetPath = `webuidl.near/widget/${widgetName}`;\r\nconst metadata = props.metadata ?? Social.getr(`${widgetPath}/metadata`);\r\n\r\nconst urlPrefix = \"https://\";\r\nconst accountId = props.accountId ?? \"*\";\r\n\r\nconst data = Social.index(\"kudo\", \"answer\");\r\nif (!data) {\r\n  return \"Loading answers\";\r\n}\r\nconst upvotes = Social.index(\"kudo\", \"upvote\");\r\nif (!upvotes) {\r\n  return \"Loading upvotes\";\r\n}\r\n\r\nconst commentAnswers = Social.index(\"kudo\", \"commentAnswers\");\r\nif (!commentAnswers) {\r\n  return \"Loading commentAnswers\";\r\n}\r\n\r\nconst blackList = [\"webuidl.near\"];\r\nconst whiteListData = data.filter((d) => !blackList.includes(d.accountId));\r\nconst whiteListComments = commentAnswers.filter(\r\n  (d) => !blackList.includes(d.accountId)\r\n);\r\nlet sortedData = whiteListData.sort(\r\n  (d1, d2) => d2.blockHeight - d1.blockHeight\r\n);\r\n\r\nsortedData.forEach((_, i) => {\r\n  sortedData[i].value.comments = [];\r\n  sortedData[i].value.upvotes = 0;\r\n});\r\n\r\nlet upvotesMap = {};\r\nfor (let i = 0; i < upvotes.length; i++) {\r\n  const vote = upvotes[i];\r\n  const upvoteBlockHeight = vote.value.blockHeight;\r\n  if (!upvotesMap[upvoteBlockHeight]) {\r\n    upvotesMap[upvoteBlockHeight] = 0;\r\n  }\r\n  upvotesMap[upvoteBlockHeight] += 1;\r\n}\r\n\r\nwhiteListComments.forEach((c) => {\r\n  const dataIndex = sortedData.findIndex(\r\n    (d) => d.blockHeight == c.value.blockHeight\r\n  );\r\n  if (dataIndex === -1) return;\r\n  sortedData[dataIndex].value.comments.push(c);\r\n});\r\n\r\nupvotes.forEach((upvote) => {\r\n  const dataIndex = sortedData.findIndex(\r\n    (d) => d.blockHeight == upvote.value.blockHeight\r\n  );\r\n  if (dataIndex === -1) return;\r\n  sortedData[dataIndex].value.upvotes += 1;\r\n});\r\n\r\nconst finalData = sortedData;\r\n\r\nconst kudoBlockHeightFiltered = finalData.filter(\r\n  (d) => d.blockHeight == blockHeight\r\n);\r\n\r\nconst openKudo = kudoBlockHeightFiltered[0] ?? {};\r\n\r\nState.init({\r\n  hoveringElement: \"\",\r\n  input: \"\",\r\n  url: \"\",\r\n  onChange: ({ content }) => {\r\n    State.update({ content });\r\n  },\r\n  display: blockHeight ? tabs.KUDO.id : tabs.ALL_kUDOS.id,\r\n  kudo: openKudo,\r\n});\r\n\r\n/* BEGIN Common.componse  */\r\nconst composeData = () => {\r\n  const data = {\r\n    post: {\r\n      main: JSON.stringify(state.content),\r\n    },\r\n    index: {\r\n      post: JSON.stringify({\r\n        key: \"main\",\r\n        value: {\r\n          type: \"md\",\r\n        },\r\n      }),\r\n    },\r\n  };\r\n\r\n  const item = {\r\n    type: \"social\",\r\n    path: `${context.accountId}/post/main`,\r\n  };\r\n\r\n  const notifications = state.extractMentionNotifications(\r\n    state.content.text,\r\n    item\r\n  );\r\n\r\n  if (notifications.length) {\r\n    data.index.notify = JSON.stringify(\r\n      notifications.length > 1 ? notifications : notifications[0]\r\n    );\r\n  }\r\n\r\n  const hashtags = state.extractHashtags(state.content.text);\r\n\r\n  if (hashtags.length) {\r\n    data.index.hashtag = JSON.stringify(\r\n      hashtags.map((hashtag) => ({\r\n        key: hashtag,\r\n        value: item,\r\n      }))\r\n    );\r\n  }\r\n\r\n  return data;\r\n};\r\n\r\n/* END Common.componse  */\r\n\r\n/* BEGIN CommentButton  */\r\n\r\n/* END CommentButton  */\r\n\r\nconst RenderKudoBox = (d, index) => {\r\n  return (\r\n    <Widget\r\n      src={`${widgetOwner}/widget/kudoBox`}\r\n      props={{\r\n        tabs,\r\n        commentSharedBlockHeight,\r\n        oppenedTab: state.display,\r\n        widgetOwner,\r\n        d,\r\n        index,\r\n        upvotes,\r\n        updateGeneralState,\r\n        allWidgetsInlineStyles: props.allWidgetsInlineStyles,\r\n        allWidgetsClassNames: props.allWidgetsClassNames,\r\n      }}\r\n    />\r\n  );\r\n};\r\n\r\nreturn (\r\n  <div\r\n    style={thisWidgetInlineStyles.generalContainer}\r\n    className={thisWidgetClassNames.generalContainer}\r\n  >\r\n    <div className={thisWidgetClassNames.selectedTabContainer}>\r\n      <h2 style={thisWidgetInlineStyles.selectedTab}>\r\n        {state.display == tabs.ALL_kUDOS.id\r\n          ? tabs.ALL_kUDOS.text\r\n          : `${tabs.KUDO.text}`}\r\n      </h2>\r\n      {state.display == tabs.KUDO.id && (\r\n        <i\r\n          className=\"bi bi-x-lg\"\r\n          style={thisWidgetInlineStyles.closeKudoButton}\r\n          onClick={() => {\r\n            State.update({ display: tabs.ALL_kUDOS.id, kudo: {} });\r\n          }}\r\n        ></i>\r\n      )}\r\n    </div>\r\n\r\n    {state.display == tabs.ALL_kUDOS.id && (\r\n      <>\r\n        <p>An accolade, a Thank You, a Job Well Done. Give em a Kudo!\ud83d\udc4f </p>\r\n        <Widget\r\n          src={`${widgetOwner}/widget/Common.Compose`}\r\n          props={{\r\n            id: \"main\",\r\n            textAreaOnly: true,\r\n            onChange: state.onChange,\r\n            onHelper: ({ extractMentionNotifications, extractHashtags }) => {\r\n              State.update({ extractMentionNotifications, extractHashtags });\r\n            },\r\n          }}\r\n        />\r\n\r\n        <div className={thisWidgetClassNames.urlTextareaContainer}>\r\n          <p>Url:</p>\r\n          <textarea\r\n            style={thisWidgetInlineStyles.urlTextarea}\r\n            rows=\"1\"\r\n            value={state.url}\r\n            onChange={(e) => {\r\n              State.update({ url: e.target.value });\r\n            }}\r\n          />\r\n        </div>\r\n        <CommitButton\r\n          style={\r\n            state.hoveringElement == \"commitButton\"\r\n              ? props.allWidgetsInlineStyles.hoveringButtonStyles\r\n              : props.allWidgetsInlineStyles.standardButtonStyles\r\n          }\r\n          data={{\r\n            index: {\r\n              kudo: JSON.stringify(\r\n                {\r\n                  key: \"answer\",\r\n                  value: {\r\n                    answer: state.content.text,\r\n                    url: state.url,\r\n                  },\r\n                },\r\n                undefined,\r\n                0\r\n              ),\r\n            },\r\n          }}\r\n          onMouseEnter={() => {\r\n            State.update({ hoveringElement: \"commitButton\" });\r\n          }}\r\n          onMouseLeave={() => {\r\n            State.update({ hoveringElement: \"\" });\r\n          }}\r\n          onCommit={() => {\r\n            State.update({\r\n              reloadData: true,\r\n            });\r\n          }}\r\n        >\r\n          Kudos!\r\n        </CommitButton>\r\n      </>\r\n    )}\r\n\r\n    {state.display == tabs.ALL_kUDOS.id && (\r\n      <div className={thisWidgetClassNames.allCardsContainer}>\r\n        {sortedData\r\n          ? sortedData.map((d, index) => {\r\n              return RenderKudoBox(d, index);\r\n            })\r\n          : \"Loading...\"}\r\n      </div>\r\n    )}\r\n    {state.display == tabs.KUDO.id && RenderKudoBox(state.kudo, 0)}\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/Kudos"}