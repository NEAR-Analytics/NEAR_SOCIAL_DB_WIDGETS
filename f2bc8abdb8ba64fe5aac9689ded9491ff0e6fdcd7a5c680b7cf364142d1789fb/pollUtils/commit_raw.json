{"tx_hash": "JvU1hPRNRe9Wu1QKiHEf5znJ9SHDyFsyCHUPoJpoiV4", "action_id_social": "Dkp39TWWjgqHkaSPJAhhJb5ZcoAVLEzbnU1twk3BJSft-0-widget", "block_id": 83789562, "block_timestamp": "2023-01-25 21:34:05.287", "signer_id": "f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb", "widget_name": "pollUtils", "source_code": "//////////////////////// Private methods ////////////////////////\r\n// Not actually private, but can't be called directly. Look for public methods to see what this widget can do)\r\n\r\n/**\r\n * @param optional props.accountId filters by the accountId provided, if provided\r\n * Returns all the questions asked to poll_question key, with different versions\r\n */\r\nfunction getQuestions() {\r\n  return Social.index(\"poll_question\", \"question-v3.0.1\", {\r\n    accountId: props.accountId,\r\n  });\r\n}\r\n\r\n/**\r\n * @param props.blockHeight blockHeight of the question. It should be a number, but it may come as a string if it comes from an url\r\n * Returns the question that matches the block height provided\r\n */\r\nfunction getQuestionFromBlockHeight(blockHeight) {\r\n  if (!props.blockHeight && !blockHeight) {\r\n    return \"Function getQuestionFromBlockHeight needs prop blockHeight\";\r\n  }\r\n  blockHeight = props.blockHeight ?? blockHeight;\r\n  const questions = getQuestions();\r\n  return questions.find((q) => q.blockHeight == Number(blockHeight));\r\n}\r\n\r\n/**\r\n * Returns all the questions asked to poll_question key, with different versions\r\n */\r\nfunction getAnswers() {\r\n  return Social.index(\"poll_question\", \"answer-v3.0.1\");\r\n}\r\n\r\n/**\r\n * @param props.questionBlockHeight blockHeight of the question. It should be a number, but it may come as a string if it comes from an url\r\n * Filters answers by the question's block height\r\n */\r\nfunction getAnswersToQuestion() {\r\n  if (!props.questionBlockHeight) {\r\n    return \"Function getAnswersToQuestion needs prop questionBlockHeight\";\r\n  }\r\n  const answers = getAnswers();\r\n  return answers.filter(\r\n    (a) => a.value.questionBlockHeight == props.questionBlockHeight\r\n  );\r\n}\r\n\r\n// Utility function. Move to time related widget\r\nfunction getBlockTimestamp(blockHeight) {\r\n  // It is stored in nanoseconds which is 1e-6 miliseconds\r\n  return Near.block(blockHeight).header.timestamp / 1e6;\r\n}\r\n\r\n/**\r\n * @param answers array obtained from getAnswers()'s structure\r\n * Discards answers that were posted after question's end date\r\n */\r\nfunction filterOutOfTimeAnswers(answers) {\r\n  let low = 0;\r\n  let high = answers.length - 1;\r\n  const questionEndTimestamp = questionParams.value.endTimestamp;\r\n  let endBlockTimestamp = getBlockTimestamp(answers[high].blockHeight);\r\n  if (endBlockTimestamp < questionEndTimestamp) return answers;\r\n  // For tries to exceed 50 there should be more than 10e15 answers which will never happen. But if you mess up and make an infinite cycle it will crash. This way it will never be infinite\r\n  let tries = 10;\r\n  while (high - low > 1 && tries > 0) {\r\n    tries--;\r\n    let curr = Math.floor((high - low) / 2) + low;\r\n    let currBlockTimestamp = getBlockTimestamp(answers[curr].blockHeight);\r\n    if (currBlockTimestamp < questionEndTimestamp) {\r\n      low = curr;\r\n    } else {\r\n      high = curr;\r\n    }\r\n  }\r\n  // Slice ignores the index of the last one. Since high - low == 1, high = low + 1\r\n  return answers.slice(0, high);\r\n}\r\n\r\n/**\r\n * @param questionParams question brought by social index\r\n * @param answers answers brought by social index that correspond the question\r\n * Removes any answer that is not a valid index for the multiple choice. Even though the answer is a number, it is formatted as a string because there were another issues with it while displaying if treated as a number\r\n */\r\nfunction filterMultipleChoiceValidAnswers(questionParams, answers) {\r\n  return answers.filter(\r\n    (a) =>\r\n      0 <= Number(a.value.answer) &&\r\n      Number(a.value.answer) < questionParams.value.choicesOptions.length\r\n  );\r\n}\r\n\r\n/**\r\n * @param answers answers to a question\r\n * Filters any answer that was pushed by a user that already replied, so we always have the first answer by the user\r\n */\r\nfunction filterRepeatedUsersAnswers(answers) {\r\n  let usersWithAnswersToThisQuestion = [];\r\n  return answers.filter((a) => {\r\n    const didUserAlreadyAnswered = usersWithAnswersToThisQuestion.includes(\r\n      a.accountId\r\n    );\r\n    if (!didUserAlreadyAnswered) {\r\n      usersWithAnswersToThisQuestion.push(a.accountId);\r\n    }\r\n    return !didUserAlreadyAnswered;\r\n  });\r\n}\r\n\r\n/**\r\n * @param questionBlockHeight block height of the question you want the answers\r\n * Returns all valid answers to question provided\r\n */\r\nfunction getValidAnswersToQuestion() {\r\n  if (!props.questionBlockHeight) {\r\n    return \"Function getValidAnswersToQuestion needs prop questionBlockHeight\";\r\n  }\r\n  const answersToThisQuestion = getAnswersToQuestion();\r\n  let validAnswers = filterOutOfTimeAnswers(answersToThisQuestion);\r\n  validAnswers = filterRepeatedUsersAnswers(validAnswers);\r\n\r\n  const questionParams = getQuestionFromBlockHeight(props.questionBlockHeight);\r\n  // Type \"1\" means multiple choice. Check widget newPollQuestionInterface for more info\r\n  if (questionParams.value.questionType == \"1\") {\r\n    validAnswers = filterMultipleChoiceValidAnswers(\r\n      questionParams,\r\n      validAnswers\r\n    );\r\n  }\r\n  return validAnswers;\r\n}\r\n\r\n//////////////////////// Public methods ////////////////////////\r\n\r\n// Switch doesn't work on Near Social and couldn't find a way to call a function from a string\r\nlet outputObject;\r\nif (props.fn == \"getQuestions\") {\r\n  outputObject = getQuestions();\r\n} else if (props.fn == \"getQuestionFromBlockHeight\") {\r\n  outputObject = getQuestionFromBlockHeight();\r\n} else if (props.fn == \"getValidAnswersToQuestion\") {\r\n  outputObject = getValidAnswersToQuestion();\r\n} else {\r\n  outputObject = \"fn not set or not defined\";\r\n}\r\nreturn JSON.stringify(outputObject);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/pollUtils"}