{"tx_hash": "523a7HLe1wcBhPPWBKY9NJGnaYFFWCU5bQgeVWz17EHd", "action_id_social": "3Ww8JgPoupZT6991K4fZHKpV2Q1ZKE8r8eCf7jn2KyTz-0-widget", "block_id": 86397135, "block_timestamp": "2023-03-02 15:21:42.308", "signer_id": "roshaan.near", "widget_name": "queryapi__IndexerStatus", "source_code": "//props indexer_name\nconst indexer_name = props.indexer_name;\n\nconst LIMIT = 5;\n\nconst accountId = props.accountId || context.accountId;\nconst H2 = styled.h2`\n  font-size: 19px;\n  line-height: 22px;\n  color: #11181c;\n  margin: 0 0 24px;\n`;\nconst Title = styled.h1`\n  font-size: 1.5em;\n  text-align: center;\n  color: black;\n`;\nconst SmallTitle = styled.h3`\n  color: black;\n  font-weight: 600;\n  font-size: 18px;\n  line-height: 15px;\n  text-transform: uppercase;\n\n  @media (max-width: 770px) {\n    margin-bottom: 16px;\n  }\n`;\nconst Subheading = styled.h2`\n  display: block;\n  margin: 0;\n  font-size: 14px;\n  line-height: 10px;\n  color: ${(p) => (p.bold ? \"#11181C !important\" : \"#687076 !important\")};\n  font-weight: ${(p) => (p.bold ? \"600\" : \"400\")};\n  font-size: ${(p) => (p.small ? \"12px\" : \"14px\")};\n  overflow: ${(p) => (p.ellipsis ? \"hidden\" : \"visible\")};\n  text-overflow: ${(p) => (p.ellipsis ? \"ellipsis\" : \"unset\")};\n  white-space: nowrap;\n  outline: none;\n`;\nconst Card = styled.div`\n  border-radius: 12px;\n  background: #fff;\n  box-shadow: 0px 1px 3px rgba(16, 24, 40, 0.1),\n    0px 1px 2px rgba(16, 24, 40, 0.06);\n`;\n\nconst CardBody = styled.div`\n  padding: 16px;\n  display: flex;\n  gap: 16px;\n  align-items: center;\n  flex-direction: column;\n`;\n\nconst CardFooter = styled.div`\n  display: flex;\n  justify-content: space-around;\n  flex-wrap: wrap;\n  gap: 16px;\n  padding: 16px;\n  border-top: 1px solid #eceef0;\n`;\n\nconst TextLink = styled.a`\n  display: block;\n  margin: 0;\n  font-size: 14px;\n  line-height: 20px;\n  color: ${(p) => (p.bold ? \"#11181C !important\" : \"#687076 !important\")};\n  font-weight: ${(p) => (p.bold ? \"600\" : \"400\")};\n  font-size: ${(p) => (p.small ? \"12px\" : \"14px\")};\n  overflow: ${(p) => (p.ellipsis ? \"hidden\" : \"visible\")};\n  text-overflow: ${(p) => (p.ellipsis ? \"ellipsis\" : \"unset\")};\n  white-space: nowrap;\n  outline: none;\n\n  &:focus,\n  &:hover {\n    text-decoration: underline;\n  }\n`;\nif (!indexer_name) return \"missing indexer_name\";\nconst state_table = \"| Function Name | Current Block Height |\\n| --- | --- |\\n\";\n\nconst logs_table =\n  \"| Block Height | Function Name | Message | Timestamp |\\n| --- | --- | --- | --- |\\n\";\nconst indexer_values_table =\n  \"| Function Name | Key Name | Value |\\n| --- | --- | --- |\\n\";\n\nState.init({\n  logs: [],\n  state: [],\n  indexer_res: [],\n  indexer_resCount: 0,\n  logsCount: 0,\n  stateCount: 0,\n  indexer_resOffset: 0,\n  logsOffset: 0,\n  stateOffset: 0,\n});\nfunction fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(\n    \"https://query-api-hasura-vcqilefdcq-uc.a.run.app/v1/graphql\",\n    {\n      method: \"POST\",\n      // headers: {\n      //   \"x-hasura-admin-secret\": \"FgG6BmTJqgbVMRnL63zv\",\n      // },\n      body: JSON.stringify({\n        query: operationsDoc,\n        variables: variables,\n        operationName: operationName,\n      }),\n    }\n  );\n}\n\nconst createGraphQLLink = () => {\n  const queryLink =\n    \"https://cloud.hasura.io/public/graphiql?endpoint=https%3A%2F%2Fquery-api-hasura-vcqilefdcq-uc.a.run.app%2Fv1%2Fgraphql&query=query+IndexerQuery+%7B%0A++indexer_state%28where%3A+%7Bfunction_name%3A+%7B_eq%3A+%22function_placeholder%22%7D%7D%29+%7B%0A++++function_name%0A++++current_block_height%0A++%7D%0A++indexer_storage%28where%3A+%7Bfunction_name%3A+%7B_eq%3A+%22function_placeholder%22%7D%7D%29+%7B%0A++++function_name%0A++++key_name%0A++++value%0A++%7D%0A++log_entries%28where%3A+%7Bfunction_name%3A+%7B_eq%3A+%22function_placeholder%22%7D%7D%29+%7B%0A++++function_name%0A++++id%0A++++message%0A++++timestamp%0A++%7D%0A%7D%0A\";\n\n  return queryLink.replaceAll(\"function_placeholder\", indexer_name);\n};\n\nconst IndexerStorageDoc = `\n  query IndexerStorage($offset: Int) {\n    indexer_storage(limit: ${LIMIT},  offset: $offset, where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n      function_name\n      key_name\n      value\n    }\n    indexer_storage_aggregate(where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n      aggregate {\n        count\n      }\n    }\n  }\n`;\n\nconst logsDoc = `\n  query QueryLogs($offset: Int) {\n    indexer_log_entries(order_by: {block_height: desc}, limit: ${LIMIT}, offset: $offset, where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n      block_height\n      id\n      function_name\n      message\n      timestamp\n    }\n    indexer_log_entries_aggregate(where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n    aggregate {\n      count\n    }\n  }\n  }\n`;\n\nconst indexerStateDoc = `\n  query IndexerState($offset: Int) {\n    indexer_state(limit: ${LIMIT}, offset: $offset, where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n      function_name\n      current_block_height\n    }\n    indexer_state_aggregate(where: {function_name: {_eq: \"${accountId}/${indexer_name}\"}}) {\n    aggregate {\n      count\n    }\n    }\n  }\n`;\n\nfetchGraphQL(IndexerStorageDoc, \"IndexerStorage\", {\n  offset: state.indexer_resOffset * LIMIT,\n}).then((result) => {\n  console.log(\"result\", result);\n  if (result.status === 200) {\n    if (result.body?.errors?.length > 0) {\n      return;\n    }\n    try {\n      State.update({\n        indexer_res: result.body.data.indexer_storage,\n        indexer_resCount:\n          result.body.data.indexer_storage_aggregate.aggregate.count,\n      });\n    } catch (e) {\n      console.log(\"error\", e);\n    }\n  }\n});\n\nfetchGraphQL(logsDoc, \"QueryLogs\", {\n  offset: state.logsOffset * LIMIT,\n}).then((result) => {\n  console.log(\"resultquerylogs\", result);\n  if (result.status === 200) {\n    if (result.body?.errors?.length > 0) {\n      return;\n    }\n    try {\n      State.update({\n        logs: result.body.data.indexer_log_entries,\n        logsCount:\n          result.body.data.indexer_log_entries_aggregate.aggregate.count,\n      });\n    } catch (e) {\n      console.log(\"error\", e);\n    }\n  }\n});\n\nfetchGraphQL(indexerStateDoc, \"IndexerState\", {\n  offset: state.stateOffset * LIMIT,\n}).then((result) => {\n  console.log(\"indexerstatelogs\", result);\n  if (result.status === 200) {\n    if (result.body?.errors?.length > 0) {\n      return;\n    }\n    try {\n      State.update({\n        state: result.body.data.indexer_state,\n        stateCount: result.body.data.indexer_state_aggregate.aggregate.count,\n      });\n    } catch (e) {\n      console.log(\"error\", e);\n    }\n  }\n});\n\nconst create_table = () => {\n  state.indexer_res.forEach((row) => {\n    indexer_values_table += `| ${row?.function_name} | ${row?.key_name} | ${row?.value} |\\n`;\n  });\n  state.logs.forEach((row) => {\n    logs_table += `| ${row?.block_height} | ${row?.function_name} | ${row?.message} | ${row?.timestamp} |\\n`;\n  });\n  state.state.forEach((row) => {\n    state_table += `| ${row?.function_name} | ${row?.current_block_height} |\\n`;\n  });\n};\nconst onLogsPageChange = (page) => {\n  page = page - 1;\n  State.update({ logsOffset: page });\n  try {\n    fetchGraphQL(logsDoc, \"QueryLogs\", { offset: page * LIMIT }).then(\n      (result) => {\n        if (result.status === 200) {\n          if (result.body?.errors?.length > 0) {\n            return;\n          }\n          try {\n            State.update({\n              logs: result.body.data.indexer_log_entries,\n            });\n          } catch (e) {\n            console.log(\"error\", e);\n          }\n        }\n      }\n    );\n  } catch (e) {\n    console.log(\"error:\", e);\n  }\n};\nconst onIndexerResPageChange = (page) => {\n  page = page - 1;\n  State.update({ indexer_resOffset: page });\n  fetchGraphQL(IndexerStorageDoc, \"IndexerStorage\", {\n    offset: page * LIMIT,\n  }).then((result) => {\n    if (result.status === 200) {\n      if (result.body?.errors?.length > 0) {\n        return;\n      }\n      try {\n        State.update({\n          indexer_res: result.body.data.indexer_storage,\n        });\n      } catch (e) {\n        console.log(\"error\", e);\n      }\n    }\n  });\n\n  console.log(\"page clicked indexer res\", page);\n};\ncreate_table();\nreturn (\n  <>\n    <Card>\n      <Title className=\"p-3\">\n        Indexer Status\n        <TextLink href={createGraphQLLink()} target=\"_blank\">\n          GraphQL Playground\n          <i className=\"bi bi-box-arrow-up-right\"></i>\n        </TextLink>\n      </Title>\n\n      <CardBody>\n        <SmallTitle>Indexed Values</SmallTitle>\n\n        {state.indexer_res.length > 0 ? (\n          <div>\n            <Markdown text={indexer_values_table} />\n            <Widget\n              src=\"chaotictempest.near/widget/Paginate\"\n              props={{\n                siblingCount: 1,\n                totalCount: state.indexer_resCount,\n                pageSize: 20,\n                onPageChange: onIndexerResPageChange,\n              }}\n            />\n          </div>\n        ) : (\n          <Subheading> No data to show... </Subheading>\n        )}\n\n        <SmallTitle>Indexer State</SmallTitle>\n\n        {state.state.length > 0 ? (\n          <Markdown text={state_table} />\n        ) : (\n          <Subheading> No data to show... </Subheading>\n        )}\n        <SmallTitle> Indexer Logs</SmallTitle>\n        {state.logs.length > 0 ? (\n          <div>\n            <Markdown text={logs_table} />\n            <Widget\n              src=\"chaotictempest.near/widget/Paginate\"\n              props={{\n                siblingCount: 1,\n                totalCount: state.logsCount,\n                pageSize: 20,\n                onPageChange: onLogsPageChange,\n              }}\n            />\n          </div>\n        ) : (\n          <Subheading> No data to show... </Subheading>\n        )}\n      </CardBody>\n      <CardFooter></CardFooter>\n    </Card>\n  </>\n);\n", "metadata": null, "branch": NaN, "widget_modules_used": null, "widget_url": "https://near.social/#/roshaan.near/widget/queryapi__IndexerStatus", "branch.draft.": NaN, "branch.draft.metadata": NaN}