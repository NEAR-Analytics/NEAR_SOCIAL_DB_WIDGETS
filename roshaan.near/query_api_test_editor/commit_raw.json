{"tx_hash": "YmEzc4SHjQfGGucrZEGZfdnBfjtiraXKwLSzRSaReEj", "action_id_social": "AVWyP1Whgps62RGf9BXDdAmYsL3ZWNrcsoC15j4pJC6E-0-widget", "block_id": 85445518, "block_timestamp": "2023-02-17 18:24:14.522", "signer_id": "roshaan.near", "widget_name": "query_api_test_editor", "source_code": "let initialText = \"\";\nconst indexer_function_name = props.indexer_name;\nconst registry_contract_id =\n  props.registry_contract_id || \"registry.queryapi.near\";\nlet accountId = props.accountId || context.accountId;\nState.init({\n  code: initialText,\n});\n\nif (!accountId) {\n  return \"Please sign in to use this widget.\";\n}\n\nNear.asyncView(registry_contract_id, \"read_indexer_function\", {\n  name: `${accountId}/${indexer_function_name}`,\n}).then((data) => {\n  if (!data) return;\n  console.log(data, \"data loaded\", `${accountId}/${indexer_function_name}`);\n  State.update({ code: data });\n});\n\nlet updateIndexerCode = (code) => {\n  const gas = 200000000000000;\n\n  Near.call(\n    contractId,\n    \"register_indexer_function\",\n    {\n      name: indexer_function_name,\n      code: code,\n    },\n    gas\n  );\n};\n\nconst reducer = (message) => {\n  switch (message.action) {\n    case \"register_function\":\n      updateIndexerCode(message.value);\n      break;\n\n    case \"initial_load\":\n      State.update({ code: message.value });\n      break;\n\n    case \"default\":\n      console.log(\"default case\");\n  }\n};\nconst code = `\n<script>\nfunction test(data) {\n  let receiverWindow = document.getElementById(\"react-app-iframe\").contentWindow\n  if (!receiverWindow) {\n      console.warn(\"receiver window not found!!!!\")\n  }\n  console.log(receiverWindow, \"receiverrrr\")\n  // try {\n  //     if (event.data.action === \"send_indexer_details\") {\n  //       console.log(\"trying to send the data to react app\")\n  //         receiverWindow.postMessage({\n  //             action: \"subscription_request\",\n  //             data: data\n  //         }, \"*\")\n  //     }\n  // } catch (error) {\n  //     console.log(error, \"errored out\")\n  // }\n  console.log(\"reached here\")\nwindow.addEventListener(\"message\", function(event) {\n  console.log(\"received a message\")\n  console.log(event)\n  // console.log(\"message came from :\", event.source.name)\n  if (event.data.action === \"register_function\") {\n      window.top.postMessage(event.data, \"*\");\n  }\n  if (event.data.action === \"request_indexer_details\") {\n      event.source.postMessage({\n          action: \"subscription_request\",\n          from: \"iframe\", \n          data: data\n      }, \"*\")\n  }\n})\n}\n</script>\n<iframe name=\"react-app\" id=\"react-app-iframe\" src=\"https://query-api-react.vercel.app/query-api-editor\" width=\"1250px\" height=\"500px\"></iframe>\n\n<script>\nwindow.addEventListener(\"message\", function(event){\n    console.log(event, \"event detaisl\")\n    try {\n      if(event.data.action ===\"send_indexer_details\") {\n        console.log(\"sender-indexer details\")\n        test(event.data)\n      }\n  \n    // let receiverWindow = document.getElementById(\"react-app-iframe\").contentWindow\n    // console.log(receiverWindow, \"receiverWindow\")\n    // receiverWindow.postMessage({action: \"subscription\", data: event.data}, \"*\");\n    }\n    catch(error){\n        console.log(error, \"we errored out\")\n    }\n\n})\n</script>\n`;\n\nreturn (\n  <div>\n    <iframe\n      name=\"widget-iframe\"\n      className=\"w-100\"\n      style={{ height: \"500px\" }}\n      srcDoc={code}\n      message={{\n        action: \"send_indexer_details\",\n        value: {\n          indexer_name: indexer_function_name,\n          accountId: accountId,\n        },\n        from: \"widget\",\n      }}\n      onMessage={(message) => reducer(message)}\n    />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/roshaan.near/widget/query_api_test_editor"}