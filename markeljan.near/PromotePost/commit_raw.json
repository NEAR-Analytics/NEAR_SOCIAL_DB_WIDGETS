{"tx_hash": "2SQM19YQGbEtqtXbSP14xstAS9uMjLdGNjKD4Zx7myWK", "action_id_social": "5ZzTzcxEGSiV3XpC5a23sgDCRVbttK5a8sMDzQVruK4D-0-widget", "block_id": 86608075, "block_timestamp": "2023-03-05 11:10:33.151", "signer_id": "markeljan.near", "widget_name": "PromotePost", "source_code": "/*\r\nProps = {\r\n  postId: number,\r\n  bidAmount: number,\r\n  duration: number,\r\n}\r\n\r\n*/\r\n\r\nlet contract = \"promotepost.near\";\r\n\r\nconst deposits = Near.view(contract, \"get_all_deposits\") || [];\r\n\r\ninitState({\r\n  postId: props.postId ?? 0,\r\n  amount: props.bidAmount ?? 0,\r\n  duration: props.duration ?? 1,\r\n});\r\n\r\nconst daysBetweenTimestamps = (timestamp1, timestamp2) => {\r\n  const oneDay = 24 * 60 * 60 * 1000; // one day in milliseconds\r\n  const timeDiff = Math.abs(timestamp2 - timestamp1); // difference in milliseconds\r\n  const numDays = Math.round(timeDiff / oneDay); // round to nearest integer\r\n  return numDays;\r\n};\r\n\r\nconst calculateBidPower = (deposit) => {\r\n  const daysBetween = daysBetweenTimestamps(\r\n    deposit.timestamp,\r\n    deposit.expire_timestamp\r\n  );\r\n  return deposit.amount / daysBetween;\r\n};\r\n\r\nconst findPromotedPosts = (posts, deposits) => {\r\n  const promotedPosts = [];\r\n\r\n  deposits\r\n    .filter((deposit) => deposit.expire_timestamp > Date.now())\r\n    .forEach((deposit) => {\r\n      const postId = deposit.post_id;\r\n      const currentBidPower = (\r\n        promotedPosts.find((post) => post.id === postId) || { bidPower: 0 }\r\n      ).bidPower;\r\n\r\n      const newBidPower = currentBidPower + calculateBidPower(deposit);\r\n\r\n      if (promotedPosts.length < 3 || newBidPower > promotedPosts[2].bidPower) {\r\n        promotedPosts.push({ id: postId, bidPower: newBidPower });\r\n        promotedPosts.sort((a, b) => b.bidPower - a.bidPower);\r\n        promotedPosts.splice(3);\r\n      }\r\n    });\r\n\r\n  return promotedPosts;\r\n};\r\n\r\nconst posts = Near.view(\"devgovgigs.near\", \"get_posts\") || [];\r\nconst promotedPosts = findPromotedPosts(posts, deposits);\r\n\r\nconsole.log(promotedPosts, \"hey\");\r\n//gets current timestamp and days to add, returns expire timestamp in milliseconds\r\nconst calculateExpireTimestamp = (days) => {\r\n  const date = new Date();\r\n  const timestamp = date.getTime();\r\n  const ONE_DAY_MILLISECONDS = 86400000;\r\n  const expireTimestamp = timestamp + days * ONE_DAY_MILLISECONDS;\r\n  return expireTimestamp;\r\n};\r\n\r\nconst calculatePower = () => {\r\n  const power = `${(state.amount / state.duration).toFixed(3)} / day`;\r\n  return power;\r\n};\r\n\r\nconst depositBid = () => {\r\n  Near.call(\r\n    contract,\r\n    \"deposit\",\r\n    {\r\n      post_id: parseInt(state.postId),\r\n      expire_timestamp: calculateExpireTimestamp(state.duration),\r\n    },\r\n    \"30000000000000\",\r\n    state.amount * 1e24\r\n  );\r\n};\r\nconst onChangePostId = (postId) => {\r\n  State.update({\r\n    postId,\r\n  });\r\n};\r\nconst onChangeAmount = (amount) => {\r\n  State.update({\r\n    amount,\r\n  });\r\n};\r\nconst onChangeDuration = (duration) => {\r\n  State.update({\r\n    duration,\r\n  });\r\n};\r\n\r\nreturn (\r\n  <>\r\n    <div className=\"container mt-5 \">\r\n      <div className=\"row justify-content-center \">\r\n        <div className=\"col-md-6 border rounded p-4 pt-3\">\r\n          <h1 className=\"text-center mb-3\">Promote Post</h1>\r\n          <span class=\"text-muted\">Current NEAR daily bids:</span>\r\n          <div className=\" d-flex justify-content-between mt-1\">\r\n            {promotedPosts.map((post, index) => (\r\n              <div key={index} class=\" mb-2\">\r\n                {index === 0 && (\r\n                  <span role=\"img\" aria-label=\"Gold Medal\">\r\n                    \ud83e\udd47\r\n                  </span>\r\n                )}\r\n                {index === 1 && (\r\n                  <span role=\"img\" aria-label=\"Silver Medal\">\r\n                    \ud83e\udd48\r\n                  </span>\r\n                )}\r\n                {index === 2 && (\r\n                  <span role=\"img\" aria-label=\"Bronze Medal\">\r\n                    \ud83e\udd49\r\n                  </span>\r\n                )}\r\n                {(post.bidPower / 1e24).toFixed(3)}\r\n              </div>\r\n            ))}\r\n          </div>\r\n          <h2 className=\" text-center text-primary mb-2\">{calculatePower()}</h2>\r\n          <div className=\"mb-3\">\r\n            <label htmlFor=\"postId\" className=\"form-label\">\r\n              Post ID\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              className=\"form-control\"\r\n              id=\"postId\"\r\n              value={state.postId}\r\n              onChange={(e) => onChangePostId(e.target.value)}\r\n            />\r\n          </div>\r\n          <div className=\"mb-3\">\r\n            <label htmlFor=\"amount\" className=\"form-label\">\r\n              Total Bid (NEAR)\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              className=\"form-control\"\r\n              id=\"amount\"\r\n              value={state.amount}\r\n              onChange={(e) => onChangeAmount(e.target.value)}\r\n            />\r\n          </div>\r\n          <div className=\"mb-3\">\r\n            <label htmlFor=\"duration\" className=\"form-label\">\r\n              Duration (Days)\r\n            </label>\r\n            <div className=\"d-flex align-items-center\">\r\n              <input\r\n                type=\"range\"\r\n                className=\"form-range\"\r\n                id=\"duration\"\r\n                min=\"1\"\r\n                max=\"365\"\r\n                value={state.duration}\r\n                onChange={(e) => onChangeDuration(e.target.value)}\r\n              />\r\n              <div className=\"ms-3\">{state.duration} days</div>\r\n            </div>\r\n          </div>\r\n          <button\r\n            disabled={context.loading}\r\n            onClick={depositBid}\r\n            className={`btn ${\r\n              context.loading ? \"btn-outline-dark\" : \"btn-primary\"\r\n            } w-100`}\r\n          >\r\n            Promote Post {state.postId} with {state.amount} NEAR\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </>\r\n);\r\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/markeljan.near/widget/PromotePost", "metadata.description": NaN, "metadata.image.ipfs_cid": NaN, "metadata.name": NaN, "metadata.tags.devgovgigs": NaN, "metadata.tags.ethdenver2023": NaN, "metadata.tags.promote": NaN}