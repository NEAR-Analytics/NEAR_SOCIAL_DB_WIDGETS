{"tx_hash": "8F9U7XZ3EgaBKFZgpjcYyikJSLz2aM2w4gM7JTnHJkfv", "action_id_social": "EmsMDVxDdNoUcFoTGvTDkaFJ8LXoCXcUpoFHUiygmD4v-0-widget", "block_id": 90787259, "block_timestamp": "2023-04-30 15:32:20.063", "signer_id": "ref-admin.near", "widget_name": "Ref.ref-swap-getEstimate", "source_code": "// Forked from: weige.near/widget/ref-swap-getEstimate\nconst shrinkToken = (value, decimals) => {\n  return new Big(value || 0).div(new Big(10).pow(decimals || 24));\n};\n\nconst expandToken = (value, decimals) => {\n  return new Big(value).mul(new Big(10).pow(decimals));\n};\n\nconst REF_INDEXER_URL = \"https://indexer.ref.finance/list-top-pools\";\nconst WNEAR_CONTRACT_ID = \"wrap.near\";\n\nconst {\n  tokenIn: tokenInFromProps,\n  tokenOut: tokenOutFromProps,\n  amountIn,\n  loadRes,\n  reloadPools,\n  setReloadPools,\n} = props;\n\nconst tokenIn =\n  tokenInFromProps.id === \"NEAR\"\n    ? { ...tokenInFromProps, id: WNEAR_CONTRACT_ID }\n    : tokenInFromProps;\n\nconst tokenOut =\n  tokenOutFromProps.id === \"NEAR\"\n    ? { ...tokenOutFromProps, id: WNEAR_CONTRACT_ID }\n    : tokenOutFromProps;\n\nconst FEE_DIVISOR = 10000;\n\nconst getSinglePoolEstimate = (tokenIn, tokenOut, pool, amountIn) => {\n  const allocation = amountIn;\n\n  const amount_with_fee =\n    Number(allocation) * (FEE_DIVISOR - pool.total_fee || pool.fee || 0);\n\n  const in_balance = shrinkToken(\n    pool.amounts[pool.token_account_ids[0] === tokenIn.id ? 0 : 1],\n    tokenIn.decimals\n  );\n\n  const out_balance = shrinkToken(\n    pool.amounts[pool.token_account_ids[0] === tokenIn.id ? 1 : 0],\n\n    tokenOut.decimals\n  );\n\n  const estimate = new Big(\n    (\n      (amount_with_fee * Number(out_balance)) /\n      (FEE_DIVISOR * Number(in_balance) + amount_with_fee)\n    ).toString()\n  ).toFixed();\n\n  return {\n    estimate,\n    pool,\n    tokenIn,\n    tokenOut,\n  };\n};\n\nconst returnNull = (sig) => {\n  loadRes({ sig });\n  return <div />;\n};\n\nconst wrapOperation =\n  [tokenIn, tokenOut].every((meta) => meta.id === WNEAR_CONTRACT_ID) &&\n  !![tokenIn, tokenOut].find((meta) => meta.symbol === \"NEAR\");\n\nif (wrapOperation) {\n  loadRes({\n    estimate: amountIn,\n    tokenIn,\n    tokenOut,\n    pool: \"wrap\",\n  });\n\n  return <div />;\n}\n\nif (tokenIn.id === tokenOut.id) return returnNull();\n\nlet topPools = JSON.parse(fetch(REF_INDEXER_URL).body);\n\nconst reloadTopPools = () => {\n  asyncFetch(REF_INDEXER_URL).then((res) => {\n    const data = res.body;\n    topPools = JSON.parse(data);\n    setReloadPools(false);\n  });\n};\n\nif (reloadPools) {\n  reloadTopPools();\n}\n\nif (!topPools) return returnNull();\n\nif (Number(amountIn) === 0) {\n  return returnNull();\n}\n\nconst poolsThisPair = topPools.filter(\n  (p) =>\n    p.token_account_ids.includes(tokenIn.id) &&\n    p.token_account_ids.includes(tokenOut.id)\n);\n\nconst poolThisPair = poolsThisPair.find((p) => p.token_account_ids.length > 2)\n  ? poolsThisPair.find((p) => p.token_account_ids.length > 2)\n  : poolsThisPair[0];\n\nif (!poolThisPair || poolThisPair.amounts.some((a) => Number(a) === 0)) {\n  return returnNull(\"no_pool\");\n}\n\nif (poolThisPair.pool_kind === \"SIMPLE_POOL\") {\n  const res = getSinglePoolEstimate(tokenIn, tokenOut, poolThisPair, amountIn);\n\n  loadRes({ ...res, amountIn });\n} else {\n  return (\n    <Widget\n      src={`${props.config.ownerId}/widget/Ref.ref-stable-swap-algorithm`}\n      props={{\n        loadRes: loadRes,\n        tokenIn,\n        tokenOut,\n\n        amountIn: amountIn,\n        pool: poolThisPair,\n      }}\n    />\n  );\n}\n\nreturn <div />;\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/ref-admin.near/widget/Ref.ref-swap-getEstimate"}