{"tx_hash": "7fmfs9HoYwPiwSprUYzRJDW8qveSyth1FUTqco5nR9cD", "action_id_social": "BZLp6uob6y6GD3cADjMGPLMzXDPXrFSe2z4AeJzJqsU7-0-widget", "block_id": 82127257, "block_timestamp": "2023-01-03 19:47:20.963", "signer_id": "bozon.near", "widget_name": "PrivateMessage.UserMessages", "source_code": "//props:\r\n//secretKeyBase64 : string base64\r\n//receiverAccountId : string base64\r\n//receiverPublicKeyBase64 : string base64\r\n\r\nconst accountId = context.accountId;\r\n\r\nif (!accountId) {\r\n  return \"Please sign in with NEAR wallet\";\r\n}\r\n\r\nif (\r\n  !props.receiverAccountId ||\r\n  !props.secretKeyBase64 ||\r\n  !props.receiverPublicKeyBase64\r\n) {\r\n  return \"Send receiverAccountId, secretKeyBase64, receiverPublicKeyBase64  in props\";\r\n}\r\n\r\nfunction uniteAccountId(accountId0, accountId1) {\r\n  accountId0 = accountId0.toLowerCase();\r\n  accountId1 = accountId1.toLowerCase();\r\n  return accountId0 > accountId0\r\n    ? accountId0 + accountId1\r\n    : accountId1 + accountId0;\r\n}\r\n\r\nState.init({ message: \"\" });\r\n\r\nconst incomingMessages = Social.index(\r\n  \"private_message\",\r\n  accountId.toLowerCase(),\r\n  {\r\n    subscribe: true,\r\n    order: \"desc\",\r\n    accountId: props.receiverAccountId,\r\n  }\r\n);\r\n\r\nconst outgoingMessages = Social.index(\r\n  \"private_message\",\r\n  props.receiverAccountId.toLowerCase(),\r\n  {\r\n    subscribe: true,\r\n    order: \"desc\",\r\n    accountId: accountId.toLowerCase(),\r\n  }\r\n);\r\n\r\nif (incomingMessages === null || outgoingMessages === null) return \"Loading...\";\r\n\r\nconst messages = outgoingMessages.concat(incomingMessages);\r\n\r\nreturn (\r\n  <div>\r\n    <div class=\"input-group mb-3\">\r\n      <textarea\r\n        class=\"form-control\"\r\n        placeholder=\"Input message\"\r\n        onChange={(e) => {\r\n          State.update({\r\n            message: e.target.value,\r\n          });\r\n        }}\r\n      ></textarea>\r\n      <CommitButton\r\n        force\r\n        data={() => {\r\n          const nonce = nacl.randomBytes(nacl.box.nonceLength);\r\n\r\n          const encryptedMessage = nacl.box(\r\n            new Uint8Array(Buffer.from(state.message)),\r\n            nonce,\r\n            new Uint8Array(\r\n              Buffer.from(props.receiverPublicKeyBase64, \"base64\")\r\n            ),\r\n            nacl.box.keyPair.fromSecretKey(\r\n              Buffer.from(props.secretKeyBase64, \"base64\")\r\n            ).secretKey\r\n          );\r\n\r\n          const fullMessage = new Uint8Array(\r\n            nonce.length + encryptedMessage.length\r\n          );\r\n          fullMessage.set(nonce);\r\n          fullMessage.set(encryptedMessage, nonce.length);\r\n\r\n          return {\r\n            private_message: {\r\n              last_message: {\r\n                message_text_base64:\r\n                  Buffer.from(fullMessage).toString(\"base64\"),\r\n                receiver_public_key_base64: props.receiverPublicKeyBase64,\r\n                receiver_account_id: props.receiverAccountId,\r\n              },\r\n            },\r\n            index: {\r\n              private_message: JSON.stringify([\r\n                {\r\n                  key: props.receiverAccountId.toLowerCase(),\r\n                  value: {\r\n                    version: \"0\",\r\n                  },\r\n                },\r\n              ]),\r\n            },\r\n          };\r\n        }}\r\n      >\r\n        Send\r\n      </CommitButton>\r\n    </div>\r\n\r\n    {messages.map((messageObject) => (\r\n      <Widget\r\n        src=\"bozon.near/widget/PrivateMessage.Message\"\r\n        props={{\r\n          secretKeyBase64: props.secretKeyBase64,\r\n          blockHeight: messageObject.blockHeight,\r\n          senderAccountId: messageObject.accountId,\r\n        }}\r\n      />\r\n    ))}\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bozon.near/widget/PrivateMessage.UserMessages"}