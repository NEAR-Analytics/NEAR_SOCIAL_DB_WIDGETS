{"tx_hash": "9SdE7rwAyDA58rQdsUh91VzUcCv1odFbVpXPrrbpHxvX", "action_id_social": "2XtDE7JkPQkuPzzMoc81hJUqYNrqU6mXcqV22LurBN7D-0-widget", "block_id": 82286368, "block_timestamp": "2023-01-05 22:54:33.600", "signer_id": "bozon.near", "widget_name": "PrivateMessage.UserList", "source_code": "const accountId = context.accountId;\r\n\r\nif (!accountId) return \"Please sign in with NEAR wallet\";\r\n\r\nif (!props.secretKeyBase64 || !props.onSelectedUser) {\r\n  console.log(props.secretKeyBase64 || props.onSelectedUser);\r\n  return \"Send secretKeyBase64 and onSelectedUser() in props\";\r\n}\r\n\r\nlet allProfiles =\r\n  Social.get([\"*/profile/name\", \"*/profile/tags/*\"], \"final\") || {};\r\n// allProfiles = Object.keys(allProfilesRequest).map((accountId) => {\r\n//   return [accountId, allProfilesRequest[accountId]?.profile?.name];\r\n// });\r\n\r\nconst follows = Social.get(`${accountId}/graph/follow/**`);\r\n\r\nconst incomingMessages = Social.index(\r\n  \"receive_private_message\",\r\n  accountId.toLowerCase(),\r\n  {\r\n    subscribe: true,\r\n  }\r\n);\r\n\r\nconst outgoingMessages = Social.index(\r\n  \"send_private_message\",\r\n  accountId.toLowerCase(),\r\n  {\r\n    subscribe: true,\r\n  }\r\n);\r\n\r\nif (follows === null || incomingMessages === null || outgoingMessages === null)\r\n  return \"Loading...\";\r\n\r\nconst allFollowers = follows\r\n  ? Object.keys(follows).map((f) => {\r\n      return f;\r\n    })\r\n  : [];\r\n\r\nconst allMessagesCountPerAccountsObj = incomingMessages\r\n  .map((el) => {\r\n    return el.accountId;\r\n  })\r\n  .concat(allFollowers)\r\n  .concat(\r\n    outgoingMessages.map((el) => {\r\n      return el.value?.receiver_account_id;\r\n    })\r\n  )\r\n  .filter((el) => el)\r\n  .reduce((acc, el) => {\r\n    acc[el] += 1;\r\n    return acc;\r\n  }, {});\r\n\r\nconst allMessagesArray = Object.keys(allMessagesCountPerAccountsObj).map(\r\n  (acc) => {\r\n    return {\r\n      accountId: acc,\r\n      countMessages: allMessagesCountPerAccountsObj[acc],\r\n    };\r\n  }\r\n);\r\n\r\nState.init({\r\n  userList: allMessagesArray,\r\n});\r\n\r\nreturn (\r\n  <div>\r\n    <input\r\n      class=\"mb-3 form-control\"\r\n      placeholder=\"\ud83d\udd0d Input username\"\r\n      onChange={(e) => {\r\n        const newFollowersArray = allMessagesArray.filter(\r\n          (el) => el.accountId.indexOf(e.target.value) !== -1\r\n        );\r\n\r\n        if (allProfiles[e.target.value])\r\n          newFollowersArray.unshift({\r\n            accountId: e.target.value,\r\n            countMessages: 0,\r\n          });\r\n\r\n        State.update({\r\n          userList: newFollowersArray,\r\n        });\r\n      }}\r\n    ></input>\r\n\r\n    {allFollowers.length === 0 && <p>You don't have any followers yet</p>}\r\n    {state.userList.map((account, i) => {\r\n      const followerRegisteredPublicKey = Social.get(\r\n        `${account.accountId}/private_message/public_key`\r\n      );\r\n\r\n      return (\r\n        <div\r\n          class=\"mb-3 d-flex flex-row align-items-center justify-content-between\"\r\n          key={i}\r\n        >\r\n          <Widget\r\n            src=\"mob.near/widget/Profile.ShortInlineBlock\"\r\n            props={{\r\n              accountId: account.accountId,\r\n            }}\r\n          />\r\n\r\n          {!followerRegisteredPublicKey ? (\r\n            <span\r\n              style={{ lineHeight: \"1.5rem\" }}\r\n              className=\"badge text-bg-secondary\"\r\n            >\r\n              User not registered\r\n            </span>\r\n          ) : (\r\n            <div>\r\n              {account.countMessages}\r\n              <button\r\n                onClick={() => {\r\n                  props.onSelectedUser(follower, followerRegisteredPublicKey);\r\n                }}\r\n              >\r\n                Send message\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      );\r\n    })}\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bozon.near/widget/PrivateMessage.UserList"}