{"tx_hash": "GbSNjvJKJ4bt3skrKvg868xBcdKXz2rPNRVdbb3YZVnx", "action_id_social": "2E5eMAAcBL8Tq2dD1mwmwbke9BpjPFoZ69AAdssKhHgY-0-widget", "block_id": 82255346, "block_timestamp": "2023-01-05 12:44:33.236", "signer_id": "bozon.near", "widget_name": "PrivateMailBox.Message", "source_code": "//props\r\n//secretKeyBase64 : string base64\r\n//blockHeight? : number || unknown date\r\n//senderAccountId? : string || current account id\r\n\r\nif (!props.secretKeyBase64) return \"send secretKeyBase64 in props\";\r\n\r\nconst publicKey = nacl.box.keyPair.fromSecretKey(\r\n  Buffer.from(props.secretKeyBase64, \"base64\")\r\n).publicKey;\r\nconst publicKeyBase64 = Buffer.from(publicKey).toString(\"base64\");\r\n\r\nconst messageObject = Social.get(\r\n  `${\r\n    props.senderAccountId || context.accountId\r\n  }/private_message/last_message/**`,\r\n  props.blockHeight\r\n);\r\n\r\nif (\r\n  !messageObject.message_text_base64 ||\r\n  !messageObject.sender_public_key_base64 ||\r\n  !messageObject.receiver_public_key_base64\r\n)\r\n  return \"\";\r\n\r\nif (messageObject === null) return \"Loading\";\r\n\r\nconst messageWithNonceUint8Array = new Uint8Array(\r\n  new Buffer(messageObject.message_text_base64, \"base64\")\r\n);\r\nconst nonce = messageWithNonceUint8Array.slice(0, nacl.box.nonceLength);\r\nconst encryptedMessage = messageWithNonceUint8Array.slice(\r\n  nacl.box.nonceLength,\r\n  messageWithNonce.length\r\n);\r\n\r\nconst messageTextUint8Array = nacl.box.open(\r\n  encryptedMessage,\r\n  nonce,\r\n  messageObject.receiver_public_key_base64 != publicKeyBase64\r\n    ? new Uint8Array(\r\n        new Buffer(messageObject.receiver_public_key_base64, \"base64\")\r\n      )\r\n    : new Uint8Array(\r\n        new Buffer(messageObject.sender_public_key_base64, \"base64\")\r\n      ),\r\n  new Uint8Array(new Buffer(props.secretKeyBase64, \"base64\"))\r\n);\r\n\r\n// const messageTextUint8Array = nacl.box.open(\r\n//   encryptedMessage,\r\n//   nonce,\r\n//   messageObject.receiver_public_key_base64 == publicKeyBase64\r\n//     ? new Uint8Array(\r\n//         new Buffer(messageObject.sender_public_key_base64, \"base64\")\r\n//       )\r\n//     : publicKey,\r\n//   new Uint8Array(new Buffer(props.secretKeyBase64, \"base64\"))\r\n// );\r\n\r\nconst messageText = messageTextUint8Array\r\n  ? Buffer.from(messageTextUint8Array).toString()\r\n  : null;\r\n\r\nreturn (\r\n  <div className=\"card my-2 border-primary\">\r\n    <div className=\"card-header\">\r\n      <small class=\"text-muted\">\r\n        <div class=\"row justify-content-between\">\r\n          <div class=\"col-4\">\r\n            <Widget\r\n              src={`mob.near/widget/ProfileLine`}\r\n              props={{ accountId: props.senderAccountId }}\r\n            />\r\n          </div>\r\n          <div class=\"col-4\">\r\n            <div class=\"d-flex justify-content-end\">\r\n              <Widget\r\n                src={`mob.near/widget/TimeAgo`}\r\n                props={{ blockHeight: props.blockHeight }}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </small>\r\n    </div>\r\n    <div className=\"card-body\">\r\n      {messageText || \"\u26a0\ufe0f error reading message with your private key\"}\r\n    </div>\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bozon.near/widget/PrivateMailBox.Message"}