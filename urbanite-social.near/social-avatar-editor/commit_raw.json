{"tx_hash": "BBcCAWkaz7TwAQreKM6uR9P15VTNcNpwW2vucyaHUDWf", "action_id_social": "AQBaEjRzj7m6PTUDjk9jZPGNS3S3YphSa2iJnji6d6bg-0-widget", "block_id": 89372738, "block_timestamp": "2023-04-12 00:28:40.689", "signer_id": "urbanite-social.near", "widget_name": "social-avatar-editor", "source_code": "let appName = \"avtr\";\nlet ownerId = \"zavodil.near\";\nlet userId = context.accountId;\nlet contractId = \"avtr.near\";\n\nconst MIN_DEPOSIT = \"300000000000000000000000\";\n\nif (!userId) {\n  return \"Please login to generate a Social Avatar\";\n}\n\nlet randomInteger = (max) => {\n  return Math.floor(Math.random() * max);\n};\n\nlet setRandomColors = (\n  paths,\n  collection,\n  color_category,\n  used_colors,\n  options\n) => {\n  collection.forEach((color) => {\n    while (true) {\n      let _color = Object.keys(paths.colors_categories[color_category] ?? {})[\n        randomInteger(\n          Object.keys(paths.colors_categories[color_category] ?? {}).length\n        )\n      ];\n      if (_color && !used_colors.includes(_color)) {\n        options[color] = _color;\n        used_colors.push(_color);\n        break;\n      }\n    }\n  });\n  return { used_colors, options };\n};\n\nconst RandomAvatar = (paths) => {\n  let palette_colors = [\n    \"svgBackground\",\n    \"background\",\n    \"clothingColor\",\n    \"clothingGraphicsColor\",\n    \"heather\",\n    \"accessoriesColor\",\n    \"hatColor\",\n  ];\n  let hair_colors = [\"hairColor\", \"facialHairColor\"];\n  let skin_colors = [\"skin\"];\n  let components = [\n    \"clothing\",\n    \"skin\",\n    \"top\",\n    \"accessories\",\n    \"clothingGraphic\",\n    \"eyes\",\n    \"eyebrows\",\n    \"mouth\",\n    \"facialHair\",\n  ];\n\n  let data = {\n    options: {},\n    used_colors: [],\n  };\n\n  components.forEach((component) => {\n    data.options[component] = Object.keys(paths.components[component])[\n      randomInteger(Object.keys(paths.components[component]).length)\n    ];\n  });\n\n  data = setRandomColors(\n    paths,\n    palette_colors,\n    \"palette\",\n    data.used_colors,\n    data.options\n  );\n  data = setRandomColors(\n    paths,\n    hair_colors,\n    \"hair\",\n    data.used_colors,\n    data.options\n  );\n  data = setRandomColors(\n    paths,\n    skin_colors,\n    \"skin\",\n    data.used_colors,\n    data.options\n  );\n\n  console.log(\"random\", data.options);\n\n  return data.options;\n};\n\nconst defaultState = {\n  options: {},\n  avatarLoaded: false,\n  paths: null,\n};\n\ninitState(defaultState);\n\nif (!state.paths) {\n  const paths = Social.get(`*/${appName}/**`, \"final\");\n\n  if (paths) {\n    State.update({\n      paths,\n      options: RandomAvatar(paths[ownerId][appName]),\n    });\n  }\n\n  return \"Loading\";\n}\n\nconst whiteList = Object.keys(state.paths[ownerId][appName][\"whitelist\"]);\n\nlet paths = state.paths[ownerId][appName];\n\nwhiteList.forEach((accountId) => {\n  Object.keys(state.paths[accountId][appName].components ?? {}).forEach(\n    (type) => {\n      Object.entries(state.paths[accountId][appName].components[type]).forEach(\n        (item) => {\n          if (item[1].price > 0) {\n            item[1].account_id = accountId;\n          }\n          paths.components[type][item[0]] = item[1];\n        }\n      );\n    }\n  );\n});\n\nlet categories = [\n  \"clothing\",\n  \"accessories\",\n  \"top\",\n  \"clothingGraphic\",\n  \"eyes\",\n  \"eyebrows\",\n  \"mouth\",\n  \"facialHair\",\n];\n\nconst colors = paths.colors;\nconst colorsCategories = paths.colors_categories;\nconst components = paths.components;\nlet getPrice = (options) => {\n  return categories.reduce(\n    (sum, category) =>\n      new Big(sum)\n        .plus(components[category][options[category]].price ?? 0)\n        .toString(),\n    \"0\"\n  );\n};\n\nlet getPaidComponents = (options) => {\n  return categories\n    .filter((category) =>\n      new Big(components[category][options[category]].price).gt(0)\n    )\n    .map((category) => components[category][options[category]]);\n};\n\nconst YoctoToNear = (amountYocto) =>\n  new Big(amountYocto).div(new Big(10).pow(24)).toString();\n\nlet depositYocto = getPrice(state.options);\nlet depositNear = YoctoToNear(depositYocto);\n\nlet paidComponents = getPaidComponents(state.options);\n\nlet nextItem = (collection, name) => {\n  let keys = Object.keys(collection);\n  for (let index = 0; index < keys.length; index++) {\n    let item = keys[index];\n\n    if (item == state.options[name]) {\n      state.options[name] = keys[index == keys.length - 1 ? 0 : index + 1];\n      State.update({\n        options: state.options,\n      });\n      break;\n    }\n  }\n};\n\nlet itemsMenu = (collection, name) => {\n  //console.log(\"itemsMenu\", name, collection);\n  let items = Object.keys(collection).map((item) => (\n    <option value={item} selected={state.options[name] == item}>\n      {collection[item].name.charAt(0).toUpperCase() +\n        collection[item].name.slice(1)}\n      {(collection[item].price ?? 0) > 0\n        ? ` [${YoctoToNear(collection[item].price)} NEAR]`\n        : \"\"}\n    </option>\n  ));\n\n  return (\n    <div class=\"input-group mb-3\">\n      <select\n        class=\"form-select\"\n        onChange={(e) => {\n          let options = state.options;\n          if (name == \"clothing\" && e.target.value != \"graphicShirt\") {\n            options[\"clothingGraphic\"] = \"none\";\n          }\n          options[name] = e.target.value;\n          State.update({ options });\n        }}\n      >\n        {items}\n      </select>\n      <button\n        class=\"btn btn-outline-secondary p-2\"\n        type=\"button\"\n        onClick={() => nextItem(collection, name)}\n      >\n        {\">\"}\n      </button>\n    </div>\n  );\n};\n\nlet nextColor = (collection, name) => {\n  let keys = Object.keys(collection);\n  for (let index = 0; index < keys.length; index++) {\n    let item = keys[index];\n\n    let color = colors[item] ?? \"\";\n\n    if (color && item == state.options[name]) {\n      state.options[name] = keys[index == keys.length - 1 ? 0 : index + 1];\n      State.update({\n        options: state.options,\n      });\n      break;\n    }\n  }\n};\n\nlet colorsMenu = (collection, name) => {\n  //console.log(\"colorsMenu\", name, collection);\n  let items = [];\n  Object.keys(collection).forEach((item) => {\n    let color = colors[item] ?? \"\";\n    if (color) {\n      items.push(\n        <option value={item} selected={state.options[name] == item}>\n          {color.name.charAt(0).toUpperCase() + color.name.slice(1)}\n        </option>\n      );\n    }\n  });\n  return (\n    <div class=\"input-group mb-3\">\n      <select\n        class=\"form-select\"\n        onChange={(e) => {\n          state.options[name] = e.target.value;\n          State.update({ options: state.options });\n        }}\n      >\n        {items}\n      </select>\n      <button\n        class=\"btn btn-outline-secondary p-2\"\n        type=\"button\"\n        onClick={() => nextColor(collection, name)}\n      >\n        {\">\"}\n      </button>\n    </div>\n  );\n};\n\nlet Mint = () => {\n  const gas = 200000000000000;\n  const deposit = new Big(depositYocto).plus(MIN_DEPOSIT).toFixed(0);\n\n  let data = [];\n  Object.entries(state.options).forEach((item) => {\n    data.push([\n      components[item[0]][item[1]].account_id ?? ownerId,\n      item[0],\n      item[1],\n    ]);\n  });\n\n  Near.call(\n    contractId,\n    \"nft_mint\",\n    {\n      receiver_id: userId,\n      data,\n    },\n    gas,\n    deposit\n  );\n};\n\nconst AvatarDiv = styled.div`\n @media (max-width: 576px) {  \n  min-width: 345px;\n  min-height: 345px;\n  margin-bottom: 1rem;\n}\n`;\n\nreturn (\n  <>\n    <div class=\"container-fluid\">\n      <div class=\"row\">\n        <div class=\"col-md-6 col-s-12 text-center\">\n          <div>\n            <AvatarDiv>\n              <Widget\n                src={`${ownerId}/widget/social-avatar-image`}\n                props={{ paths, options: state.options }}\n              />\n            </AvatarDiv>\n          </div>\n          <div class=\"d-block d-sm-none\">\n            <button\n              class=\"btn btn-outline-primary pt-1 mb-2\"\n              onClick={() =>\n                State.update({\n                  options: RandomAvatar(state.paths[ownerId][appName]),\n                })\n              }\n            >\n              Random\n            </button>\n          </div>\n        </div>\n\n        <div class=\"col-md-6 col-s-12\">\n          <div class=\"text-center\">\n            <h4>Set your Near.Social Avatar</h4>\n          </div>\n\n          <div class=\"container-fluid\">\n            <div class=\"row mt\">\n              <div class=\"col\">\n                <div>Eyes</div>\n                {itemsMenu(components.eyes, \"eyes\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Eyebrows</div>\n                {itemsMenu(components.eyebrows, \"eyebrows\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Mouth</div>\n                {itemsMenu(components.mouth, \"mouth\")}\n              </div>\n            </div>\n\n            <div class=\"row mt-2\">\n              <div class=\"col\">\n                <div>Top</div>\n                {itemsMenu(components.top, \"top\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Top color</div>\n                {colorsMenu(colorsCategories.palette, \"hatColor\")}\n              </div>\n            </div>\n\n            <div class=\"row mt-2\">\n              <div class=\"col\">\n                <div>Hair color</div>\n                {colorsMenu(colorsCategories.hair, \"hairColor\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Skin color</div>\n                {colorsMenu(colorsCategories.skin, \"skin\")}\n              </div>\n            </div>\n\n            <div class=\"row mt-2\">\n              <div class=\"col\">\n                <div>Accessories</div>\n                {itemsMenu(components.accessories, \"accessories\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Accessories color</div>\n                {colorsMenu(colorsCategories.palette, \"accessoriesColor\")}\n              </div>\n            </div>\n\n            <div class=\"row mt-2\">\n              <div class=\"col\">\n                <div>Facial Hair</div>\n                {itemsMenu(components.facialHair, \"facialHair\")}\n              </div>\n\n              <div class=\"col\">\n                <div>Facial Hair color</div>\n                {colorsMenu(colorsCategories.hair, \"facialHairColor\")}\n              </div>\n            </div>\n\n            <div class=\"row mt-2\">\n              <OverlayTrigger\n                placement=\"left\"\n                overlay={\n                  <Tooltip>\n                    Choose \"Graphic Shirt\" for extra graphic options\n                  </Tooltip>\n                }\n              >\n                <div class=\"col\">\n                  <div>Clothing</div>\n                  {itemsMenu(components.clothing, \"clothing\")}\n                </div>\n              </OverlayTrigger>\n\n              <div class=\"col\">\n                <div>Clothing color</div>\n                {colorsMenu(colorsCategories.palette, \"clothingColor\")}\n              </div>\n            </div>\n\n            {state.options.clothing === \"graphicShirt\" && (\n              <div class=\"row mt-2\">\n                <div class=\"col\">\n                  <div>Clothing Graphic</div>\n                  {itemsMenu(components.clothingGraphic, \"clothingGraphic\")}\n                </div>\n\n                <div class=\"col\">\n                  <div>Graphic color</div>\n                  {colorsMenu(\n                    colorsCategories.palette,\n                    \"clothingGraphicsColor\"\n                  )}\n                </div>\n              </div>\n            )}\n\n            <div class=\"row mt-2\">\n              <div class=\"col\">\n                <div>Cirle color</div>\n                {colorsMenu(colorsCategories.palette, \"background\")}\n              </div>\n              <div class=\"col\">\n                <div>Background color</div>\n                {colorsMenu(colorsCategories.palette, \"svgBackground\")}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class=\"container mb-4\">\n      <div class=\"row mt-3\">\n        <div class=\"col text-center\">\n          <div>\n            <button\n              class=\"btn btn-outline-primary\"\n              onClick={() =>\n                State.update({\n                  options: RandomAvatar(state.paths[ownerId][appName]),\n                })\n              }\n            >\n              Random\n            </button>\n            <button onClick={Mint}>Mint an NFT</button>\n          </div>\n          {depositNear > 0 && (\n            <div class=\"pt-2\">\n              Components cost: {depositNear} NEAR. NFT storage: 0.3 NEAR\n            </div>\n          )}\n          {depositNear == \"0\" && (\n            <div class=\"pt-2\">\n              You will be asked to attach 0.3 NEAR for NFT storage\n            </div>\n          )}\n          {paidComponents.length > 0 && (\n            <div>\n              <ul class=\"list-group pt-2\">\n                <h4>Paid components:</h4>\n                {paidComponents.map((component) => (\n                  <li class=\"list-group-item\">\n                    <strong>\n                      {component.name.charAt(0).toUpperCase() +\n                        component.name.slice(1)}\n                    </strong>\n                    {YoctoToNear(component.price)} NEAR\n                    {component.details ? (\n                      <div>{component.details}</div>\n                    ) : (\n                      <span></span>\n                    )}\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n    <div class=\"border border-3 p-3 mb-4\">\n      <Widget src={`${ownerId}/widget/owned-social-avatars`} />\n    </div>\n    <div class=\"row pt-2 pb-5 text-center\">\n      <div class=\"col\">\n        <a\n          href=\"/#/zavodil.near/widget/all-social-avatars\"\n          class=\"btn btn-outline-success\"\n        >\n          All Social Avatars\n        </a>\n      </div>\n    </div>\n  </>\n);\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/urbanite-social.near/widget/social-avatar-editor", "metadata.image.ipfs_cid": NaN, "metadata.name": NaN, "metadata.tags.app": NaN}