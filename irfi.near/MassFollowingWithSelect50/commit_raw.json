{"tx_hash": "F2UiUezZ3ZfaCoXUDwkTdDjQj7X8YrSKuZzYJ4Ev7bDn", "action_id_social": "5k94KBfiyEt8AgZFMFR9yw23KGVJa59T5cFHAXG7FVqw-0-widget", "block_id": 80192001, "block_timestamp": "2022-12-08 14:15:50.794", "signer_id": "irfi.near", "widget_name": "MassFollowingWithSelect50", "source_code": "//MassFollowing\nconst userId = context.accountId;\nconst ownerId = \"zavodil.near\";\n\nif (!userId) {\n  return \"Please sign in with NEAR wallet to follow other accounts\";\n}\n\nconst accounts = Social.keys(`*/graph/follow/*`, \"final\", {\n  return_type: \"BlockHeight\",\n  values_only: true,\n});\n\nif (accounts === null) {\n  return \"Loading\";\n}\n\nconst followingData = Social.keys(`${userId}/graph/follow/*`, \"final\");\nif (followingData === null) {\n  return \"Loading\";\n}\n\nconst following = followingData[userId][\"graph\"][\"follow\"] ?? [];\n\nlet followDev = prop.followDev ?? true;\n\nif (followDev) {\n  following[ownerId] = true;\n}\n\nState.init({\n  following,\n  followDev,\n});\n\nlet followingsAll = [];\nObject.keys(accounts).forEach((accountId) => {\n  Object.keys(accounts[accountId].graph.follow).forEach(\n    (followingAccountId) => {\n      followingsAll[followingAccountId] =\n        (followingsAll[followingAccountId] ?? 0) + 1;\n    }\n  );\n});\n\nlet followingTop = Object.keys(followingsAll).sort(\n  (a, b) => followingsAll[b] - followingsAll[a]\n);\n\nlet handleChange = (accountId) => {\n  let following = state.following;\n  following[accountId] = !following[accountId];\n  State.update({ following });\n};\n\nlet followDevChange = () => {\n  handleChange(ownerId);\n  State.update({ followDev: !state.followDev });\n};\n\nlet followingsBlocks = followingTop.map((accountId) => (\n  <li\n    className={`list-group-item ${\n      state.following[accountId] ? \"list-group-item-success\" : \"\"\n    }`}\n  >\n    <div className=\"form-check\">\n      <input\n        className=\"form-check-input\"\n        type=\"checkbox\"\n        value={accountId}\n        disabled={accountId == userId}\n        id={`follow-${accountId}`}\n        name={`follow-${accountId}`}\n        onChange={() => handleChange(accountId)}\n        checked={state.following[accountId] ?? false}\n      />\n      <label className=\"form-check-label\" for={`follow-${accountId}`}>\n        <Widget\n          src=\"zavodil.near/widget/ProfileLine\"\n          props={{\n            accountId,\n            link: \"\",\n          }}\n        />{\" \"}\n        <span\n          className=\"badge rounded-pill bg-primary\"\n          title={`${followingsAll[accountId]} followers`}\n        >\n          {followingsAll[accountId]}\n        </span>\n        <a\n          className=\"btn btn-sm btn-outline-secondary border-0\"\n          href={`#/mob.near/widget/ProfilePage?accountId=${accountId}`}\n          target=\"_blank\"\n        >\n          <i className=\"bi bi-window-plus me-1\" title=\"Open in new tab\"></i>\n        </a>\n      </label>\n    </div>\n  </li>\n));\n\nlet dataFollow = {};\nObject.keys(state.following).map((accountId) => {\n  if (accountId !== userId) {\n    let follow = !!state.following[accountId];\n    dataFollow[accountId] = follow ? \"\" : null;\n  }\n});\n\nlet dataGraph = [];\nlet dataNotify = [];\n\nObject.keys(state.following).map((accountId) => {\n  if (following[accountId] != state.following[accountId]) {\n    let follow = !!state.following[accountId];\n    dataGraph.push({\n      key: \"follow\",\n      value: {\n        type: follow ? \"follow\" : \"unfollow\",\n        accountId,\n      },\n    });\n\n    dataNotify.push({\n      key: accountId,\n      value: {\n        type: follow ? \"follow\" : \"unfollow\",\n      },\n    });\n  }\n});\n\nconst data = {\n  graph: {\n    follow: dataFollow,\n  },\n  index: {\n    graph: JSON.stringify(dataGraph),\n    notify: JSON.stringify(dataNotify),\n  },\n};\n\nconst selectAll = (total) => {\n  let count = 0;\n  followingTop.forEach((accountId) => {\n    let following = state.following;\n    if (!following[accountId]) {\n      count += 1;\n      if (count <= total) {\n        following[accountId] = !following[accountId];\n        State.update({ following });\n      }\n    }\n  });\n};\n\nreturn (\n  <>\n    <h1>Mass Follow</h1>\n    <p>Follow all the people you like with one click.</p>\n\n    <div className=\"mb-3\">\n      <CommitButton\n        disabled={context.loading}\n        className={`btn ${\n          context.loading ? \"btn-outline-dark\" : \"btn-primary\"\n        }`}\n        data={data}\n      >\n        {context.loading ? \"Loading\" : \"Mass Follow\"}\n      </CommitButton>\n      <button\n        onClick={() => {\n          selectAll(50);\n        }}\n      >\n        Select 50\n      </button>\n    </div>\n    <h4>Users by followers</h4>\n    <ul className=\"list-group\">{followingsBlocks}</ul>\n    <div className=\"form-check pt-3\">\n      <input\n        className=\"form-check-input\"\n        type=\"checkbox\"\n        id={`follow-dev`}\n        onChange={() => followDevChange()}\n        checked={state.followDev}\n        name=\"follow-dev\"\n      />\n      <label className=\"form-check-label\" for=\"follow-dev\">\n        Follow widget author ({ownerId})\n      </label>\n    </div>\n\n    <div className=\"mt-2 mb-3\">\n      <CommitButton\n        disabled={context.loading}\n        className={`btn ${\n          context.loading ? \"btn-outline-dark\" : \"btn-primary\"\n        }`}\n        data={data}\n      >\n        {context.loading ? \"Loading\" : \"Mass Follow\"}\n      </CommitButton>\n    </div>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/irfi.near/widget/MassFollowingWithSelect50"}