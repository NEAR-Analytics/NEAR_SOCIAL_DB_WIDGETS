{"tx_hash": "Hx83ukfeZYhdQicFtAey55imqQBrv1R6TRY3Krh7YVdS", "action_id_social": "ERoWutUSqJkhHUFkTom8FsxJkNpouZTN5jm62BjFkNUc-0-widget", "block_id": 90025006, "block_timestamp": "2023-04-20 14:56:15.860", "signer_id": "rodrigos.near", "widget_name": "WikiOnSocialDB_OneArticle", "source_code": "const addressForArticles = \"wikiTest2Article\";\nconst addressForComments = \"wikiTest2Comment\";\nconst authorForWidget = \"rodrigos.near\";\nconst accountId = props.accountId ?? context.accountId;\nif (!accountId) {\n  return \"No account ID\";\n}\n\nconst lastEditor = props.lastEditor;\nconst blockHeight =\n  props.blockHeight === \"now\" ? \"now\" : parseInt(props.blockHeight);\nconst subscribe = !!props.subscribe;\nconst raw = !!props.raw;\n\nconst notifyAccountId = accountId;\n\nState.init({ showReply: false });\n\nconst article = JSON.parse(\n  Social.get(`${lastEditor}/wikiTest2Article/main`, blockHeight)\n);\nState.update({ article });\n\n// ======= CHECK WHO CAN EDIT ARTICLE\nconst authorsWhiteList = [\"neardigitalcollective.near\"];\nconst doesUserCanEditArticle = () => {\n  const isAccountIdInWhiteList = authorsWhiteList.some(\n    (val) => val === accountId\n  );\n  const isAccountIdEqualsAuthor = accountId === state.article.author;\n  return isAccountIdInWhiteList || isAccountIdEqualsAuthor ? true : false;\n};\n\n// ======= GET DATA TO ATACH COMMENTS TO THE ARTICLE =======\n// we attach all comments to the first initial article (which version = 0)\nconst articlesIndex = Social.index(addressForArticles, \"main\", {\n  order: \"asc\",\n  accountId: state.article.author,\n});\n\nconst resultArticles =\n  articlesIndex &&\n  articlesIndex.reduce((acc, { accountId, blockHeight }) => {\n    const postData = Social.get(\n      `${accountId}/${addressForArticles}/main`,\n      blockHeight\n    );\n    const postDataWithBlockHeight = { ...JSON.parse(postData), blockHeight };\n    return [...acc, postDataWithBlockHeight];\n  }, []);\n\nconst firstArticle =\n  resultArticles &&\n  resultArticles.find(\n    (article) => article.articleId === state.article.articleId\n  );\n\nconst firstArticleBlockHeight = firstArticle.blockHeight;\n\n// ======= Item for comment =======\nconst item = {\n  type: \"social\",\n  path: `${state.article.author}/${addressForArticles}/main`,\n  blockHeight: firstArticleBlockHeight,\n};\n\nconst saveArticle = (args) => {\n  const newArticleData = {\n    ...state.article,\n    body: state.note,\n    lastEditor: accountId,\n    timeLastEdit: Date.now(),\n    version: Number(state.article.version) + 1,\n  };\n\n  const composeArticleData = () => {\n    const data = {\n      [addressForArticles]: {\n        main: JSON.stringify(newArticleData),\n      },\n      index: {\n        [addressForArticles]: JSON.stringify({\n          key: \"main\",\n          value: {\n            type: \"md\",\n          },\n        }),\n      },\n    };\n    return data;\n  };\n  const newData = composeArticleData();\n  Social.set(newData, { force: true });\n};\n\n// ========== article parts ========== //\n\nconst isHeading = (str, headingLevel) => {\n  const headingType = \"\".padStart(headingLevel, \"#\");\n  return (\n    str.substring(0, 1 + headingLevel) === `${headingType} ` ||\n    str.substring(0, 2 + headingLevel) === ` ${headingType} ` ||\n    str.substring(0, 3 + headingLevel) === `  ${headingType} ` ||\n    str.substring(0, 4 + headingLevel) === `   ${headingType} `\n  );\n};\n\nconst articleParts = (lineArray) => {\n  const resultText = [];\n  const resultHeading = [];\n  lineArray.forEach((line) => {\n    if (isHeading(line, 1)) {\n      resultText.push([[]]);\n      resultHeading.push([[line.trim().substring(2)]]);\n    } else if (resultText.length - 1 < 0) {\n      resultText.push([[]]);\n      resultHeading.push([[\"Introduction\"]]);\n    } else if (isHeading(line, 2)) {\n      resultText[resultText.length - 1].push([]);\n      resultHeading[resultHeading.length - 1].push([line.trim().substring(3)]);\n    }\n    const maxIndexDimension1 = resultText.length - 1;\n    const maxIndexDimension2 = resultText[maxIndexDimension1].length - 1;\n    resultText[maxIndexDimension1][maxIndexDimension2].push(line);\n  });\n  return { resultText, resultHeading };\n};\n\nconst { resultText, resultHeading } = articleParts(\n  state.article.body.split(\"\\n\")\n);\n\nconst handleHeaderClick = (index1, index2) => {\n  if ((!state.viewHistory && !state.editArticle) || index2 === 0) {\n    let resp;\n    if (index2 === 0) {\n      resp = resultText[index1].map((item) => item.join(\"\\n\")).join(\"\\n\");\n    } else resp = resultText[index1][index2].join(\"\\n\");\n    State.update({\n      note: resp,\n    });\n  }\n};\n\nreturn (\n  <div className=\"container-fluid border-start border-end\">\n    <Widget\n      src={`${authorForWidget}/widget/WikiOnSocialDB_MainNavigation`}\n      props={{ currentNavPill: \"articles\" }}\n    />\n    <div className=\"row h-100\">\n      <div className=\"col-12 col-md-3 border-end\">\n        <h4\n          className=\"text-center\"\n          style={{ cursor: \"pointer\" }}\n          onClick={() => {\n            console.log(state.article.body);\n            State.update({\n              note: state.article.body,\n            });\n          }}\n        >\n          {state.article.articleId}\n        </h4>\n        <hr />\n        <button\n          className=\"btn btn-outline-dark w-100 mb-2\"\n          onClick={() => {\n            State.update({\n              ...state,\n              editArticle: false,\n              viewHistory: !state.viewHistory,\n            });\n          }}\n        >\n          View History\n        </button>\n        {doesUserCanEditArticle() && (\n          <button\n            className=\"btn btn-outline-dark w-100\"\n            onClick={() => {\n              State.update({\n                ...state,\n                viewHistory: false,\n                editArticle: !state.editArticle,\n                note: state.article.body,\n              });\n            }}\n          >\n            Edit Article\n          </button>\n        )}\n        <hr />\n        <div className=\"accordion accordion-flush\" id=\"accordionFlushExample\">\n          {resultHeading.map((arrItem, index1) => {\n            return (\n              <div className=\"accordion-item shadow-none \">\n                {arrItem.map((item, index2) => {\n                  if (index2 === 0) {\n                    return (\n                      <h5\n                        className=\"accordion-header shadow-none py-1\"\n                        id=\"flush-headingOne\"\n                      >\n                        <button\n                          className=\"accordion collapsed border-0 bg-white text-dark shadow-none\"\n                          type=\"button\"\n                          data-bs-toggle=\"collapse\"\n                          data-bs-target={\"#flush-collapseOne\" + index1}\n                          aria-expanded=\"true\"\n                          aria-controls={\"flush-collapseOne\" + index1}\n                          onClick={() => handleHeaderClick(index1, index2)}\n                        >\n                          {item}\n                        </button>\n                      </h5>\n                    );\n                  }\n                  return (\n                    <div\n                      id={\"flush-collapseOne\" + index1}\n                      className=\"accordion-collapse collapse\"\n                      aria-labelledby={\"flush-collapseOne\" + index1}\n                      data-bs-parent=\"#accordionFlushExample\"\n                    >\n                      <div\n                        style={{ cursor: \"pointer\" }}\n                        className=\"accordion-body py-1\"\n                        onClick={() => handleHeaderClick(index1, index2)}\n                      >\n                        {item}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            );\n          })}\n        </div>\n        <div className=\"mb-3\" />\n        {/* === FOOTER === */}\n        <Widget\n          src={`${authorForWidget}/widget/WikiOnSocialDB_OneArticle.Footer`}\n          props={{\n            author: state.article.author,\n            lastEditor: state.article.lastEditor,\n            timeLastEdit: state.article.timeLastEdit,\n            version: state.article.version,\n          }}\n        />\n      </div>\n      <div className=\"d-md-none mb-3\" />\n      <hr className=\"d-md-none\" />\n      <div className=\"col-12 col-md-9\">\n        <div>\n          {/* === BUTTON - EDIT ARTICLE === */}\n          {state.editArticle && (\n            <>\n              <div className=\"d-flex justify-content-center w-100\">\n                <button\n                  type=\"button\"\n                  className=\"btn btn-outline-success mx-1\"\n                  style={{ minWidth: \"120px\" }}\n                  onClick={() => {\n                    if (!state.note || article.body === state.note) return;\n\n                    const args = {\n                      article_id: state?.articleId,\n                      body: state.note,\n                      navigation_id: null,\n                    };\n\n                    saveArticle(args);\n                  }}\n                >\n                  Save Article{\" \"}\n                </button>\n\n                <button\n                  type=\"button\"\n                  className=\"btn btn-outline-danger mx-1\"\n                  style={{ minWidth: \"120px\" }}\n                  onClick={() => {\n                    State.update({\n                      ...state,\n                      editArticle: false,\n                      note: undefined,\n                    });\n                  }}\n                >\n                  Close\n                </button>\n              </div>\n              <hr />\n            </>\n          )}\n\n          {/* === EDIT ARTICLE === */}\n          {state.editArticle && (\n            <>\n              <div className=\"d-flex gap-2\" style={{ minHeight: \"300px\" }}>\n                <div className=\"w-50\">\n                  <Widget\n                    src=\"mob.near/widget/MarkdownEditorIframe\"\n                    props={{\n                      initialText: state.article.body,\n                      onChange: (note) => State.update({ note }),\n                    }}\n                  />\n                </div>\n                <div className=\"w-50\">\n                  <Widget\n                    src=\"mob.near/widget/SocialMarkdown\"\n                    props={{ text: state.note }}\n                  />\n                </div>\n              </div>\n            </>\n          )}\n          {!state.editArticle && !state.viewHistory && (\n            <Markdown text={state.note || state.article.body} />\n          )}\n          {/* === VIEW HISTORY === */}\n          {state.viewHistory && (\n            <div className=\"mt-3 ps-5\">\n              <div className=\"d-flex justify-content-end\">\n                <button\n                  className=\"btn btn-outline-danger\"\n                  onClick={() => {\n                    State.update({\n                      ...state,\n                      viewHistory: false,\n                    });\n                  }}\n                >\n                  Close\n                </button>\n              </div>\n              <Widget\n                src={`${authorForWidget}/widget/WikiOnSocialDB_History.History`}\n                props={{\n                  articleId: state.article.articleId,\n                  resultArticles,\n                }}\n              />\n            </div>\n          )}\n          {/* === CREATE COMMENT BUTTON === */}\n          {blockHeight !== \"now\" && (\n            <div className=\"mt-1 d-flex justify-content-between\">\n              <Widget\n                src=\"mob.near/widget/CommentButton\"\n                props={{\n                  onClick: () => State.update({ showReply: !state.showReply }),\n                }}\n              />\n            </div>\n          )}\n          {/* === COMPOSE COMMENT === */}\n          <div className=\"mt-3 ps-5\">\n            {state.showReply && (\n              <div className=\"mb-2\">\n                <Widget\n                  src={`${authorForWidget}/widget/WikiOnSocialDB_Comment.Compose`}\n                  props={{\n                    notifyAccountId,\n                    item,\n                    onComment: () => State.update({ showReply: false }),\n                  }}\n                />\n              </div>\n            )}\n            {/* === SHOW COMMENT === */}\n            <Widget\n              src={`${authorForWidget}/widget/WikiOnSocialDB_Comment.Feed`}\n              props={{\n                item,\n                highlightComment: props.highlightComment,\n                limit: props.commentsLimit,\n                subscribe,\n                raw,\n              }}\n            />\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/rodrigos.near/widget/WikiOnSocialDB_OneArticle"}