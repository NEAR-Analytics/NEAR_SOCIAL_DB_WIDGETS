{"tx_hash": "4E7qT9epCxcmCXazsktidNcK3JPREM4dawDpiQeuCBmk", "action_id_social": "2ercnhnKiYz8YDMm5MBvmfv3B8Q5R1uNNSXRg7YnjYgC-0-widget", "block_id": 85473082, "block_timestamp": "2023-02-18 03:14:00.158", "signer_id": "chaotictempest.near", "widget_name": "Search", "source_code": "const SEARCH_API_KEY = \"57ad1944e94432510f067a6e3d13f022\";\nconst APPLICATION_ID = \"B6PI9UKKJT\";\nconst INDEX = \"test_near-social-feed\";\nlet search_params = \"query=\";\nconst api_url = `https://${APPLICATION_ID}-dsn.algolia.net/1/indexes/${INDEX}/query?${search_params}`;\n\nconst writeStateTerm = (term) => {\n  console.log(\"writeStateTerm:\", term);\n\n  State.update({\n    term,\n  });\n};\n\nconst profileWidgets = (content) => {\n  const profiles = [];\n\n  for (const profile of content || []) {\n    const accountId = profile.author;\n    profiles.push(\n      <div className=\"mb-2\">\n        <Widget src=\"mob.near/widget/Profile\" props={{ accountId }} />\n      </div>\n    );\n  }\n\n  return profiles;\n};\n\nconst postWidgets = (content) => {\n  const posts = [];\n\n  for (const post of content || []) {\n    console.log(\"post\", post);\n    const accountId = post.author;\n    if (!post.ref) {\n      console.log(`No ref to post for ${accountId}`);\n    }\n\n    const blockHeight = post.ref.block_height;\n    const link = `#/mob.near/widget/MainPage.Post.Page?accountId=${accountId}&blockHeight=${blockHeight}`;\n    const post_content = {\n      type: \"md\",\n      text: post.content,\n    };\n\n    posts.push(\n      <div className=\"border rounded-4 p-3 pb-1\">\n        <Widget\n          src=\"mob.near/widget/MainPage.Post.Header\"\n          props={{ accountId, blockHeight, link, postType: \"post\" }}\n        />\n        <div className=\"mt-3 text-break\">\n          <Widget\n            src=\"mob.near/widget/MainPage.Post.Content\"\n            props={{ content: post_content }}\n          />\n        </div>\n      </div>\n    );\n  }\n  return posts;\n};\n\nconst commentWidgets = (content) => {\n  const comments = [];\n\n  for (const comment of content || []) {\n    const accountId = comment.author;\n    const blockHeight = comment.ref.block_height;\n    const link = `#/mob.near/widget/MainPage.Comment.Page?accountId=${accountId}&blockHeight=${blockHeight}`;\n    const comment_content = {\n      type: \"md\",\n      text: comment.content,\n    };\n\n    if (!comment.ref) {\n      console.log(`No ref to comment for ${accountId}`);\n    }\n\n    // ${\n    //   highlight ? \"bg-warning bg-opacity-10\" : \"\"\n    // }\n    comments.push(\n      <div className=\"pt-3 border-top pb-2\">\n        <Widget\n          src=\"mob.near/widget/MainPage.Post.Header\"\n          props={{ accountId, blockHeight, link, postType: \"comment\" }}\n        />\n        <div className=\"mt-3 text-break\">\n          <Widget\n            src=\"mob.near/widget/MainPage.Post.Content\"\n            props={{ content: comment_content }}\n          />\n        </div>\n      </div>\n    );\n  }\n  return comments;\n};\n\nconst computeResults = (term) => {\n  console.log(\"computeResults:\", term);\n  const raw_content = fetchAlgoliaData(term);\n  const contents = getCategoryResults(raw_content);\n  console.log(\"contents\", contents[\"comment, post\"]);\n\n  State.update({\n    term,\n    post: postWidgets(contents[\"post\"]),\n    comment: commentWidgets(contents[\"comment, post\"]),\n    profile: profileWidgets(contents[\"profile\"]),\n  });\n};\n\nconst fetchAlgoliaData = (queryURI) => {\n  search_params = `query=${queryURI}`;\n  const res_data = useCache(\n    () =>\n      asyncFetch(api_url, {\n        body: `{ \"params\": \"${search_params}\" }`,\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n          \"X-Algolia-Api-Key\": `${SEARCH_API_KEY}`,\n          \"X-Algolia-Application-Id\": `${APPLICATION_ID}`,\n        },\n        method: \"POST\",\n      }).then((res) => res.body),\n    \"apiResponse1\",\n    { subscribe: true }\n  );\n  return res_data;\n};\n\nconst getCategoryResults = (raw_result_data) => {\n  const results = {};\n  for (const result of raw_result_data.hits) {\n    const {\n      author,\n      content,\n      objectID,\n      categories: categories_raw,\n      ref,\n      _highlightResult,\n    } = result;\n\n    if (categories_raw.length > 1) {\n      categories_raw.sort();\n    }\n\n    const categories = categories_raw.join(\", \");\n    results[categories] = results[categories] || [];\n    results[categories].push({\n      author,\n      content,\n      objectID,\n      categories,\n      ref,\n      _highlightResult,\n    });\n  }\n\n  return results;\n};\n\nreturn (\n  <div>\n    <div>\n      <input\n        type=\"text\"\n        value={state.term ?? \"\"}\n        onChange={(e) => writeStateTerm(e.target.value)}\n        placeholder=\"Search...\"\n      />\n      {state.term && (\n        <div>\n          <button type=\"button\" onClick={() => writeStateTerm(\"\")}>\n            Clear\n          </button>\n          <button type=\"button\" onClick={() => computeResults(state.term)}>\n            Go\n          </button>\n        </div>\n      )}\n    </div>\n\n    {state.term && (\n      <>\n        {state.profile?.length > 0 && (\n          <div>\n            <p>Profiles:</p>\n            <ul>{state.profile}</ul>\n          </div>\n        )}\n\n        {state.post?.length > 0 && (\n          <div>\n            <p>Posts:</p>\n            <ul>{state.post}</ul>\n          </div>\n        )}\n\n        {state.comment?.length > 0 && (\n          <div>\n            <p>Comments:</p>\n            <ul>{state.comment}</ul>\n          </div>\n        )}\n      </>\n    )}\n\n    {state.term && state.apps?.length === 0 && state.people?.length === 0 && (\n      <p>No people or applications match your search.</p>\n    )}\n\n    {props.debug && (\n      <div>\n        <p>Debug Data:</p>\n        <pre>{JSON.stringify(state, undefined, 2)}</pre>\n      </div>\n    )}\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chaotictempest.near/widget/Search"}