{"tx_hash": "Ah76pFZpud8zrBqNsCnnV9xgFS4XKJ4YZxtWf3CkZ9Gb", "action_id_social": "8CShgt45sKUf7vUjampbpceBNEa5o2SPQtfnXhhJdCQB-0-widget", "block_id": 80737388, "block_timestamp": "2022-12-15 23:16:53.792", "signer_id": "chaotictempest.near", "widget_name": "BookSearchPane", "source_code": "initState({\n  text: null,\n  books: null,\n  lastQueried: 0,\n});\n\nconst clearBooks = () => {\n  console.log(\"clearing books\");\n  State.update({\n    books: null,\n    showBooks: false,\n  });\n};\n\nconst updateBooks = (resp) => {\n  const entries = resp.body.items.map((item) => {\n    const info = item.volumeInfo;\n    return {\n      id: info.industryIdentifiers.reduce(\n        (a, v) => ({ ...a, [v.type]: v.identifier }),\n        {}\n      )[\"ISBN_13\"],\n      title: info.title,\n      author: info.authors[0],\n      rating: info.averageRating,\n      pageCount: info.pageCount,\n      desc: info.description,\n      genre: \"Novel\",\n      cover: {\n        url:\n          info.imageLinks.thumbnail ||\n          info.imageLinks.small ||\n          info.imageLinks.medium,\n      },\n    };\n  });\n  // Convert into Map[ISBN => Book]\n  const books = Object.assign(\n    {},\n    ...entries.map((entry) => ({\n      [entry.id]: entry,\n    }))\n  );\n\n  console.log(\"BOOKS\", books);\n  State.update({\n    books,\n    showBooks: true,\n  });\n};\n\nconst update = (text) => {\n  State.update({\n    text,\n  });\n};\n\nconst search = (text) => {\n  if (!text || text.length <= 3) {\n    clearBooks();\n    return;\n  }\n  // NOTE: provided encodeURIComponent not available\n  const encodeURIComponent = (str) => {\n    return str.replace(\" \", \"%20\");\n  };\n  const query = encodeURIComponent(text);\n  const queriedAt = Date.now();\n  const promise = asyncFetch(\n    `https://www.googleapis.com/books/v1/volumes?q=intitle:${query}`\n  );\n\n  promise.then((resp) => {\n    console.log(\"RESP\", resp);\n    if (!resp || !resp.ok) {\n      console.log(`ERR: cannot query for ${text}`);\n      clearBooks();\n      return;\n    }\n\n    // only use resp if we're the latest query.\n    if (queriedAt > state.lastQueried) {\n      State.update({\n        lastQueried: queriedAt,\n      });\n      updateBooks(resp);\n    }\n  });\n};\n\nconst BookRows = styled.p`{\n  display: \"flex\",\u03a9\n  flexDirection: \"column\",\n  alignItems: \"left\",\n  justifyContent: \"space-between\",\n  width: \"100%\",\n  height: \"100%\",\n  padding: \"1rem\",\n}`;\n\nreturn (\n  <div>\n    <input\n      style={{ marginTop: \"1rem\", marginBottom: \"1rem\" }}\n      type=\"text\"\n      className=\"form-control\"\n      value={state.text ?? \"\"}\n      onChange={(e) => {\n        console.log(\"EVENT\", e);\n        const text = e.target.value;\n        update(text);\n        search(text);\n      }}\n      placeholder={props.placeholder ?? `\ud83d\udd0d Search Books`}\n    />\n\n    <BookRows>\n      {state.showBooks &&\n        state.books &&\n        Object.values(state.books).map((book) => (\n          <Widget\n            key={i}\n            src={\"chaotictempest.near/widget/BookTile\"}\n            props={{\n              book,\n              showAddToRead: true,\n              showAddToWantToRead: true,\n            }}\n          />\n        ))}\n    </BookRows>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chaotictempest.near/widget/BookSearchPane"}