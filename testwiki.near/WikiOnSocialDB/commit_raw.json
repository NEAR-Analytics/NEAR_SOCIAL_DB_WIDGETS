{"tx_hash": "63jLAYWoQsDyP2D1NUMRJaDSXHzEL8RnQGTfjW8yGoig", "action_id_social": "Aw1F7Z26buk7Xhk5QotMcN1VsjP96Mztq9CJwSpDEUKR-0-widget", "block_id": 83913410, "block_timestamp": "2023-01-27 13:00:37.511", "signer_id": "testwiki.near", "widget_name": "WikiOnSocialDB", "source_code": "const accountId = props.accountId ?? context.accountId;\nif (!accountId) {\n  return \"No account ID\";\n}\nconst profile = props.profile ?? Social.getr(`${accountId}/profile`);\nif (profile === null) {\n  return \"Loading\";\n}\n\nconst wikiTestData = Social.get(\"*/wikiTest/articles/**\", \"final\");\nconst wikiTestArr = wikiTestData && Object.values(wikiTestData);\nconst resultArticles =\n  wikiTestArr &&\n  wikiTestArr.reduce(\n    (acc, account) => acc.concat(Object.values(account.wikiTest.articles)),\n    []\n  );\n\nresultArticles.length &&\n  resultArticles.sort((a, b) => {\n    return Number(b.timeLastEdit) - Number(a.timeLastEdit);\n  });\n\nconst filteredArticles =\n  resultArticles.length &&\n  resultArticles.reduce((acc, article) => {\n    if (!acc.some(({ articleId }) => articleId === article.articleId)) {\n      return [...acc, article];\n    } else {\n      return acc;\n    }\n  }, []);\n\nState.init({\n  currentTab: \"loadarticles\",\n});\n\nconst description = profile.description;\n\nconst pills = [\n  { id: \"articles\", title: \"Articles\" },\n  { id: \"authors\", title: \"Authors\" },\n  { id: \"create\", title: \"Create Article\" },\n];\n\nconst handleArticle = (e, article) => {\n  State.update({ ...state, article: article, authorId: undefined });\n};\n\nconst handleAuthor = (e, authorId) => {\n  State.update({ ...state, article: undefined, authorId });\n};\n\nconst getDate = (timestamp) => {\n  const date = new Date(Number(timestamp));\n  return date.toDateString();\n};\n\nconst saveArticle = (args) => {\n  const newArticleData = {\n    ...state.article,\n    body: state.note,\n    lastEditor: accountId,\n    timeLastEdit: Date.now(),\n    version: Number(state.article.version) + 1,\n  };\n  Social.set({\n    wikiTest: {\n      articles: { [state.article.articleId]: { ...newArticleData } },\n    },\n  });\n};\n\nconst getDateLastEdit = (timestamp) => {\n  const date = new Date(Number(timestamp));\n  const dateString = `${date.toLocaleDateString()} / ${date.toLocaleTimeString()}`;\n  return dateString;\n};\n\nreturn (\n  <>\n    <ul className=\"nav nav-pills nav-fill mb-4\" id=\"pills-tab\" role=\"tablist\">\n      {pills.map(({ id, title }, i) => (\n        <li className=\"nav-item\" role=\"presentation\" key={i}>\n          <button\n            className={`nav-link ${i === 0 ? \"active\" : \"\"}`}\n            id={`pills-${id}-tab`}\n            data-bs-toggle=\"pill\"\n            data-bs-target={`#pills-${id}`}\n            type=\"button\"\n            role=\"tab\"\n            aria-controls={`pills-${id}`}\n            aria-selected={i === 0}\n            onClick={() => {\n              const key = `load${id}`;\n\n              State.update({\n                ...state,\n                article: undefined,\n                authorId: undefined,\n                note: undefined,\n                editArticle: false,\n                currentTab: key,\n              });\n            }}\n          >\n            {title}\n          </button>\n        </li>\n      ))}\n    </ul>\n    <div className=\"tab-content\" id=\"pills-tabContent\">\n      <div\n        className=\"tab-pane fade show active\"\n        id=\"pills-main\"\n        role=\"tabpanel\"\n        aria-labelledby=\"pills-main-tab\"\n      >\n        {/* === ALL ARTICLES LIST === */}\n        {state.currentTab === \"loadarticles\" && (\n          <div>\n            {!state.article && (\n              <ul>\n                {resultArticles &&\n                  filteredArticles.map((article, index) => (\n                    <li key={article.articleId}>\n                      #{\" \"}\n                      <a href=\"\" onClick={(e) => handleArticle(e, article)}>\n                        {index + 1} {article.articleId}{\" \"}\n                        <small>\n                          (author: {article.author}\n                          {getDateLastEdit(article.timeLastEdit)})\n                        </small>\n                      </a>\n                    </li>\n                  ))}\n              </ul>\n            )}\n            {/* === ONE ARTICLE === */}\n            {state.article && (\n              <div>\n                <h4>Article: {state.article.articleId}</h4>\n                <button\n                  onClick={() => {\n                    State.update({\n                      ...state,\n                      note: undefined,\n                      article: undefined,\n                      editArticle: false,\n                    });\n                  }}\n                >\n                  {\" \"}\n                  Back to articles{\" \"}\n                </button>\n                <button\n                  onClick={() => {\n                    State.update({ ...state, editArticle: true });\n                  }}\n                >\n                  Edit Article{\" \"}\n                </button>\n                {/* === EDIT ARTICLE === */}\n                {state.editArticle && (\n                  <>\n                    <button\n                      type=\"button\"\n                      className=\"btn btn-success\"\n                      onClick={() => {\n                        if (!state.note || article.body === state.note) return;\n\n                        const args = {\n                          article_id: state?.articleId,\n                          body: state.note,\n                          navigation_id: null,\n                        };\n\n                        saveArticle(args);\n                      }}\n                    >\n                      Save Article{\" \"}\n                    </button>\n\n                    <button\n                      type=\"button\"\n                      className=\"btn btn-danger\"\n                      onClick={() => {\n                        State.update({\n                          ...state,\n                          editArticle: false,\n                          note: undefined,\n                        });\n                      }}\n                    >\n                      Cancel{\" \"}\n                    </button>\n\n                    <textarea\n                      id=\"textarea1\"\n                      type=\"text\"\n                      rows={10}\n                      className=\"form-control mt-2\"\n                      value={state.note || state.article.body}\n                      onChange={(e) => {\n                        State.update({ ...state, note: e.target.value });\n                      }}\n                    />\n                  </>\n                )}\n                <Markdown text={state.note || state.article.body} />\n                <div className=\"mt-5 alert alert-secondary\">\n                  <div>\n                    Created by{\" \"}\n                    <a\n                      href={`https://near.social/#/mob.near/widget/ProfilePage?accountId=${state.article.author}`}\n                      style={{ textDecoration: \"underline\" }}\n                    >\n                      {state.article.author}\n                    </a>\n                    <br />\n                    Last edit by{\" \"}\n                    <a\n                      href={`https://near.social/#/mob.near/widget/ProfilePage?accountId=${state.article.lastEditor}`}\n                      style={{ textDecoration: \"underline\" }}\n                    >\n                      {state.article.lastEditor}\n                    </a>\n                    <br />\n                    Edited on {getDate(state.article.timeLastEdit)}\n                    <br />\n                    Edit versions: {state.article.version}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n      {/* === AUTHORS === */}\n      <div\n        className=\"tab-pane fade\"\n        id=\"pills-authors\"\n        role=\"tabpanel\"\n        aria-labelledby=\"pills-authors-tab\"\n      >\n        {state.currentTab === \"loadauthors\" && (\n          <Widget\n            src=\"testwiki.near/widget/WikiOnSocialDB_Authors\"\n            props={{\n              resultArticles,\n            }}\n          />\n        )}\n      </div>\n      {/* === CREATE ARTICLE === */}\n      <div\n        className=\"tab-pane fade\"\n        id=\"pills-create\"\n        role=\"tabpanel\"\n        aria-labelledby=\"pills-create-tab\"\n      >\n        {state.currentTab === \"loadcreate\" && (\n          <Widget\n            src=\"testwiki.near/widget/WikiOnSocialDB_CreateArticle\"\n            props={{\n              author: accountId,\n            }}\n          />\n        )}\n      </div>\n    </div>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/testwiki.near/widget/WikiOnSocialDB"}