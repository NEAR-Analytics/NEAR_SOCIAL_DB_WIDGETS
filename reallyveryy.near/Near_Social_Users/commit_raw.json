{"tx_hash": "BAtCm7wZJCBfArEczH6whnpdeYsTYBWFtG2ikkkmYgyn", "action_id_social": "HofG7MCLnwy4diVaGeHC21c33ra9MHKH6jvY6Td1yTMJ-0-widget", "block_id": 87354875, "block_timestamp": "2023-03-15 13:59:57.043", "signer_id": "reallyveryy.near", "widget_name": "Near_Social_Users", "source_code": "State.init({\r\n  start_date: \"2023-03-10\",\r\n  end_date: \"2023-03-15\",\r\n  current_start_date: \"2023-03-10\",\r\n  current_end_date: \"2023-03-15\",\r\n});\r\n\r\nconst { start_date, end_date, current_start_date, current_end_date } = state;\r\n\r\nlet ageSql = `,\r\n\r\nages as (\r\n\r\nselect\r\n  datediff(day, block_timestamp, current_timestamp) as age_day_num,\r\n  count(distinct tx_signer) as address_count\r\nfrom near.core.fact_transactions t\r\n  where t.tx_receiver in (select tx_signer from de_dupe_resigners {{date_filter}})\r\ngroup by 1\r\norder by 1\r\n)\r\n\r\nselect\r\n  case \r\n  when age_day_num >= 300 then '6. >= 300 days'\r\n  when age_day_num >= 200 then '5. >= 200 days'\r\n  when age_day_num >= 100 then '4. >= 100 days'\r\n  when age_day_num >= 50 then '3. >= 50 days'\r\n  when age_day_num >= 10 then '2. >= 10 days'\r\n  else '1.< 10 days'\r\n  end as age_day,\r\n  sum(address_count) as total_address_count\r\nfrom ages\r\ngroup by 1\r\norder by 1`;\r\n\r\nlet stakeSql = `,\r\n\r\nagg as (\r\nSELECT \r\n  t.tx_signer,\r\n  sum(case\r\n  when CONTAINS(tx:receipt[0]:outcome:logs[0], 'deposited') then REPLACE(REGEXP_SUBSTR(tx:receipt[0]:outcome:logs[0], 'deposited \\\\d+'), 'deposited')::decimal\r\n  else -REPLACE(REGEXP_SUBSTR(tx:receipt[0]:outcome:logs[0], 'unstaking \\\\d+'), 'unstaking')::decimal\r\n  end / 1e24) as total_deposit_amount,\r\n  avg(case\r\n  when CONTAINS(tx:receipt[0]:outcome:logs[0], 'deposited') then REPLACE(REGEXP_SUBSTR(tx:receipt[0]:outcome:logs[0], 'deposited \\\\d+'), 'deposited')::decimal\r\n  else -REPLACE(REGEXP_SUBSTR(tx:receipt[0]:outcome:logs[0], 'unstaking \\\\d+'), 'unstaking')::decimal\r\n  end / 1e24) as avg_deposit_amount,\r\n  count(distinct t.tx_hash) as stake_txs\r\nFROM near.core.fact_actions_events_function_call c\r\nJOIN near.core.fact_transactions t\r\nON c.tx_hash = t.tx_hash\r\nWHERE (method_name = 'deposit_and_stake' or method_name = 'unstake_all')\r\n  AND tx_signer in (select tx_signer from de_dupe_resigners {{date_filter}})\r\n    and tx_status = 'Success'\r\ngroup by 1\r\n)\r\n\r\nselect\r\n  case \r\n  when total_deposit_amount >= 300 then '7. >= 300 NEAR'\r\n  when total_deposit_amount >= 200 then '6. >= 200 NEAR'\r\n  when total_deposit_amount >= 100 then '5. >= 100 NEAR'\r\n  when total_deposit_amount >= 50 then '4. >= 50 NEAR'\r\n  when total_deposit_amount >= 10 then '3. >= 10 NEAR'\r\n  when total_deposit_amount > 0 then '2. >= 0 NEAR'\r\n  else '1. 0 NEAR'\r\n  end as total_deposit_amount,\r\n  count(distinct tx_signer) as total_address_count\r\nfrom agg\r\ngroup by 1\r\norder by 1`;\r\n\r\nlet socialSql = `,\r\n\r\nagg as (\r\nselect \r\nREPLACE(REGEXP_SUBSTR(node_data, '{\"[^\"]*'), '{\"') as action,\r\ncount(*) as tx_count,\r\ncount(distinct signer_id) as address_count,\r\nrank() over (order by tx_count desc) as action_rank\r\n  from near.social.fact_decoded_actions\r\nWHERE signer_id in (select tx_signer from de_dupe_resigners {{date_filter}})\r\ngroup by 1\r\n)\r\n\r\nselect \r\n  iff(action_rank <= 10, action, 'Others') as action,\r\n  sum(tx_count) as tx_count,\r\n  sum(address_count) as total_address_count\r\nfrom agg\r\ngroup by 1\r\norder by 2 desc`;\r\n\r\nlet socialSql2 = `,\r\n\r\nagg as (\r\nselect \r\nREPLACE(REGEXP_SUBSTR(node_data, '{\"[^\"]*'), '{\"') as action,\r\ncount(*) as tx_count,\r\ncount(distinct signer_id) as address_count,\r\nrank() over (order by address_count desc) as action_rank\r\n  from near.social.fact_decoded_actions\r\nWHERE signer_id in (select tx_signer from de_dupe_resigners {{date_filter}})\r\ngroup by 1\r\n)\r\n\r\nselect \r\n  iff(action_rank <= 10, action, 'Others') as action,\r\n  sum(tx_count) as tx_count,\r\n  sum(address_count) as total_address_count\r\nfrom agg\r\ngroup by 1\r\norder by 3 desc`;\r\n\r\nlet chart1Sql = `\r\nselect\r\n  block_timestamp::date as \"Date\",\r\n  count(distinct tx_signer) as \"Unique Authorizers\",\r\n  sum(\"Unique Authorizers\") over (order by \"Date\") as \"Cumulative Unique Authorizers\"\r\nfrom de_dupe_resigners\r\ngroup by 1\r\norder by 1`;\r\n\r\nconst WidgetDiv = styled.div`\r\n  /* Adapt the colors based on primary prop */\r\n  background: ${(props) => (props.primary ? \"palevioletred\" : \"white\")};\r\n  color: ${(props) => (props.primary ? \"white\" : \"palevioletred\")};\r\n\r\n  font-size: 1em;\r\n  margin: 1em;\r\n  padding: 0.25em 1em;\r\n  border: 2px solid palevioletred;\r\n  border-radius: 10px;\r\n  width: 50%;\r\n`;\r\n\r\nconst onStartDateChange = ({ target }) => {\r\n  State.update({\r\n    start_date: target.value,\r\n  });\r\n};\r\n\r\nconst onEndDateChange = ({ target }) => {\r\n  State.update({\r\n    end_date: target.value,\r\n  });\r\n};\r\n\r\nconst onSearch = () => {\r\n  State.update({\r\n    current_start_date: start_date,\r\n    current_end_date: end_date,\r\n  });\r\n};\r\n\r\nreturn (\r\n  <div class=\"min-vh-100 w-100\">\r\n    <div class=\"d-flex flex-row align-items-end justify-content-center mb-5\">\r\n      <div class=\"w-100\">\r\n        <label>Start Date</label>\r\n        <input\r\n          onChange={onStartDateChange}\r\n          class=\"form-control\"\r\n          type=\"date\"\r\n          value={start_date}\r\n        />\r\n      </div>\r\n      <div class=\"w-100 ms-2\">\r\n        <label>End Date</label>\r\n        <input\r\n          onChange={onEndDateChange}\r\n          class=\"form-control\"\r\n          type=\"date\"\r\n          value={end_date}\r\n        />\r\n      </div>\r\n      <button\r\n        class=\"btn btn-success btn-sm d-flex flex-row ms-3 mb-1\"\r\n        onClick={onSearch}\r\n      >\r\n        Search\r\n      </button>\r\n    </div>\r\n    <ul class=\"nav nav-pills mb-3\" id=\"pills-tab\" role=\"tablist\">\r\n      <li class=\"nav-item\" role=\"presentation\">\r\n        <button\r\n          class=\"nav-link active\"\r\n          id=\"pills-home-tab\"\r\n          data-bs-toggle=\"pill\"\r\n          data-bs-target=\"#pills-home\"\r\n          type=\"button\"\r\n          role=\"tab\"\r\n          aria-controls=\"pills-home\"\r\n          aria-selected=\"true\"\r\n        >\r\n          Home\r\n        </button>\r\n      </li>\r\n      <li class=\"nav-item\" role=\"presentation\">\r\n        <button\r\n          class=\"nav-link\"\r\n          id=\"pills-profile-tab\"\r\n          data-bs-toggle=\"pill\"\r\n          data-bs-target=\"#pills-profile\"\r\n          type=\"button\"\r\n          role=\"tab\"\r\n          aria-controls=\"pills-profile\"\r\n          aria-selected=\"false\"\r\n        >\r\n          Age\r\n        </button>\r\n      </li>\r\n      <li class=\"nav-item\" role=\"presentation\">\r\n        <button\r\n          class=\"nav-link\"\r\n          id=\"pills-contact-tab\"\r\n          data-bs-toggle=\"pill\"\r\n          data-bs-target=\"#pills-contact\"\r\n          type=\"button\"\r\n          role=\"tab\"\r\n          aria-controls=\"pills-contact\"\r\n          aria-selected=\"false\"\r\n        >\r\n          Stake Data\r\n        </button>\r\n      </li>\r\n      <li class=\"nav-item\" role=\"presentation\">\r\n        <button\r\n          class=\"nav-link\"\r\n          id=\"pills-contact-tab\"\r\n          data-bs-toggle=\"pill\"\r\n          data-bs-target=\"#pills-social\"\r\n          type=\"button\"\r\n          role=\"tab\"\r\n          aria-controls=\"pills-social\"\r\n          aria-selected=\"false\"\r\n        >\r\n          Near Social\r\n        </button>\r\n      </li>\r\n    </ul>\r\n    <div class=\"tab-content\" id=\"pills-tabContent\">\r\n      <div\r\n        class=\"tab-pane fade show active\"\r\n        id=\"pills-home\"\r\n        role=\"tabpanel\"\r\n        aria-labelledby=\"pills-home-tab\"\r\n      >\r\n        <Widget\r\n          src=\"reallyveryy.near/widget/SocialUsersBarChart\"\r\n          props={{\r\n            appendSql: chart1Sql,\r\n            start_date: current_start_date,\r\n            end_date: current_end_date,\r\n            title: \"Near New Users Over Time\",\r\n            rowValue: \"date\",\r\n            columnValue: \"unique authorizers\",\r\n          }}\r\n        />\r\n      </div>\r\n      <div\r\n        class=\"tab-pane fade\"\r\n        id=\"pills-profile\"\r\n        role=\"tabpanel\"\r\n        aria-labelledby=\"pills-profile-tab\"\r\n      >\r\n        <Widget\r\n          src=\"reallyveryy.near/widget/SocialUsersBarChart\"\r\n          props={{\r\n            appendSql: ageSql,\r\n            start_date: current_start_date,\r\n            end_date: current_end_date,\r\n            title: `Day Ages (${current_start_date} -  ${current_end_date})`,\r\n            rowValue: \"age_day\",\r\n            columnValue: \"total_address_count\",\r\n          }}\r\n        />\r\n      </div>\r\n      <div\r\n        class=\"tab-pane fade\"\r\n        id=\"pills-contact\"\r\n        role=\"tabpanel\"\r\n        aria-labelledby=\"pills-contact-tab\"\r\n      >\r\n        <Widget\r\n          src=\"reallyveryy.near/widget/SocialUsersBarChart\"\r\n          props={{\r\n            appendSql: stakeSql,\r\n            start_date: current_start_date,\r\n            end_date: current_end_date,\r\n            title: `Stake Stats in NEAR (${current_start_date} -  ${current_end_date})`,\r\n            rowValue: \"total_deposit_amount\",\r\n            columnValue: \"total_address_count\",\r\n          }}\r\n        />\r\n      </div>\r\n      <div\r\n        class=\"tab-pane fade\"\r\n        id=\"pills-social\"\r\n        role=\"tabpanel\"\r\n        aria-labelledby=\"pills-social-tab\"\r\n      >\r\n        <Widget\r\n          src=\"reallyveryy.near/widget/SocialUsersBarChart\"\r\n          props={{\r\n            appendSql: socialSql,\r\n            start_date: current_start_date,\r\n            end_date: current_end_date,\r\n            title: `Actions by Tx Count (${current_start_date} -  ${current_end_date})`,\r\n            rowValue: \"action\",\r\n            columnValue: \"tx_count\",\r\n          }}\r\n        />\r\n        <Widget\r\n          src=\"reallyveryy.near/widget/SocialUsersBarChart\"\r\n          props={{\r\n            appendSql: socialSql2,\r\n            start_date: current_start_date,\r\n            end_date: current_end_date,\r\n            title: `Actions by Address Count (${current_start_date} -  ${current_end_date})`,\r\n            rowValue: \"action\",\r\n            columnValue: \"total_address_count\",\r\n          }}\r\n        />\r\n      </div>\r\n    </div>\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/reallyveryy.near/widget/Near_Social_Users"}