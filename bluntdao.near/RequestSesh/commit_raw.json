{"tx_hash": "EpAJcCeZHY8i4ksdzooYRmk6FcnKXLKh83vgB2HFi1wA", "action_id_social": "4a5ewbXVUty7pguutC27WgtUWtAVSzyu7QwAAGVsnXA7-0-widget", "block_id": 79064299, "block_timestamp": "2022-11-23 05:19:10.340", "signer_id": "bluntdao.near", "widget_name": "RequestSesh", "source_code": "const accountId = props.accountId;\nconst questionBlockHeight = props.questionBlockHeight;\n// console.log(\"questionBlockHeight: \", questionBlockHeight);\nconst currentAccountId = context.accountId;\n\nconst profile = Social.getr(`${accountId}/profile`);\n\n// You can use this code to know the blockheights of your question in case you need to test. Just use one blockheight in the props.\n// const testBlockHeights = Social.keys(\n//   `${accountId}/post/poll_question/*`,\n//   \"final\",\n//   {\n//     return_type: \"History\",\n//   }\n// );\n\n// console.log(\"testBlockHeights: \", testBlockHeights);\n\nconst question = Social.get(\n  `${accountId}/post/poll_question/question`,\n  questionBlockHeight\n);\n\n// console.log(\"question: \", question);\n\nconst questionTimestamp = Social.get(\n  `${accountId}/post/poll_question/question_timestamp`, // maybe be wrong\n  questionBlockHeight\n);\n\nconst profileLink = (c) => (\n  <a\n    className=\"text-decoration-none link-dark\"\n    href={`#/mob.near/widget/ProfilePage?accountId=${accountId}`}\n  >\n    {c}\n  </a>\n);\n\nconst answerDataFromBlockHeight = Social.keys(\n  `*/post/answer_poll/${questionBlockHeight}`, // forked from poll, need to display results properly\n  \"final\",\n  {\n    return_type: \"History\",\n  }\n);\n// console.log(\"answerDataFromBlockHeight: \", answerDataFromBlockHeight);\n\nlet answersData = Object.keys(answerDataFromBlockHeight).map((key) => {\n  return {\n    accountId: key,\n    // Social.keys returns in the end a an array of blockHeight related to the query.\n    // In our case, we only care for one answer, so it's always the first one\n    blockHeightOfAnswer:\n      answerDataFromBlockHeight[key].post.answer_poll[questionBlockHeight][0],\n  };\n});\n\n// console.log(\"answData: \", answersData);\n\nconst haveThisUserAlreadyVoted = () => {\n  if (answersData.length == 0) {\n    return false;\n  }\n  for (let i = 0; i < answersData.length; i++) {\n    return answersData[i].accountId == currentAccountId;\n  }\n};\n\nlet countVotes = answersData.reduce(\n  (acc, curr) => {\n    let answer = Social.get(\n      `${curr.accountId}/post/answer_poll/${questionBlockHeight}/user_vote`,\n      curr.blockHeightOfAnswer\n    );\n    return answer == 1 ? [acc[0] + 1, acc[1]] : [acc[0], acc[1] + 1];\n  },\n  [0, 0]\n);\n\nconst loadComments = () => {\n  for (let i = 0; i < answersData.length; i++) {\n    let answer = Social.get(\n      `${answersData.accountId}/post/answer_poll/${answersData[i].blockHeightOfAnswer}/user_answers`\n    );\n\n    console.log(\"answer: \", answer);\n\n    let answerTimeStamp = Social.get(\n      `${answersData.accountId}/post/answer_poll/${answersData[i].blockHeightOfAnswer}/answer_timestamps`\n    );\n\n    console.log(\"answerTimeStamp: \", answerTimeStamp);\n\n    if (answer != undefined) {\n      return (\n        <Widget\n          src=\"bluntdao.near/widget/PickAStick\" // changed this from poll\n          props={{ answer, answerTimeStamp }}\n        />\n      );\n    }\n  }\n};\n\nState.init({ vote: \"\", currentAnswer: \"\" });\n// console.log(\"input vote value: \", state.vote, \"textarea value: \", state.currentAnswer);\n\nconst getForm = () => (\n  <div\n    style={{\n      border: \"1px solid #e9e9e9\",\n      borderRadius: \"20px\",\n      padding: \"1rem\",\n    }}\n  >\n    <h5>Which smoking stick do you pick? \ud83d\uddf3\ufe0f\ud83d\udca8\ud83c\udf43</h5>\n    <p style={{ marginBottom: \"0\" }}>Vote:</p>\n    <div className=\"form-check\">\n      <input\n        key={state.vote}\n        disabled={haveThisUserAlreadyVoted()}\n        className=\"form-check-input\"\n        type=\"radio\"\n        name=\"flexRadioDefault\"\n        id=\"voteBlunt\"\n        value=\"2\"\n        onChange={onValueChange}\n        checked={state.vote == \"2\"}\n      />\n      <label className=\"form-check-label\" for=\"voteBlunt\">\n        Blunt\n      </label>\n    </div>\n    <div className=\"form-check\">\n      <input\n        key={state.vote}\n        disabled={haveThisUserAlreadyVoted()}\n        className=\"form-check-input\"\n        type=\"radio\"\n        name=\"flexRadioDefault\"\n        id=\"voteBlunt\"\n        value=\"1\"\n        onChange={onValueChange}\n        checked={state.vote == \"1\"}\n      />\n      <label className=\"form-check-label\" for=\"voteJoint\">\n        Joint\n      </label>\n    </div>\n    <div className=\"form-check\">\n      <input\n        key={state.vote}\n        disabled={haveThisUserAlreadyVoted()}\n        className=\"form-check-input\"\n        type=\"radio\"\n        name=\"flexRadioDefault\"\n        id=\"voteSpliff\"\n        value=\"0\"\n        onChange={onValueChange}\n        checked={state.vote == \"0\"}\n      />\n      <label className=\"form-check-label\" for=\"voteSpliff\">\n        Spliff\n      </label>\n    </div>\n    {haveThisUserAlreadyVoted() && (\n      <p className=\"text-danger\">You burned \ud83d\udd25 your only answer</p>\n    )}\n\n    <div className=\"form-group\">\n      <label for=\"answer\" className=\"font-weight-bold\">\n        Write answer:\n      </label>\n      <textarea\n        className=\"form-control mb-1\"\n        id=\"answer\"\n        rows=\"3\"\n        value={state.currentAnswer}\n        onChange={(e) => {\n          const currentAnswer = e.target.value;\n          State.update({ currentAnswer });\n        }}\n      ></textarea>\n    </div>\n    <CommitButton\n      data={{\n        post: {\n          answer_poll: {\n            [questionBlockHeight]: {\n              user_vote: state.vote == \"\" ? answer.userVote : state.vote,\n              user_answers: currentAnswer,\n              answer_timestamps: Date.now(),\n            },\n          },\n        },\n      }}\n    >\n      Confirm\n    </CommitButton>\n  </div>\n);\n\nfunction onValueChange(e) {\n  const vote = e.target.value;\n\n  State.update({ vote });\n}\n\nconst timeAgo = (diffSec) =>\n  diffSec < 60000\n    ? `${(diffSec / 1000) | 0} seconds ago`\n    : diffSec < 3600000\n    ? `${(diffSec / 60000) | 0} minutes ago`\n    : diffSec < 86400000\n    ? `${(diffSec / 3600000) | 0} hours ago`\n    : `${(diffSec / 86400000) | 0} days ago`;\n\nreturn (\n  <div style={{ maxWidth: \"40em\" }}>\n    <div\n      className=\"d-flex align-items-start\"\n      style={{\n        padding: \"1.5rem 0\",\n        borderBottom: \"1px solid #e9e9e9\",\n      }}\n    >\n      <div>\n        {profileLink(\n          <Widget src=\"mob.near/widget/ProfileImage\" props={{ accountId }} />\n        )}\n      </div>\n      <div className=\"ms-2 flex-grow-1\" style={{ minWidth: 0 }}>\n        <div className=\"d-flex justify-content-start\">\n          <div className=\"flex-grow-1 me-1 text-truncate\">\n            {profileLink(\n              <>\n                <span className=\"fw-bold\">{profile.name}</span>\n                <span className=\"text-secondary\">@{accountId}</span>\n              </>\n            )}\n          </div>\n          <div>\n            <small className=\"ps-1 text-nowrap text-muted ms-auto\">\n              <i className=\"bi bi-clock me-1\"></i>\n              {timeAgo(Date.now() - questionTimestamp)}\n            </small>\n          </div>\n        </div>\n        <div>{question}</div>\n        <div className=\"d-flex align-items-start\">\n          <i\n            className=\"bi bi-check-circle-fill\"\n            style={{ padding: \"0 0.3rem\" }}\n          ></i>\n          <p className=\"text-secondary\">{countVotes[1]}</p>\n          <i\n            className=\"bi bi-x-octagon-fill\"\n            style={{ padding: \"0 0.5rem 0 1rem\" }}\n          ></i>\n          <p className=\"text-secondary\">{countVotes[0]}</p>\n        </div>\n        <>{loadComments()}</>\n        <>{getForm()}</>\n      </div>\n    </div>\n  </div>\n);\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluntdao.near/widget/RequestSesh", "metadata.description": NaN, "metadata.image.nft.contractId": NaN, "metadata.image.nft.tokenId": NaN, "metadata.linktree.website": NaN, "metadata.name": NaN, "metadata.tags.blunt": NaN, "metadata.tags.blunt-dao": NaN, "metadata.tags.blunts": NaN, "metadata.tags.dao": NaN, "metadata.tags.joint": NaN, "metadata.tags.joints": NaN, "metadata.tags.labels": NaN, "metadata.tags.poll": NaN, "metadata.tags.proof-of-sesh": NaN, "metadata.tags.spliff": NaN, "metadata.tags.spliff-dao": NaN}