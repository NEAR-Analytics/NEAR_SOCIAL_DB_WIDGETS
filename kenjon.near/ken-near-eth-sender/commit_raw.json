{"tx_hash": "5T7Nw55SASqLTZsxFx7U2HjqsHvwTD8rQeRRZ29NcY43", "action_id_social": "2FNR2uMcaxu4uSKJofV5XKPVCFcB3RZm748QjxAHRFim-0-widget", "block_id": 89898170, "block_timestamp": "2023-04-18 22:52:30.974", "signer_id": "kenjon.near", "widget_name": "ken-near-eth-sender", "source_code": "const sender = Ethers.send(\"eth_requestAccounts\", [])[0];\n\nif (!sender) return <Web3Connect connectLabel=\"Connect with Web3\" />;\n\nconst erc20Abi = fetch(\n  \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n);\nif (!erc20Abi.ok) {\n  return \"scam\";\n}\n\nconst iface = new ethers.utils.Interface(erc20Abi.body);\n\ninitState({\n  token: \"\",\n  tokenDecimals: \"\",\n  sendTo: \"\",\n  sender,\n  senderBalance: \"0\",\n  receiverBalance: \"0\",\n  receiver: \"\",\n  amount: \"1\",\n});\n\nconst tokens = {\n  \"Select Token\": \"\",\n  USDT: \"0xdac17f958d2ee523a2206206994597c13d831ec7\",\n  DAI: \"0x6b175474e89094c44da98b954eedeac495271d0f\",\n  USDC: \"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48\",\n  MKR: \"0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2\",\n};\n\nconst tokensMenuItems = Object.keys(tokens).map((token) => (\n  <option value={tokens[token]}>{token}</option>\n));\n\nconst setSendTo = (sendTo) => {\n  const receiver = Ethers.resolveName(sendTo);\n  State.update({ sendTo, receiver: receiver ?? \"\" });\n  refreshBalances();\n};\n\nconst setToken = (token) => {\n  State.update({ token });\n  getTokenDecimals();\n};\n\nconst getTokenBalance = (receiver) => {\n  const encodedData = iface.encodeFunctionData(\"balanceOf\", [receiver]);\n\n  return Ethers.provider()\n    .call({\n      to: state.token,\n      data: encodedData,\n    })\n    .then((rawBalance) => {\n      const receiverBalanceHex = iface.decodeFunctionResult(\n        \"balanceOf\",\n        rawBalance\n      );\n\n      return Big(receiverBalanceHex.toString())\n        .div(Big(10).pow(state.tokenDecimals))\n        .toFixed(2)\n        .replace(/\\d(?=(\\d{3})+\\.)/g, \"$&,\");\n    });\n};\n\nconst getTokenDecimals = () => {\n  const encodedData = iface.encodeFunctionData(\"decimals\", []);\n\n  return Ethers.provider()\n    .call({\n      to: state.token,\n      data: encodedData,\n    })\n    .then((tokenDecimals) => {\n      State.update({ tokenDecimals: parseInt(Number(tokenDecimals)) });\n      refreshBalances();\n    });\n};\n\nconst refreshBalances = () => {\n  getTokenBalance(state.sender).then((value) => {\n    State.update({ senderBalance: value });\n  });\n\n  getTokenBalance(state.receiver).then((value) => {\n    State.update({ receiverBalance: value });\n  });\n};\n\nconst sendTokens = () => {\n  const erc20 = new ethers.Contract(\n    state.token,\n    erc20Abi.body,\n    Ethers.provider().getSigner()\n  );\n\n  let amount = ethers.utils.parseUnits(state.amount, state.tokenDecimals);\n\n  erc20.transfer(state.receiver, amount);\n\n  console.log(\"transactionHash is \" + transactionHash);\n};\n\n/// NEAR STUFF\n\nconst accountId = context.accountId;\n\nconst shrinkToken = (value, decimals) => {\n  return new Big(value || 0).div(new Big(10).pow(decimals || 24));\n};\n\nconst expandToken = (value, decimals) => {\n  return new Big(value).mul(new Big(10).pow(decimals));\n};\n\nconst account = fetch(\"https://rpc.mainnet.near.org\", {\n  method: \"POST\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n  body: JSON.stringify({\n    jsonrpc: \"2.0\",\n    id: \"dontcare\",\n    method: \"query\",\n    params: {\n      request_type: \"view_account\",\n      finality: \"final\",\n      account_id: accountId,\n    },\n  }),\n});\n\nconst getBalance = (token_id, tokenMeta) => {\n  let amount;\n\n  if (!accountId) {\n    return \"0\";\n  }\n\n  if (token_id === \"NEAR\") amount = account.body.result.amount;\n  else {\n    amount = Near.view(token_id, \"ft_balance_of\", {\n      account_id: accountId,\n    });\n  }\n\n  return !amount ? \"0\" : shrinkToken(amount, tokenMeta.decimals).toFixed();\n};\n\nconst REF_TOKEN_META = {\n  decimals: 18,\n  icon: \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='16 24 248 248' style='background: %23000'%3E%3Cpath d='M164,164v52h52Zm-45-45,20.4,20.4,20.6-20.6V81H119Zm0,18.39V216h41V137.19l-20.6,20.6ZM166.5,81H164v33.81l26.16-26.17A40.29,40.29,0,0,0,166.5,81ZM72,153.19V216h43V133.4l-11.6-11.61Zm0-18.38,31.4-31.4L115,115V81H72ZM207,121.5h0a40.29,40.29,0,0,0-7.64-23.66L164,133.19V162h2.5A40.5,40.5,0,0,0,207,121.5Z' fill='%23fff'/%3E%3Cpath d='M189 72l27 27V72h-27z' fill='%2300c08b'/%3E%3C/svg%3E%0A\",\n  id: \"token.v2.ref-finance.near\",\n  name: \"Ref Finance Token\",\n  symbol: \"REF\",\n};\n\nconst NEAR_META = {\n  decimals: 24,\n  icon: \"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTcuNSIgZmlsbD0id2hpdGUiIHN0cm9rZT0iYmxhY2siLz4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTcuNSIgZmlsbD0id2hpdGUiIHN0cm9rZT0iYmxhY2siLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMC42MDc4IDEyLjUwMjlWMjMuNjE5M0wxNi4yOTIgMTkuMzcyMUwxNi44NjA0IDE5Ljg3MDZMMTIuMDkzOCAyNi41ODQ0QzEwLjMyMjggMjguMjA5MiA3LjE5NzI3IDI3LjEwOTkgNy4xOTcyNyAyNC44NjIyVjExLjEzNzFDNy4xOTcyNyA4LjgxMjI4IDEwLjUwNTggNy43NTMzNCAxMi4yMTMzIDkuNTMxNkwyNS4zODY3IDIzLjI1MDRWMTIuNTkwMkwyMC4yNzEgMTYuMzgxMkwxOS43MDI1IDE1Ljg4MjdMMjMuNzU2NyA5LjYxNTZDMjUuNDQ4OSA3LjgwNDQyIDI4Ljc5NzMgOC44NTM3NiAyOC43OTczIDExLjE5NTNWMjQuNjE2M0MyOC43OTczIDI2Ljk0MTEgMjUuNDg4OCAyOCAyMy43ODEyIDI2LjIyMThMMTAuNjA3OCAxMi41MDI5WiIgZmlsbD0iIzBGMUQyNyIvPgo8L3N2Zz4K\",\n  id: \"NEAR\",\n  name: \"NEAR\",\n  symbol: \"NEAR\",\n};\n\nconst ExchangeIcon = (\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"14\"\n    height=\"14\"\n    viewBox=\"0 0 14 14\"\n    fill=\"none\"\n    style={{\n      cursor: \"pointer\",\n    }}\n    onClick={() => {\n      State.update({\n        tokenIn: state.tokenOut,\n        tokenOut: state.tokenIn,\n      });\n    }}\n  >\n    <path\n      opacity=\"0.5\"\n      fill-rule=\"evenodd\"\n      clip-rule=\"evenodd\"\n      d=\"M8.25977 12.9751C8.25977 13.5274 8.70748 13.9751 9.25977 13.9751C9.81205 13.9751 10.2598 13.5274 10.2598 12.9751L10.2598 3.3924L12.2975 5.40399C12.6905 5.79199 13.3237 5.7879 13.7117 5.39487C14.0997 5.00183 14.0956 4.36868 13.7025 3.98068L9.9623 0.288376C9.6753 0.00505281 9.2462 -0.0781458 8.87411 0.077387C8.50202 0.232919 8.25977 0.596739 8.25977 1.00003L8.25977 12.9751ZM5.27273 1.02496C5.27273 0.472672 4.82501 0.0249573 4.27273 0.0249573C3.72044 0.0249573 3.27273 0.472672 3.27273 1.02496V10.6077L1.70253 9.0576C1.30949 8.6696 0.676343 8.67369 0.288346 9.06672C-0.0996505 9.45976 -0.0955657 10.0929 0.29747 10.4809L3.5702 13.7117C3.8572 13.995 4.2863 14.0782 4.65839 13.9227C5.03048 13.7671 5.27273 13.4033 5.27273 13V1.02496Z\"\n      fill=\"#91A2AE\"\n    />\n  </svg>\n);\n\nconst ExchangeWrapper = styled.div`\n  display:flex;\n  align-items:center;\n  justify-content:center;\n  margin-bottom: 16px;\n  \n`;\n\nconst Exchange = <ExchangeWrapper>{ExchangeIcon}</ExchangeWrapper>;\n\nState.init({\n  tokenIn: NEAR_META,\n  tokenOut: REF_TOKEN_META,\n  amountIn: \"1\",\n  amountOut: \"\",\n  showSetting: false,\n  slippagetolerance: \"0.5\",\n  estimate: {},\n  timerIntervalSet: false,\n  reloadPools: false,\n  loadRes: (value) =>\n    State.update({\n      estimate: value,\n      amountOut: value === null ? \"\" : value.estimate,\n    }),\n});\n\nif (!Storage.get(\"count\")) {\n  Storage.set(\"count\", 21);\n}\n\nlet timerInterval;\n\nif (!state.timerIntervalSet) {\n  State.update({\n    timerIntervalSet: true,\n  });\n  timerInterval = setTimeout(() => {\n    const count = Storage.get(\"count\");\n\n    if (count === 1) {\n      State.update({\n        reloadPools: true,\n      });\n    }\n    Storage.set(\"count\", count === 1 ? 21 : count - 1);\n\n    State.update({\n      timerIntervalSet: false,\n    });\n\n    clearTimeout(timerInterval);\n  }, 1000);\n}\n\nconst Container = styled.div`\n    width: 430px;\n    color: white;\n`;\n\nconst Refresh = styled.span`\n  margin-left:8px;\n  font-size:12px\n`;\n\nconst RefreshText = styled.span`\n  margin-left:4px;\n  font-size: 12px;\n  color: #7E8A93;\n`;\n\nconst RateLine = styled.div`\n  display: flex;\n  align-items:center;\n  justify-content: space-between;\n`;\n\nconst RefreshWrapper = styled.div`\n  display: flex;\n  align-items:center;\n  cursor: pointer\n`;\n\nconst RateWrapper = styled.div`\n  display: flex;\n  align-items:center;\n  font-size: 12px;\n  color: #7E8A93\n`;\n\nconst notEnough = new Big(state.amountIn || 0).gt(\n  getBalance(state.tokenIn.id, state.tokenIn)\n);\n\nconst canSwap =\n  Number(state.amountIn || 0) > 0 &&\n  Number(state.amountOut || 0) > 0 &&\n  !state.loading;\n\nconst register = Near.view(\n  state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\n  \"storage_balance_of\",\n  {\n    account_id: accountId,\n  }\n);\n\nconst callTx = () => {\n  const tx = [];\n\n  const nearDeposit = {\n    contractName: \"wrap.near\",\n    methodName: \"near_deposit\",\n    deposit: expandToken(state.amountIn, 24).toFixed(),\n    gas: expandToken(50, 12),\n  };\n  const nearWithdraw = {\n    contractName: \"wrap.near\",\n    methodName: \"near_withdraw\",\n    deposit: new Big(\"1\").toFixed(),\n    args: {\n      amount: expandToken(state.amountIn, 24).toFixed(),\n    },\n  };\n\n  if (state.estimate.pool === \"wrap\") {\n    if (state.tokenIn.id === \"NEAR\") {\n      tx.push(nearDeposit);\n    } else {\n      tx.push(nearWithdraw);\n    }\n\n    return Near.call(tx);\n  }\n\n  if (register === null) {\n    tx.push({\n      contractName:\n        state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\n      methodName: \"storage_deposit\",\n      deposit: expandToken(0.1, 24).toFixed(),\n      gas: expandToken(50, 12),\n      args: {\n        registration_only: true,\n        account_id: accountId,\n      },\n    });\n  }\n\n  if (state.tokenIn.id === \"NEAR\") {\n    tx.push(nearDeposit);\n  }\n\n  const minAmountOut = expandToken(\n    new Big(state.amountOut)\n      .mul(1 - Number(state.slippagetolerance) / 100)\n      .toFixed(state.tokenOut.decimals, 0),\n    state.tokenOut.decimals\n  ).toFixed();\n\n  tx.push({\n    methodName: \"ft_transfer_call\",\n    contractName: state.tokenIn.id === \"NEAR\" ? \"wrap.near\" : state.tokenIn.id,\n    gas: expandToken(180, 12),\n    deposit: new Big(\"1\").toFixed(),\n    args: {\n      receiver_id: \"v2.ref-finance.near\",\n      amount: expandToken(state.amountIn, state.tokenIn.decimals).toFixed(0, 0),\n      msg: JSON.stringify({\n        actions: [\n          {\n            pool_id: Number(state.estimate.pool.id),\n            token_in:\n              state.tokenIn.id === \"NEAR\" ? \"wrap.near\" : state.tokenIn.id,\n            token_out:\n              state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\n            amount_in: expandToken(\n              state.amountIn,\n              state.tokenIn.decimals\n            ).toFixed(0, 0),\n            min_amount_out: minAmountOut,\n          },\n        ],\n      }),\n    },\n  });\n\n  if (state.tokenOut.id === \"NEAR\") {\n    tx.push({\n      contractName: \"wrap.near\",\n      methodName: \"near_withdraw\",\n      deposit: new Big(\"1\").toFixed(),\n      args: {\n        amount: minAmountOut,\n      },\n    });\n  }\n\n  Near.call(tx);\n};\n\nreturn (\n  <>\n    <h3>Send ERC-20 tokens</h3>\n    <div class=\"mb-3\">\n      <label for=\"selectToken\">Select token</label>\n      <select\n        class=\"form-select\"\n        id=\"selectToken\"\n        onChange={(e) => {\n          setToken(e.target.value);\n        }}\n      >\n        {tokensMenuItems}\n      </select>\n    </div>\n\n    <div class=\"mb-3\">\n      <label for=\"send-to\" class=\"form-label\">\n        Recepient address\n      </label>\n      <input\n        value={state.sendTo}\n        class=\"form-control\"\n        id=\"send-to\"\n        placeholder=\"vitalik.eth\"\n        onChange={(e) => setSendTo(e.target.value)}\n      />\n      {state.receiver && (\n        <div class=\"text-secondary mt-3\">Resolved to {state.receiver}</div>\n      )}\n      {state.receiverBalance != \"0\" && (\n        <div class=\"text-secondary mt-3\">\n          Receiver's balance: {state.receiverBalance}\n        </div>\n      )}\n\n      {state.senderBalance != \"0\" && (\n        <div class=\"text-secondary mt-3\">\n          Sender's balance: {state.senderBalance}\n        </div>\n      )}\n    </div>\n\n    <div class=\"mb-3\">\n      <label for=\"amount\" class=\"form-label\">\n        Enter the amount\n      </label>\n      <input\n        value={state.amount}\n        class=\"form-control\"\n        id=\"amount\"\n        placeholder=\"\"\n        onChange={(e) => State.update({ amount: e.target.value })}\n      />\n    </div>\n    <div class=\"mb-3\">\n      <button onClick={sendTokens}>Send</button>\n    </div>\n    <Container>\n      <div\n        style={{\n          fontSize: \"20px\",\n          fontWeight: \"700\",\n        }}\n      >\n        Swap\n      </div>\n      {\n        <Widget\n          src=\"weige.near/widget/ref-swap-getEstimate\"\n          props={{\n            loadRes: state.loadRes,\n            tokenIn: state.tokenIn,\n            tokenOut: state.tokenOut,\n            amountIn: state.amountIn || 0,\n            reloadPools: state.reloadPools,\n            setReloadPools: (value) =>\n              State.update({\n                reloadPools: value,\n              }),\n          }}\n        />\n      }\n\n      {\n        <Widget\n          src={`weige.near/widget/ref-token-input`}\n          props={{\n            amount: state.amountIn,\n            disableInput: false,\n            setAmount: (value) => State.update({ amountIn: value }),\n            token: state.tokenIn,\n            handleSelect: (metadata) =>\n              State.update({\n                tokenIn: metadata,\n              }),\n          }}\n        />\n      }\n      {Exchange}\n      {\n        <Widget\n          src={`weige.near/widget/ref-token-input`}\n          props={{\n            amount: state.amountOut,\n            disableInput: true,\n            setAmount: (value) => State.update({ amountOut: value }),\n            token: state.tokenOut,\n            handleSelect: (metadata) =>\n              State.update({\n                tokenOut: metadata,\n              }),\n          }}\n        />\n      }\n\n      <RateLine>\n        <RefreshWrapper\n          onClick={() => {\n            clearTimeout(timerInterval);\n            State.update({\n              reloadPools: true,\n            });\n            Storage.set(\"count\", 21);\n          }}\n        >\n          <Refresh>{Storage.get(\"count\") - 1}</Refresh>\n          <RefreshText>Refresh</RefreshText>\n        </RefreshWrapper>\n\n        <RateWrapper>{`1 ${state.tokenIn.symbol} \u2248 ${\n          Number(state.amountIn) === 0\n            ? \"-\"\n            : new Big(state.amountOut || 0)\n                .div(state.amountIn || 1)\n                .toFixed(4, 0)\n        } ${state.tokenOut.symbol}`}</RateWrapper>\n      </RateLine>\n      <Widget\n        src={`weige.near/widget/SlippageTolerance`}\n        props={{\n          showSetting: state.showSetting,\n          updateSetting: () =>\n            State.update({\n              showSetting: !state.showSetting,\n            }),\n          slippagetolerance: state.slippagetolerance,\n          setSlippagetolerance: (value) => {\n            State.update({\n              slippagetolerance: value,\n            });\n          },\n        }}\n      />\n\n      <Widget\n        src=\"weige.near/widget/ref-swap-button\"\n        props={{\n          accountId,\n          notEnough,\n          canSwap,\n          callTx,\n          requestSignIn: props.requestSignIn,\n          noPool: state.estimate?.sig === \"no_pool\",\n        }}\n      />\n    </Container>\n  </>\n);\n", "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/kenjon.near/widget/ken-near-eth-sender", "metadata.tags.ethdenver2023": ""}