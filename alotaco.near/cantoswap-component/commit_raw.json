{"tx_hash": "Ds7vtGnAHh2RtFjHvrqXhSXfyDS9W8MjdFM7mspVQGL7", "action_id_social": "3aeA5kfRuLLcrpG6VpYVcvvAjUq9eBgsMCtxH6eHnM8g-0-widget", "block_id": 87357662, "block_timestamp": "2023-03-15 14:53:07.266", "signer_id": "alotaco.near", "widget_name": "cantoswap-component", "source_code": "const fontUrl = `https://ipfs.io/ipfs/bafkreicrs3gh7f77yhpw4xiejx35cd56jcczuhvqbwkn77g2ztkrjejopa`;\n\nconst css = `\n@font-face {\n    font-family: \"Pixter\";\n    src: url(\"${fontUrl}\");\n}\n\nimg {\n  height: 50px;\n  margin-bottom: 16px;\n}\n`;\n\nif (!state.theme) {\n  State.update({\n    theme: styled.div`\n    font-family: Pixter;\n    background: black;\n    color: white;\n    padding: 32px;\n    ${css}\n`,\n  });\n}\nconst Theme = state.theme;\n\nconst sender = Ethers.send(\"eth_requestAccounts\", [])[0];\nif (!sender)\n  return (\n    <div>\n      <h2>Connect Your Wallet</h2>\n      <p>This app requires you to connect to the Canto Mainnet</p>\n    </div>\n  );\n\nconst PROPS = Object.assign(\n  {\n    contractName: \"cantoswap.fi\",\n    contractImg:\n      \"https://www.cantoswap.fi/static/media/cantoswap_logo.07d38228.png\",\n    contractAddress: \"0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F\",\n    abiUrl:\n      \"https://raw.githubusercontent.com/cloudmex/sushiswap-bos/main/abi-sushi.json\",\n    tokens: {\n      WETH: \"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\n      USDT: \"0xdAC17F958D2ee523a2206206994597C13D831ec7\",\n    },\n    decimals: {\n      \"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\": 18,\n      \"0xdAC17F958D2ee523a2206206994597C13D831ec7\": 6,\n    },\n  },\n  props\n);\n\nconst MAX_AMOUNT =\n  \"0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff\";\n\n// TODO timeout helper to revert log to empty string\n// const resetLog = (dur) => {\n//   setTimeout(() => {\n//     State.update({\n//       log: \"\",\n//     });\n//   }, dur);\n// };\n\nconst formatBig = (big, decimals, sig) => {\n  if (!sig) sig = 2;\n  const ret = Big(big.toString())\n    .div(Big(10).pow(decimals))\n    .toFixed(sig)\n    .replace(/\\d(?=(\\d{3})+\\.)/g, \"$&,\");\n  if (ret.length > 16) {\n    return \"MAX AMOUNT\";\n  }\n  return ret;\n};\n\n// TODO why undefined?\n// const temp = Ethers.send(\"eth_getBalance\", [sender]);\n// console.log(\"temp\", temp);\n// console.log(\"sender\", sender);\n// const cantoBalance = parseInt(Ethers.send(\"eth_getBalance\", [sender]), 16);\n// console.log(cantoBalance);\n\ninitState({\n  log: \"\",\n  explorerLink: \"\",\n  tokenFrom: \"\",\n  showApprove: false,\n  allowanceFrom: \"0.00\",\n  tokenTo: \"\",\n  tokenFromBalance: \"0.00\",\n  tokenToBalance: \"0.00\",\n  cantoBalance,\n  amount: \"1\",\n});\n\nconst erc20Abi = fetch(\n  \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n);\nif (!erc20Abi.ok) {\n  return \"scam\";\n}\n\nconst swapRouterAbi = fetch(PROPS.abiUrl);\n\nconst ifaceToken = new ethers.utils.Interface(erc20Abi.body);\nconst ifaceSwap = new ethers.utils.Interface(swapRouterAbi.body);\n\nconst tokens = {\n  \"Select Token\": \"\",\n  ...PROPS.tokens,\n};\n\nconst decimals = PROPS.decimals;\n\nconst tokensMenuItems = Object.keys(tokens).map((token) => (\n  <option key={token} value={tokens[token]}>\n    {token}\n  </option>\n));\n\nconst handleTxError = (e) => {\n  if (e.reason === \"user rejected transaction\") {\n    State.update({\n      log: \"You rejected the TX\",\n    });\n  } else if (/unknown request|transferFrom failed/gi.test(JSON.stringify(e))) {\n    State.update({\n      log: \"Token not approved!\",\n    });\n  } else {\n    State.update({\n      log: \"There was an error: \" + JSON.stringify(e),\n    });\n  }\n};\n\nconst setToken = (token, key) => {\n  State.update({ [key]: token });\n  getTokenBalance(sender, token).then((value) => {\n    State.update({\n      [key + \"Balance\"]: value,\n    });\n  });\n  if (/from/gi.test(key)) {\n    handleUpdateAmount();\n  }\n};\n\nconst getTokenBalance = (receiver, token) => {\n  const encodedData = ifaceToken.encodeFunctionData(\"balanceOf\", [receiver]);\n\n  return Ethers.provider()\n    .call({\n      to: token,\n      data: encodedData,\n    })\n    .then((rawBalance) => {\n      const balanceHex = ifaceToken.decodeFunctionResult(\n        \"balanceOf\",\n        rawBalance\n      );\n      return formatBig(balanceHex, decimals[token]);\n    });\n};\n\nconst handleUpdateAmount = () => {\n  const encodedData = ifaceToken.encodeFunctionData(\"allowance\", [\n    sender,\n    PROPS.contractAddress,\n  ]);\n\n  console.log(PROPS.contractAddress, state.tokenFrom);\n\n  return Ethers.provider()\n    .call({\n      to: state.tokenFrom,\n      data: encodedData,\n    })\n    .then((rawBalance) => {\n      const balanceHex = ifaceToken.decodeFunctionResult(\n        \"allowance\",\n        rawBalance\n      );\n      const allowanceFrom = formatBig(balanceHex, decimals[state.tokenFrom]);\n      State.update({\n        allowanceFrom,\n        showApprove: allowanceFrom === \"0.00\",\n      });\n    });\n};\n\n// Transactions\n\nconst handleApprove = () => {\n  const contract = new ethers.Contract(\n    state.tokenFrom,\n    erc20Abi.body,\n    Ethers.provider().getSigner()\n  );\n\n  contract\n    .approve(PROPS.contractAddress, MAX_AMOUNT)\n    .then((tx) => {\n      State.update({\n        log: \"The TX hash is: \" + tx.hash,\n        explorerLink: \"https://tuber.build/tx/\" + tx.hash,\n      });\n    })\n    .catch(handleTxError);\n};\n\nconst swapTokens = () => {\n  const contract = new ethers.Contract(\n    PROPS.contractAddress,\n    swapRouterAbi.body,\n    Ethers.provider().getSigner()\n  );\n\n  let amountIn = ethers.utils.parseUnits(\n    state.amount,\n    decimals[state.tokenFrom]\n  );\n  const amountOutString = (parseFloat(state.amount) - 0.05).toString();\n  let amountOut = ethers.utils.parseUnits(\n    amountOutString,\n    decimals[state.tokenTo]\n  );\n\n  const tokenFromBig = ethers.utils.parseUnits(\n    state.tokenFromBalance,\n    decimals[state.tokenFrom]\n  );\n\n  if (amountIn.gt(tokenFromBig)) {\n    State.update({\n      log: `You don't have enough!`,\n    });\n    resetLog(2000);\n    return;\n  }\n\n  console.log(\n    amountIn,\n    amountOut,\n    [state.tokenFrom, state.tokenTo],\n    sender,\n    Date.now() + 60 * 1000\n  );\n\n  let routes = [state.tokenFrom, state.tokenTo];\n  if (PROPS.contractAddress === \"0xa252eEE9BDe830Ca4793F054B506587027825a8e\") {\n    routes = [\n      {\n        from: state.tokenFrom,\n        to: state.tokenTo,\n        stable: true,\n      },\n    ];\n  }\n\n  contract\n    .swapExactTokensForTokens(\n      amountIn,\n      amountOut,\n      routes,\n      sender,\n      Date.now() + 60 * 1000\n    )\n    .then((tx) => {\n      State.update({\n        log: \"The TX hash is: \" + tx.hash,\n        explorerLink: \"https://tuber.build/tx/\" + tx.hash,\n      });\n    })\n    .catch(handleTxError);\n};\n\nreturn (\n  <Theme>\n    <img src={PROPS.contractImg} />\n    <p>\n      {PROPS.contractName} -\n      <a\n        href={`https://tuber.build/address/${PROPS.contractAddress}`}\n        target=\"_blank\"\n      >\n        Explorer Link\n      </a>\n    </p>\n    <p>Account: {sender}</p>\n    {state.log.length > 1 && <p>Log: {state.log}</p>}\n    {state.explorerLink.length > 1 && (\n      <a href={state.explorerLink} target=\"_blank\">\n        View Most Recent TX\n      </a>\n    )}\n    <div class=\"mb-3\">\n      <label for=\"selectToken\">From</label>\n      <select\n        class=\"form-select\"\n        id=\"selectToken\"\n        onChange={(e) => {\n          setToken(e.target.value, \"tokenFrom\");\n        }}\n      >\n        {tokensMenuItems}\n      </select>\n      <p>Balance: {state.tokenFromBalance}</p>\n      <p>Allowance: {state.allowanceFrom}</p>\n      {state.showApprove && (\n        <button class=\"btn btn-success\" onClick={handleApprove}>\n          Approve\n        </button>\n      )}\n    </div>\n\n    <div class=\"mb-3\">\n      <label for=\"selectToken\">To {state.tokenToBalance}</label>\n      <select\n        class=\"form-select\"\n        id=\"selectToken\"\n        onChange={(e) => {\n          setToken(e.target.value, \"tokenTo\");\n        }}\n      >\n        {tokensMenuItems}\n      </select>\n    </div>\n\n    <div class=\"mb-3\">\n      <label for=\"amount\" class=\"form-label\">\n        Enter the amount\n      </label>\n      <input\n        value={state.amount}\n        class=\"form-control\"\n        id=\"amount\"\n        placeholder=\"1\"\n        onChange={(e) => {\n          handleUpdateAmount(e.target.value);\n          State.update({ amount: e.target.value });\n        }}\n      />\n    </div>\n\n    <div class=\"mb-3\">\n      <button onClick={swapTokens} class=\"btn btn-success\">\n        Swap\n      </button>\n    </div>\n  </Theme>\n);\n", "metadata": NaN, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/alotaco.near/widget/cantoswap-component", "metadata.tags.ethdenver2023": "", "metadata.tags.canto": NaN, "metadata.tags.canto-test": NaN}