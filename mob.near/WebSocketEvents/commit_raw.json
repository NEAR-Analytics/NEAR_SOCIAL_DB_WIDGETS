{"tx_hash": "9JiyBvkr8AXHF5zWvjMkcZ8FLssQY8rtmaJnGrvN6HD7", "action_id_social": "59uTNrJahmKdtCmgqKqdefZBfmW47qEu3Y28e42HVhMX-0-widget", "block_id": 91620664, "block_timestamp": "2023-05-11T17:00:57.070Z", "signer_id": "mob.near", "widget_name": "WebSocketEvents", "source_code": "if (state.ws === undefined) {\n  const eventsFilter = {\n    status: \"SUCCESS\",\n    event: {\n      event: \"ft_transfer\",\n    },\n  };\n\n  function startWebSocket(processEvents) {\n    let ws = State.get().ws;\n\n    if (ws) {\n      ws.close();\n      return;\n    }\n\n    ws = new WebSocket(\"wss://events.near.stream/ws\");\n\n    ws.onopen = () => {\n      console.log(`Connection to WS has been established`);\n      ws.send(\n        JSON.stringify({\n          secret: \"near-social-events\",\n          filter: eventsFilter,\n          fetch_past_events: 100,\n        })\n      );\n    };\n    ws.onclose = () => {\n      State.update({ ws: null });\n      console.log(`WS Connection has been closed`);\n      State.get().startWebSocket(processEvents);\n    };\n    ws.onmessage = (e) => {\n      const data = JSON.parse(e.data);\n      processEvents(data.events);\n    };\n    ws.onerror = (err) => {\n      State.update({ ws: null });\n      console.log(\"WebSocket error\", err);\n    };\n\n    State.update({ ws });\n  }\n\n  function processEvent(event) {\n    return {\n      time: new Date(parseFloat(event.block_timestamp) / 1e6),\n      event: event.event,\n      accountId: event.account_id,\n      predecessorId: event.predecessor_id,\n    };\n  }\n\n  function processEvents(events) {\n    events = events.flatMap(processEvent);\n    events.reverse();\n\n    State.update((state) => {\n      const prevActions = state.actions || [];\n      state.actions = [\n        ...events.filter(\n          (event) =>\n            prevActions.length === 0 ||\n            event.time.getTime() > prevActions[0].time.getTime()\n        ),\n        ...prevActions,\n      ].slice(0, 10);\n      return state;\n    });\n  }\n\n  State.init({\n    startWebSocket,\n  });\n  state.startWebSocket(processEvents);\n}\n\nreturn state.actions;\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/mob.near/widget/WebSocketEvents", "__row_index": 0}